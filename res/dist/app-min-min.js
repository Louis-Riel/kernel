"use strict";const e=React.createElement;var httpPrefix="",hexcase=0,b64pad="";function hex_sha1(e){return rstr2hex(rstr_sha1(str2rstr_utf8(e)))}function hex_hmac_sha1(e,t){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(e){return binb2rstr(binb_sha1(rstr2binb(e),8*e.length))}function rstr_hmac_sha1(e,t){var s=rstr2binb(e);s.length>16&&(s=binb_sha1(s,8*e.length));for(var i=Array(16),a=Array(16),n=0;n<16;n++)i[n]=909522486^s[n],a[n]=1549556828^s[n];var r=binb_sha1(i.concat(rstr2binb(t)),512+8*t.length);return binb2rstr(binb_sha1(a.concat(r),672))}function rstr2hex(e){try{}catch(e){hexcase=0}for(var t,s=hexcase?"0123456789ABCDEF":"0123456789abcdef",i="",a=0;a<e.length;a++)t=e.charCodeAt(a),i+=s.charAt(t>>>4&15)+s.charAt(15&t);return i}function str2rstr_utf8(e){for(var t,s,i="",a=-1;++a<e.length;)t=e.charCodeAt(a),s=a+1<e.length?e.charCodeAt(a+1):0,55296<=t&&t<=56319&&56320<=s&&s<=57343&&(t=65536+((1023&t)<<10)+(1023&s),a++),t<=127?i+=String.fromCharCode(t):t<=2047?i+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?i+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(i+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return i}function rstr2binb(e){for(var t=Array(e.length>>2),s=0;s<t.length;s++)t[s]=0;for(s=0;s<8*e.length;s+=8)t[s>>5]|=(255&e.charCodeAt(s/8))<<24-s%32;return t}function binb2rstr(e){for(var t="",s=0;s<32*e.length;s+=8)t+=String.fromCharCode(e[s>>5]>>>24-s%32&255);return t}function binb_sha1(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var s=Array(80),i=1732584193,a=-271733879,n=-1732584194,r=271733878,o=-1009589776,l=0;l<e.length;l+=16){for(var h=i,p=a,c=n,d=r,g=o,m=0;m<80;m++){s[m]=m<16?e[l+m]:bit_rol(s[m-3]^s[m-8]^s[m-14]^s[m-16],1);var f=safe_add(safe_add(bit_rol(i,5),sha1_ft(m,a,n,r)),safe_add(safe_add(o,s[m]),sha1_kt(m)));o=r,r=n,n=bit_rol(a,30),a=i,i=f}i=safe_add(i,h),a=safe_add(a,p),n=safe_add(n,c),r=safe_add(r,d),o=safe_add(o,g)}return Array(i,a,n,r,o)}function sha1_ft(e,t,s,i){return e<20?t&s|~t&i:e<40?t^s^i:e<60?t&s|t&i|s&i:t^s^i}function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function safe_add(e,t){var s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function bit_rol(e,t){return e<<t|e>>>32-t}function genUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}function dirname(e){return(e.match(/.*\//)+"").replace(/(.+)\/$/g,"$1")}function isFloat(e){return Number(e)===e&&e%1!=0}function IsDatetimeValue(e){return e.match(".*ime_.s$")||e.match(".*ime_sec$")}function IsBooleanValue(e){return"true"==e||"yes"==e||!0===e||"false"==e||"no"==e||!1===e}function IsNumberValue(e){return!0!==e&&!1!==e&&"string"!=typeof e&&!isNaN(e)&&""!==e}function degToRad(e){return e*(Math.PI/180)}function fromVersionedToPlain(e,t=""){var s,i={},a=Object.keys(e);for(s in a){var n=a[s],r=!1;"object"==typeof e[n]&&2==Object.keys(e[n]).filter((e=>!(r|=!("version"==e||"value"==e)))).length?i[n]=e[n].value:Array.isArray(e[n])?(i[n]=[],e[n].forEach(((s,a)=>{e[n][a].boper?i[n][i[n].length-1].boper=e[n][a].boper:i[n].push(fromVersionedToPlain(s,`${t}/${n}[${a}]`))}))):"object"==typeof e[n]?i[n]=fromVersionedToPlain(e[n],`${t}/${n}`):i[n]=e[n]}return i}function fromPlainToVersionned(e,t,s=""){var i={},a=Object.keys(e);for(var n in a){var r=a[n],o=t?t[r]:void 0;if(Array.isArray(e[r])){i[r]=[];for(var l=0;l<e[r].length;l++){var h=fromPlainToVersionned(e[r][l],o?o[l]:null,`${s}/${r}[${l}]`);i[r].push(h),h.boper&&(i[r].push({boper:h.boper}),delete h.boper)}}else"object"==typeof e[r]?i[r]=fromPlainToVersionned(e[r],o,`${s}/${r}`):i[r]="boper"===r||"operator"===r||"otype"===r||"value"===r||"name"===r?e[r]:{version:void 0===o?0:e[r]===o.value?o.version:o.version+1,value:e[r]}}return i}const getCellValue=(e,t)=>e.children[t].innerText||e.children[t].textContent,comparer=(e,t)=>(s,i)=>{return a=getCellValue(t?s:i,e),n=getCellValue(t?i:s,e),""===a||""===n||isNaN(a)||isNaN(n)?a.toString().localeCompare(n):a-n;var a,n};class BoolInput extends React.Component{constructor(e){super(e),this.id=this.props.id||genUUID(),this.props.onOn&&this.props.initialState&&this.props.onOn(),this.props.onOff&&!this.props.initialState&&this.props.onOff()}toggleChange=e=>{e.target.checked?this.props.onOn&&this.props.onOn(e.target):this.props.onOff&&this.props.onOff(e.target),this.props.onChange&&this.props.onChange(e.target.checked)};render(){return e("label",{key:genUUID(),className:"editable "+(this.props.blurred?"loading":""),id:`lbl${this.id}`,key:this.id},e("div",{key:genUUID(),className:"label",id:`dlbl${this.id}`},this.props.label),e("input",{key:genUUID(),type:"checkbox",onChange:this.toggleChange,id:`in${this.id}`,checked:this.props.initialState}))}}class CmdButton extends React.Component{runIt(){wfetch(`${httpPrefix}/status/cmd`,{method:this.props.HTTP_METHOD,body:JSON.stringify({command:this.props.command,name:this.props.name,param1:this.props.param1,param2:this.props.param2})}).then((e=>e.text())).then(this.props.onSuccess?this.props.onSuccess:console.log).catch(this.props.onError?this.props.onError:console.error)}render(){return e("button",{key:genUUID(),onClick:this.runIt.bind(this)},this.props.caption)}}class DeviceList extends React.Component{getDevices(){(window.location.host||httpPrefix)&&wfetch(`${httpPrefix}/files/lfs/config`,{method:"post"}).then((e=>e.json())).then((e=>e.filter((e=>"file"==e.ftype)))).then((e=>{var t=e.map((e=>e.name.substr(0,e.name.indexOf("."))));this.setState({devices:t,httpPrefix:httpPrefix}),this.props?.onGotDevices&&this.props.onGotDevices(t)})).catch((e=>{this.setState({error:e})}))}componentDidMount(){this.getDevices()}componentDidUpdate(e,t,s){e?.httpPrefix!=this.props.httpPrefix&&this.getDevices(this.props.httpPrefix)}render(){return this.state?.devices?.length>1?e("select",{key:genUUID(),value:this.props.selectedDeviceId,onChange:e=>this.props?.onSet(e.target.value)},(this.state?.devices||this.props.devices).map((t=>e("option",{key:genUUID(),value:t},t)))):null}}class IntInput extends React.Component{toggleChange=e=>{this.props.onChange&&this.props.onChange(e.target.value)};render(){return e("label",{key:genUUID(),className:"editable",id:`lbl${this.id}`,key:this.id},e("div",{key:genUUID(),className:"label",id:`div${this.id}`},this.props.label),e("input",{key:genUUID(),type:"number",value:this.props.value,onChange:this.toggleChange.bind(this),id:`${this.id}`}))}}class ROProp extends React.Component{constructor(e){super(e),this.id=this.props.id||genUUID()}getValue(t,s){return void 0!==s?.value?this.getValue(t,s.value):(IsNumberValue(s)&&isFloat(s)&&(s="lattitude"!=this.props.name.toLowerCase()&&"longitude"!=this.props.name.toLowerCase()&&"lat"!=this.props.name&&"lng"!=this.props.name?parseFloat(s).toFixed(2):parseFloat(s).toFixed(8)),IsBooleanValue(s)&&(s="true"==s||"yes"==s||!0===s?"Y":"N"),"name"==this.props.name&&s.match(/\/.*\.[a-z]{3}$/)?e("a",{href:`${httpPrefix}${s}`},s):s)}componentDidMount(){IsDatetimeValue(this.props.name)&&this.renderTime(document.getElementById(`vel${this.id}`),this.props.name,this.getValue(this.props.name,this.props.value))}renderTime(e,t,s){if(null!=e){var i=t.endsWith("_us")?new Date(s/1e3):t.endsWith("_sec")?new Date(1e3*s):new Date(s);i.getFullYear()<=1970&&i.setTime(i.getTime()+60*i.getTimezoneOffset()*1e3);var a=i.toLocaleDateString("en-US",{dateStyle:"short"}),n=i.toLocaleTimeString("en-US",{hour12:!1}),r=i.getHours(),o=i.getMinutes(),l=i.getSeconds(),h=i.getMilliseconds(),p=o+(l+h/1e3)/60;i.getFullYear()<=1970&&(a=i.getDate()-1+" Days",n=0==r?(o?o+":":"")+("0"+l).slice(-2)+"."+h:("0"+r).slice(-2)+":"+("0"+o).slice(-2)+":"+("0"+l).slice(-2));var c=e.querySelector("canvas")||e.appendChild(document.createElement("canvas"));c.height=100,c.width=110;var d=c.getContext("2d");d.strokeStyle="#00ffff",d.lineWidth=4,d.shadowBlur=2,d.shadowColor="#00ffff";var g=e.getBoundingClientRect(),m=d.createRadialGradient(g.width/2,g.height/2,5,g.width/2,g.height/2,g.height+5);m.addColorStop(0,"#03303a"),m.addColorStop(1,"black"),d.fillStyle=m,d.clearRect(0,0,g.width,g.height),d.beginPath(),d.arc(g.width/2,g.height/2,.44*g.height,degToRad(270),degToRad(270+30*(r>12?r-12:r))),d.stroke(),d.beginPath(),d.arc(g.width/2,g.height/2,.38*g.height,degToRad(270),degToRad(270+6*p)),d.stroke(),d.font="12px Helvetica",d.fillStyle="rgba(00, 255, 255, 1)";var f=d.measureText(a);d.fillText(a,g.width/2-f.width/2,.65*g.height),d.font="12px Helvetica",d.fillStyle="rgba(00, 255, 255, 1)",f=d.measureText(n),d.fillText(n,.5*g.width-f.width/2,.45*g.height)}}render(){return e("label",{className:"readonly",id:`lbl${this.id}`,key:this.id},[e("div",{key:genUUID(),className:"label",id:`dlbl${this.id}`},this.props.label),e("div",{key:genUUID(),className:"value",id:`vel${this.id}`},IsDatetimeValue(this.props.name)?"":this.getValue(this.props.name,this.props.value))])}}class StateTable extends React.Component{constructor(e){super(e),this.id=this.props.id||genUUID()}SortTable(e){var t;Array.from((t=e.target.closest("table").querySelector("tbody")).querySelectorAll("tr:nth-child(n)")).sort(comparer(Array.from(e.target.parentNode.children).indexOf(e.target),this.asc=!this.asc)).forEach((e=>t.appendChild(e)))}BuildHead(t){return t?(this.cols=[],[e("thead",{key:genUUID(),onClick:this.SortTable.bind(this)},e("tr",{key:genUUID()},t.flatMap((e=>Object.keys(e))).filter(((e,t,s)=>void 0!==e&&s.indexOf(e)===t)).map((s=>{if(!this.cols.some((e=>s==e))){this.cols.push(s);var i=this.getValue(s,t[0][s]);this.sortedOn||Array.isArray(i)||"object"==typeof i||!isNaN(this.getValue(s,i))||(this.sortedOn=s)}return e("th",{key:genUUID()},s)})))),e("caption",{key:genUUID()},this.props.label)]):null}getValue(t,s){return void 0!==s?.value?this.getValue(t,s.value):t.endsWith("_sec")&&s>1e7?new Date(1e3*s).toLocaleString():(IsNumberValue(s)&&isFloat(s)&&(s="lattitude"!=this.props.name.toLowerCase()&&"longitude"!=this.props.name.toLowerCase()&&"lat"!=this.props.name&&"lng"!=this.props.name?parseFloat(s).toFixed(2):parseFloat(s).toFixed(8)),IsBooleanValue(s)&&(s="true"==s||"yes"==s||!0===s?"Y":"N"),"name"==t&&s.match(/\/.*\.[a-z]{3}$/)?e("a",{href:`${httpPrefix}${s}`},s):s)}BuildBody(t){return t?e("tbody",{key:genUUID()},t.sort(((e,t)=>(this.getValue(this.sortedOn,e[this.sortedOn])+"").localeCompare(this.getValue(this.sortedOn,t[this.sortedOn])+""))).map((t=>e("tr",{key:genUUID()},this.cols.map((s=>e("td",{key:genUUID(),className:"readonly"},"object"!=typeof this.getValue(s,t[s])?e("div",{key:genUUID(),className:"value"},this.getValue(s,t[s])):Array.isArray(t[s])?e(StateTable,{key:genUUID(),name:s,label:s,json:t[s]}):e(AppState,{key:genUUID(),json:t[s]})))))))):null}render(){return this.props?.json?e("label",{key:genUUID(),id:this.id,className:"table"},e("table",{key:genUUID(),className:"greyGridTable"},[this.BuildHead(this.props.json),this.BuildBody(this.props.json)])):e("div",{key:genUUID(),id:`loading${this.id}`},"Loading...")}}class StateCommands extends React.Component{render(){return e("div",{key:genUUID(),name:"commands",className:"commands"},this.props.commands.map((t=>e(CmdButton,{key:genUUID(),caption:t.caption||t.command,command:t.command,name:this.props.name,onSuccess:this.props.onSuccess,onError:this.props.onError,param1:t.param1,param2:t.param2,HTTP_METHOD:t.HTTP_METHOD}))))}}class AppState extends React.Component{constructor(e){super(e),this.state=e.json}componentWillUnmount(){this.mounted=!1}componentDidMount(){this.mounted=!0}Parse(t){return t?e("div",{key:genUUID(),className:"statusclass"},this.getSortedProperties(t).map((s=>Array.isArray(t[s])?"commands"==s?{fld:s,element:e(StateCommands,{key:genUUID(),name:t.name,commands:t[s],onSuccess:this.props.updateAppStatus})}:{fld:s,element:e(StateTable,{key:genUUID(),name:s,label:s,json:t[s]})}:"object"!=typeof t[s]||Object.keys(t[s]).find((e=>"value"==e))?"class"==s||"name"==s&&t.name==t.class?void 0:{fld:s,element:e(ROProp,{key:genUUID(),value:t[s],name:s,label:s})}:{fld:s,element:e(AppState,{key:genUUID(),name:s,label:s,json:t[s],updateAppStatus:this.props.updateAppStatus,registerEventInstanceCallback:this.props.registerEventInstanceCallback})})).reduce(((e,s)=>{if(s){var i=this.getFieldClass(t,s.fld),a=e.find((e=>e.fclass==i));a?a.elements.push(s.element):e.push({fclass:i,elements:[s.element]})}return e}),[]).map((t=>e("div",{key:genUUID(),className:`fieldgroup ${t.fclass}`},t.elements)))):e("div",{id:`loading${this.id}`},"Loading...")}getSortedProperties(e){return Object.keys(e).sort(((t,s)=>{var i=this.getFieldWeight(e,t),a=this.getFieldWeight(e,s);return i==a?t.localeCompare(s):i>a?1:a>i?-1:0})).filter((t=>!("object"==typeof e[t]&&0==Object.keys(e[t]).filter((e=>"class"!=e&&"name"!=e)).length)))}getFieldWeight(e,t){return Array.isArray(e[t])?5:"object"==typeof e[t]?e[t].commands?3:4:IsDatetimeValue(t)?1:2}getFieldClass(e,t){return Array.isArray(e[t])?"array":"object"==typeof e[t]?e[t].commands?"commandable":"object":"field"}ProcessEvent(e){this.mounted&&e?.data&&e.data?.class==this.state.class&&e.data?.name==this.state.name&&this.setState({...e.data})}render(){return null===this.state||void 0===this.state?e("div",{id:`loading${this.id}`},"Loading..."):null!=this.props.label?(this.props.registerEventInstanceCallback&&this.props.registerEventInstanceCallback(this.ProcessEvent.bind(this),`${this.state.className}-${this.state.name}`),e("fieldset",{id:`fs${this.props.label}`},[e("legend",{key:genUUID()},this.props.label),this.Parse(this.state)])):e("fieldset",{key:genUUID(),id:`fs${this.id}`},this.Parse(this.state))}}class MainAppState extends React.Component{constructor(e){super(e),this.mounted=!1}componentWillUnmount(){this.mounted=!1}componentDidMount(){this.mounted=!0,this.updateAppStatus(),this.props.registerStateCallback&&this.props.registerStateCallback(this.refreshStatus.bind(this))}updateAppStatus(){this.updateStatuses([{url:"/status/"},{url:"/status/app"},{url:"/status/tasks",path:"tasks"}],{})}refreshStatus(e){if(this.mounted)if(e){const s=Object.keys(e);var t=this.state?.status||{};for(const i in s)t[s[i]]=e[s[i]];this.setState({status:t})}else this.updateAppStatus()}updateStatuses(e,t){if(window.location.host||httpPrefix){var s=new AbortController,i=setTimeout((()=>s.abort()),4e3);"current"==this.props.selectedDeviceId?Promise.all(e.map((i=>new Promise(((a,n)=>{wfetch(`${httpPrefix}${i.url}`,{method:"post",signal:s.signal}).then((e=>e.json())).then(fromVersionedToPlain).then((s=>{e=e.filter((e=>e!=i)),i.path?t[i.path]=Object.values(s):Object.assign(t,s),a({path:i.path,stat:s})})).catch((e=>{i.retryCnt=1+(0|i.retryCnt),i.waitFor=1e3,i.error=e,n(e)}))}))))).then((e=>{clearTimeout(i),document.getElementById("Status").style.opacity=1,this.mounted&&this.setState({error:null,status:this.orderResults(t)})})).catch((s=>{if(clearTimeout(i),20!=s.code){var a=e.filter((e=>e.error));document.getElementById("Status").style.opacity=.5,a[0].waitFor?setTimeout((()=>{s.message,this.updateStatuses(e,t)}),a[0].waitFor):this.updateStatuses(e,t)}})):this.props.selectedDeviceId&&wfetch(`${httpPrefix}/lfs/status/${this.props.selectedDeviceId}.json`,{method:"get",signal:s.signal}).then((e=>e.json())).then(fromVersionedToPlain).then((e=>{this.mounted&&this.setState({status:this.orderResults(e)})}))}}orderResults(e){var t={};return Object.keys(e).filter((t=>"object"!=typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>"object"==typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>Array.isArray(e[t]))).forEach((s=>t[s]=e[s])),t}render(){return this.state?.status?[e("button",{key:genUUID(),onClick:e=>this.updateAppStatus()},"Refresh"),e(AppState,{key:genUUID(),json:this.state.status,selectedDeviceId:this.props.selectedDeviceId,updateAppStatus:this.updateAppStatus.bind(this),registerEventInstanceCallback:this.props.registerEventInstanceCallback})]:e("div",{key:genUUID()},"Loading...")}}class ConfigEditor extends React.Component{componentDidMount(){this.props.deviceConfig?(this.jsonEditor=new JSONEditor(this.container,{onChangeJSON:e=>Object.assign(this.props.deviceConfig,e)}),this.jsonEditor.set(this.props.deviceConfig)):this.container.innerText="Loading..."}render(){return e("div",{key:genUUID(),ref:e=>this.container=e,id:`${this.props.id||genUUID()}`,className:"column col-md-12","data-theme":"spectre"})}}class ConfigPage extends React.Component{componentDidMount(){(window.location.hostname||httpPrefix)&&this.getJsonConfig(this.props.selectedDeviceId).then((e=>this.setState({config:e})))}getJsonConfig(e){return new Promise(((t,s)=>{if(window.location.host||httpPrefix){const i=setTimeout((()=>this.props.pageControler.abort()),3e3);wfetch(`${httpPrefix}/config${e&&"current"!=e?`/${e}`:""}`,{method:"post",signal:this.props.pageControler.signal}).then((e=>{clearTimeout(i),t(e.json())})).catch((e=>{clearTimeout(i),s(e)}))}else s({error:"Not connected"})}))}SaveForm(e){this.getJsonConfig(this.props.selectedDeviceId).then((e=>fromPlainToVersionned(this.state.config,e))).then((t=>wfetch(e.target.action.replace("file://",httpPrefix)+"/"+("current"==this.props.selectedDeviceId?"":this.props.selectedDeviceId),{method:"put",body:JSON.stringify(t)}).then((e=>alert(JSON.stringify(e)))).catch((e=>alert(JSON.stringify(e)))))),e.preventDefault()}render(){return this.state?.config?e("form",{onSubmit:e=>this.SaveForm(e),key:`${this.props.id||genUUID()}`,action:"/config",method:"post"},[e(AppState,{key:genUUID(),json:this.state.config,selectedDeviceId:this.props.selectedDeviceId}),e("button",{key:genUUID(),type:"button",onClick:e=>this.getJsonConfig(this.props.selectedDeviceId).then((e=>this.setState({config:e})))},"Refresh")]):e("div",{key:genUUID()},"Loading....")}}class ControlPanel extends React.Component{constructor(e){super(e),this.anims=[],this.state={autoRefresh:e.autoRefresh},this.props?.OnLineDevices?.length||httpPrefix||window.location.hostname?this.props?.autoRefresh&&this.openWs():this.lookForDevs()}componentDidMount(){this.mountWidget(),window.requestAnimationFrame(this.drawDidget.bind(this))}componentDidUpdate(e,t,s){this.mountWidget()}lookForDevs(){if(!this.state?.scanning){this.setState({scanning:!0});for(var e=[],t=254;t>0;t--)e.push(`192.168.1.${t}`);var s=[];for(t=0;t<Math.min(10,e.length);t++)e.length&&this.scanForDevices(e,s)}}scanForDevices(e,t){if(e.length){var s=e.pop(),i=new AbortController,a=setTimeout((()=>i.abort()),1e3);wfetch(`http://${s}/config/`,{method:"post",signal:i.signal}).then((e=>(clearTimeout(a),!0,e.json()))).then(fromVersionedToPlain).then((s=>{s?.deviceid&&t.push(s),e.length?this.scanForDevices(e,t):this.props?.OnLineDevices?.length||(httpPrefix=`http://${t[0].devName}`,this.state?.autoRefresh&&!this.state.connecting&&this.state.connected,this.props.OnToggleAutoRefresh(!0),this.props.OnLiveDevChange(t))})).catch((s=>{e.length?this.scanForDevices(e,t):this.props?.OnLineDevices?.length||(httpPrefix=`http://${t[0].devName}`,this.state?.autoRefresh&&!this.state.connecting&&this.state.connected,this.props.OnToggleAutoRefresh(!0),this.props.OnLiveDevChange(t))}))}}mountWidget(){this.widget.addEventListener("click",(e=>{e.offsetX>2&&e.offsetX<32&&e.offsetY>2&&e.offsetY<32&&this.props.OnToggleAutoRefresh(!this.state?.autoRefresh)}))}closeWs(){this.props.OnToggleAutoRefresh(off),this.ws&&(this.ws.close(),this.ws=null)}openWs(){if((window.location.hostname||httpPrefix)&&!this.state?.connecting&&!this.state?.connected){this.setState({connecting:!0,running:!1});var e=this.ws=new WebSocket("ws://"+(""==httpPrefix?window.location.hostname:httpPrefix.substring(7))+"/ws"),t=setTimeout((()=>{e.close(),this.setState({connecting:!1})}),3e3);e.onmessage=s=>{clearTimeout(t),this.state.running&&!this.state.timeout||this.setState({running:!0,error:null,timeout:null}),s&&s.data&&("{"==s.data[0]?s.data.startsWith('{"eventBase"')?this.ProcessEvent(fromVersionedToPlain(JSON.parse(s.data))):this.UpdateState(fromVersionedToPlain(JSON.parse(s.data))):s.data.match(/.*\) ([^:]*)/g)&&this.AddLogLine(s.data)),t=setTimeout((()=>{this.setState({timeout:"Message"}),e.close()}),3e3)},e.onopen=()=>{clearTimeout(t),this.setState({connected:!0,connecting:!1}),e.send("Connected"),t=setTimeout((()=>{this.setState({timeout:"Connect"}),e.close()}),3e3)},e.onerror=s=>{clearTimeout(t),this.setState({error:s}),e.close()},e.onclose=e=>{clearTimeout(t),this.setState({connected:!1,connecting:!1})}}}drawDidget(){if(this.widget){var e=this.widget.getContext("2d");if(e.clearRect(0,0,100,40),this.browser(e,2,2,30,30,10),this.chip(e,70,2,20,30,5),this.anims.length){var t=this.anims.reduce(((e,t)=>((e[t.type]=e[t.type]||[]).push(t),e)),{});for(var s in t)e.beginPath(),t[s].forEach((t=>{this.drawSprite(t,e)}));this.anims=this.anims.filter((e=>2!=e.state))}window.requestAnimationFrame(this.drawDidget.bind(this))}}drawSprite(e,t){return e.state?e.x-=3+e.weight:(e.state=1,e.x=e.startX,e.y=e.startY),t.strokeStyle=e.lineColor,t.lineWidth=1,t.shadowBlur=1,t.shadowColor=e.shadowColor,t.fillStyle=e.color,t.moveTo(e.x,e.y),t.arc(e.x,e.y,4+e.weight,0,2*Math.PI),t.fill(),e.x<30&&(e.state=2),e}browser(e,t,s,i,a,n){e.beginPath(),e.strokeStyle="#00ffff",e.lineWidth=2,e.shadowBlur=2,e.shadowColor="#00ffff",e.fillStyle=this.state?.autoRefresh?this.state?.error||this.state?.timeout?"#f27c7c":this.state?.connected?"#00ffff59":"#0396966b":"#000000",this.roundedRectagle(e,t,s,i,a,n),e.fill(),e.stroke()}chip(e,t,s,i,a,n){e.beginPath();e.strokeStyle="#00ffff",e.lineWidth=2,e.shadowBlur=2,e.shadowColor="#00ffff",e.fillStyle="#00ffff",this.roundedRectagle(e,t,s,i,a,n);for(var r=0;r<3;r++)e.moveTo(t,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t-4,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t-4,1.5*n+2+s+r*((a-2*n)/3)),e.lineTo(t,1.5*n+2+s+r*((a-2*n)/3)),e.moveTo(t+i,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t+i+4,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t+i+4,1.5*n+2+s+r*((a-2*n)/3)),e.lineTo(t+i,1.5*n+2+s+r*((a-2*n)/3));e.stroke()}roundedRectagle(e,t,s,i,a,n){e.moveTo(t+n,s),e.lineTo(t+i-2*n,s),e.arcTo(t+i,s,t+i,s+n,n),e.lineTo(t+i,s+a-n),e.arcTo(t+i,s+a,t+i-n,s+a,n),e.lineTo(t+n,s+a),e.arcTo(t,s+a,t,s+a-n,n),e.lineTo(t,s+n),e.arcTo(t,s,t+n,s,n)}AddLogLine(e){var t=this.anims.filter((e=>"log"==e.type)),s=t.filter((t=>t.level==e[0]));t.length>4&&s.length>1?(s.find((e=>e.weight<3))||s[0]).weight++:this.anims.push({type:"log",level:e[0],color:"D"==e[0]?"green":"W"==e[0]?"yellow":"red",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startX:70,startY:25,renderer:this.drawSprite}),e&&this.props.logCBFn&&this.props.logCBFn.forEach((t=>t(e)))}UpdateState(e){var t=this.anims.filter((e=>"state"==e.type));t.length>4?(t.find((e=>e.weight<3))||t[0]).weight++:this.anims.push({type:"state",color:"#00ffff",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startX:70,startY:15,renderer:this.drawSprite}),this.props.stateCBFn&&this.props.stateCBFn.forEach((t=>t(e)))}ProcessEvent(e){var t=this.anims.filter((e=>"event"==e.type)),s=t.filter((t=>t.eventBase==e.eventBase));t.length>4&&s.length>1?(s.find((e=>e.weight<3))||s[0]).weight++:this.anims.push({type:"event",eventBase:e.eventBase,color:"#7fffd4",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startX:70,startY:5,renderer:this.drawSprite}),this.props.eventCBFn&&this.props.eventCBFn.forEach((t=>t(e)))}render(){return e("fieldset",{key:genUUID(),className:"slides",id:"controls",key:this.id},[this.props?.OnLineDevices?.length&&!window.location.hostname?e("select",{key:genUUID(),className:"landevices",value:httpPrefix.substring(7),onChange:e=>{httpPrefix=`http://${e.target.value}`,this.props.ReloadPage()}},this.props.OnLineDevices.map((t=>e("option",{key:genUUID(),className:"landevice"},t.devName)))):null,e("canvas",{key:genUUID(),height:40,width:100,ref:e=>this.widget=e}),e(DeviceList,{key:genUUID(),selectedDeviceId:this.props.selectedDeviceId,devices:this.state?.devices,onSet:this.props.onSelectedDeviceId,onGotDevices:e=>this.setState({devices:e})})])}}class TypedField extends React.Component{render(){return[e("div",{key:genUUID(),className:this.props.type},this.props.type),this.props.path?e("div",{key:genUUID(),className:"path"},this.props.path):null]}}class LitteralField extends React.Component{render(){return e("div",{key:genUUID(),className:"litteral"},this.props.value)}}class EventField extends React.Component{render(){return e("div",{key:genUUID(),className:"conditionField"},this.props.name?e(TypedField,{key:genUUID(),type:this.props.name,value:this.props.value,path:this.props.path}):e(LitteralField,{key:genUUID(),value:this.props.value}))}}class EventCondition extends React.Component{render(){return e("div",{key:genUUID(),className:"condition"},[e(EventField,{key:genUUID(),...this.props.src}),e("div",{key:genUUID(),className:"operator"},this.props.operator),e(EventField,{key:genUUID(),...this.props.comp})])}}class EventConditions extends React.Component{render(){return e("details",{key:genUUID(),className:"conditions "+(0==this.props.conditions.length?"hidden":"")},[e("summary",{key:genUUID()},"Conditions"),this.props.conditions.map((t=>e(EventCondition,{key:genUUID(),...t})))])}}class EventLine extends React.Component{render(){return"conditions"==this.props.name?e(EventConditions,{key:genUUID(),className:this.props.name,conditions:this.props.value}):Array.isArray(this.props.value)?this.props.value.length>0?e("details",{key:genUUID(),className:`arrayfield ${this.props.name}`},e("summary",{key:genUUID(),className:"name"},this.props.name),this.props.value.map((t=>e("div",{key:genUUID(),className:"arrayItem"},Object.keys(t).map((s=>e(EventLine,{key:genUUID(),name:s,value:t[s]}))))))):null:"object"==typeof this.props.value?Object.keys(this.props.value).length>0?e("details",{key:genUUID(),className:`object ${this.props.name}`},[e("summary",{key:genUUID(),className:"object name"},this.props.name),Object.keys(this.props.value).map((t=>e("details",{key:genUUID(),className:"name"},[e("summary",{key:genUUID()},t),e("div",{key:genUUID(),className:t},this.props.value[t])])))]):null:e("details",{key:genUUID(),className:this.props.name},[e("summary",{key:genUUID()},this.props.name),this.props.value])}}class Event extends React.Component{render(){return e("details",{key:genUUID(),className:"event"},[e("summary",{key:genUUID(),className:"name"},[e("div",{key:genUUID(),className:"eventBase"},this.props.eventBase),e("div",{key:genUUID(),className:"eventId"},this.props.eventId)]),Object.keys(this.props).filter((e=>"name"!=e)).map((t=>e(EventLine,{key:genUUID(),name:t,value:this.props[t]})))])}}class LiveEvent extends React.Component{render(){return this.props?.event?.dataType?this.renderComponent(this.props.event):e("summary",{key:genUUID(),className:"liveEvent"},e("div",{key:genUUID(),className:"description"},[e("div",{key:genUUID(),className:"eventBase"},"Loading"),e("div",{key:genUUID(),className:"eventId"},"...")]))}renderComponent(t){return e("summary",{key:genUUID(),className:"liveEvent"},[e("div",{key:genUUID(),className:"description"},[e("div",{key:genUUID(),className:"eventBase"},t.eventBase),e("div",{key:genUUID(),className:"eventId"},t.eventId)]),t.data?e("details",{key:genUUID(),className:"data"},this.parseData(t)):null])}parseData(t){return"Number"==t.dataType?e("div",{key:genUUID(),className:"description"},e("div",{key:genUUID(),className:"propNumber"},t.data)):Object.keys(t.data).filter((e=>"object"!=typeof t.data[e]&&!Array.isArray(t.data[e]))).map((s=>e("div",{key:genUUID(),className:"description"},[e("div",{key:genUUID(),className:"propName"},s),e("div",{key:genUUID(),className:s},t.data[s])])))}}class LiveEventPannel extends React.Component{constructor(e){super(e),this.eventTypes=[],this.eventTypeRequests=[],this.props.registerEventCallback&&this.props.registerEventCallback(this.ProcessEvent.bind(this)),this.mounted=!1}componentDidMount(){this.mounted=!0}componentWillUnmount(){this.mounted=!1}ProcessEvent(e){if(this.mounted){for(var t=this.state?.lastEvents||[];t.length>100;)t.shift();this.setState({lastEvents:t.concat(e)})}}parseEvent(e){var t=this.eventTypes.find((t=>t.eventBase==e.eventBase&&t.eventName==e.eventId));return t?{dataType:t.dataType,...e}:(!this.eventTypeRequests.find((t=>t.eventBase==e.eventBase&&t.eventId==e.eventId))&&this.mounted&&this.getEventDescriptor(e).then((e=>this.setState({lastState:this.state.lastEvents.map((t=>t.eventBase==e.eventBase&&t.eventId==e.eventName?{dataType:e.dataType,...t}:{event:t}))}))),{...e})}getEventDescriptor(e){var t;return this.eventTypeRequests.push(t={waiters:[],...e}),new Promise(((s,i)=>{var a=this.eventTypes.find((t=>t.eventBase==e.eventBase&&t.eventName==e.eventId));if(a)s({dataType:a.dataType,...e});else{var n=new AbortController;const a=setTimeout((()=>n.abort()),3e3);wfetch(`${httpPrefix}/eventDescriptor/${e.eventBase}/${e.eventId}`,{method:"post",signal:n.signal}).then((e=>(clearTimeout(a),e.json()))).then((e=>{this.eventTypes.push(e),s(e)})).catch((e=>{clearTimeout(a),t.waiters.forEach((t=>{t.reject(e)})),i(e)}))}}))}render(){return e("div",{key:genUUID(),className:"eventPanel"},[e("div",{key:genUUID(),className:"control"},[e("div",{key:genUUID()},`${this.state?.lastEvents?.length||"Waiting on "} event${this.state?.lastEvents?.length?"s":""}`),e("button",{key:genUUID(),onClick:e=>this.setState({lastEvents:[]})},"Clear")]),e("div",{key:genUUID(),className:"eventList"},this.state?.lastEvents?.map((t=>e(LiveEvent,{key:genUUID(),event:this.parseEvent(t)}))).reverse())])}}class EventsPage extends React.Component{componentWillUnmount(){this.mounted=!1}componentDidMount(){this.mounted=!0,(window.location.hostname||httpPrefix)&&this.getJsonConfig().then((e=>this.mounted?this.setState({events:e.events,programs:e.programs}):null))}getJsonConfig(){return new Promise(((e,t)=>{if(window.location.hostname||httpPrefix){const s=setTimeout((()=>this.props.pageControler.abort()),3e3);wfetch(`${httpPrefix}/config${"current"==this.props.selectedDeviceId?"":`/${this.props.selectedDeviceId}`}`,{method:"post",signal:this.props.pageControler.signal}).then((e=>(clearTimeout(s),e.json()))).then((t=>e(fromVersionedToPlain(t)))).catch((e=>{clearTimeout(s),t(e)}))}else t({error:"Not connected"})}))}render(){return this.state?.events?[e("div",{key:genUUID(),className:"designer"},[e("details",{key:genUUID(),className:"configuredEvents",onClick:e=>e.target.parentElement.nextSibling.removeAttribute("open"),open:!0},[e("summary",{key:genUUID()},`${this.state.events?.length} Events`),e("div",{key:genUUID(),className:"content"},this.state.events?.map((t=>e(Event,{key:genUUID(),...t}))))]),e("details",{key:genUUID(),className:"programs",onClick:e=>e.target.parentElement.previousSibling.removeAttribute("open")},[e("summary",{key:genUUID()},`${this.state.programs?.length} Programs`),e("div",{key:genUUID(),className:"content"},this.state.programs?.map((t=>e(Program,{key:genUUID(),...t}))))])]),e(LiveEventPannel,{key:genUUID(),registerEventCallback:this.props.registerEventCallback})]:e("div",{key:genUUID()},"Loading...")}}class FirmwareUpdater extends React.Component{UploadFirmware(e){if(e.preventDefault(),this.setState({loaded:`Sending ${this.state.len} firmware bytes`}),this.state.fwdata&&this.state.md5)return wfetch(`${httpPrefix}/ota/flash?md5=${this.state.md5}&len=${this.state.len}`,{method:"post",body:this.state.fwdata}).then((e=>e.text())).then((e=>this.setState({loaded:e})))}waitForDevFlashing(){var e=new AbortController,t=setTimeout((()=>{e.abort()}),1e3);wfetch(`${httpPrefix}/status/app`,{method:"post",signal:e.signal}).then((e=>(clearTimeout(t),e.json()))).then((e=>this.setState({waiter:null,loaded:`Loaded version ${e.build.ver} built on ${e.build.date}`}))).catch((e=>{clearTimeout(t),this.setState({waiter:setTimeout((()=>this.waitForDevFlashing()),500)})}))}componentDidUpdate(e,t,s){if("Flashing"==this.state.loaded&&null==this.state.waiter&&this.waitForDevFlashing(),this.state.firmware&&!this.state.md5){this.state.md5="loading";var i=new FileReader;i.onload=()=>{var e=i.resultString||i.result,t=CryptoJS.algo.MD5.create();t.update(CryptoJS.enc.Latin1.parse(i.result)),this.state.fwdata=new Uint8Array(this.state.firmware.size);for(var s=0;s<e.length;s++)this.state.fwdata[s]=e.charCodeAt(s);this.setState({md5:t.finalize().toString(CryptoJS.enc.Hex),fwdata:this.state.fwdata,len:this.state.firmware.size})},i.onprogress=e=>this.setState({loaded:1*this.state.firmware.size/(1*e.loaded)*100+"% loaded"}),i.onerror=e=>this.setState({md5:null,firmware:null,error:e.textContent}),i.onabort=e=>this.setState({md5:null,firmware:null,error:"Aborted"}),i.readAsBinaryString(this.state.firmware)}}render(){return e("form",{key:genUUID(),onSubmit:this.UploadFirmware.bind(this)},e("fieldset",{key:genUUID()},[e("input",{key:genUUID(),type:"file",name:"firmware",onChange:e=>this.setState({firmware:e.target.files[0]})}),e("button",{key:genUUID()},"Upload"),e("div",{key:genUUID()},this.state?.loaded)]))}}class ProgramLine extends React.Component{render(){return Array.isArray(this.props.value)?e("details",{key:genUUID(),className:`arrayfield ${this.props.name}`},e("summary",{key:genUUID(),className:"name"},this.props.name),this.props.value.map((t=>e("div",{key:genUUID(),className:"arrayItem"},Object.keys(t).map((s=>e(ProgramLine,{key:genUUID(),name:s,value:t[s]}))))))):"object"==typeof this.props.value?e("details",{key:genUUID(),className:`object ${this.props.name}`},[e("summary",{key:genUUID(),className:"object name"},this.props.name),Object.keys(this.props.value).map((t=>e("details",{key:genUUID(),className:"name"},[e("summary",{key:genUUID()},t),e("div",{key:genUUID(),className:t},this.props.value[t])])))]):e("details",{key:genUUID(),className:this.props.name},[e("summary",{key:genUUID()},this.props.name),this.props.value])}}class Program extends React.Component{render(){return e("details",{key:genUUID(),className:"program"},[e("summary",{key:genUUID(),className:"name"},this.props.name),Object.keys(this.props).filter((e=>"name"!=e)).map((t=>e(ProgramLine,{key:genUUID(),name:t,value:this.props[t]})))])}}class UnparsedCVS extends React.Component{renderTrip(){this.state?.points?this.setState({points:this.state.points}):wfetch(`${httpPrefix}${this.props.folder}/${this.props.name}`).then((e=>e.text())).then((e=>{var t=e.split(/\n|\r\n/),s=t[0].split(",");this.setState({points:t.splice(1).map((e=>{var t={};return e.split(",").forEach(((e,i)=>t[s[i]]=isNaN(e)?e:parseFloat(e))),t})).filter((e=>e.timestamp&&e.timestamp.match(/[0-9]{4}\/[0-9]{2}\/[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}/)))})}))}getIconColor(){return this.state?.points?this.state.points.length?"aquamarine":"#ff0000":"#00ff00"}getIcon(){return e("svg",{key:genUUID(),xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64",onClick:this.renderTrip.bind(this)},[e("path",{key:genUUID(),style:{fill:this.getIconColor()},d:"M17.993 56h20v6h-20zm-4.849-18.151c4.1 4.1 9.475 6.149 14.85 6.149 5.062 0 10.11-1.842 14.107-5.478l.035.035 1.414-1.414-.035-.035c7.496-8.241 7.289-20.996-.672-28.957A20.943 20.943 0 0 0 27.992 2a20.927 20.927 0 0 0-14.106 5.477l-.035-.035-1.414 1.414.035.035c-7.496 8.243-7.289 20.997.672 28.958zM27.992 4.001c5.076 0 9.848 1.976 13.437 5.563 7.17 7.17 7.379 18.678.671 26.129L15.299 8.892c3.493-3.149 7.954-4.891 12.693-4.891zm12.696 33.106c-3.493 3.149-7.954 4.892-12.694 4.892a18.876 18.876 0 0 1-13.435-5.563c-7.17-7.17-7.379-18.678-.671-26.129l26.8 26.8z"}),e("path",{key:genUUID(),style:{fill:this.getIconColor()},d:"M48.499 2.494l-2.828 2.828c4.722 4.721 7.322 10.999 7.322 17.678s-2.601 12.957-7.322 17.678S34.673 48 27.993 48s-12.957-2.601-17.678-7.322l-2.828 2.828C12.962 48.983 20.245 52 27.993 52s15.031-3.017 20.506-8.494c5.478-5.477 8.494-12.759 8.494-20.506S53.977 7.97 48.499 2.494z"})])}render(){return e("div",{key:genUUID(),className:"rendered trip"},[this.getIcon(),this.state?.points?e(TripViewer,{key:genUUID(),points:this.state.points}):null])}}class FileViewer extends React.Component{constructor(e){super(e),this.buildRenderers()}buildRenderers(){this.props.name.endsWith(".csv")&&wfetch(`${httpPrefix}${this.props.folder}/${this.props.name}`).then((e=>e.text())).then((e=>{e.startsWith("timestamp,longitude,latitude,speed,altitude,course,RAM,Battery,Satellites")&&!this.state?.renderes?.some("unparsedcsv")&&this.setState({renderes:["unparsedcsv",...this.state?.renderes||[]]})}))}getRenderers(){return this.state?.renderes.map((t=>{switch(t){case"unparsedcsv":return e(UnparsedCVS,{key:genUUID(),...this.props});break;default:return null;break}}))}render(){return[e("a",{key:genUUID(),href:`${httpPrefix}${this.props.folder}/${this.props.name}`},this.props.name),this.getRenderers()]}}class SFile extends React.Component{render(){return e("tr",{key:genUUID(),className:this.props.file.ftype},[e("td",{key:genUUID()},this.getLink(this.props.file)),e("td",{key:genUUID()},"file"!=this.props.file.ftype?"":this.props.file.size),e("td",{key:genUUID()},this.getDeleteLink())])}getDeleteLink(){return"/"==this.props.path||".."==this.props.file.name?null:e("a",{key:genUUID(),href:"#",onClick:()=>{wfetch(`${httpPrefix}/stat${"/"===this.props.path?"":this.props.path}/${this.props.file.name}`,{method:"post",headers:{ftype:"file"==this.props.file.ftype?"file":"directory",operation:"delete"}}).then(this.props.OnDelete?this.props.OnDelete():null).catch((e=>{}))}},"Del")}getLink(t){return"folder"==t.ftype?e("a",{key:genUUID(),href:"#",onClick:()=>this.props.onChangeFolder?this.props.onChangeFolder(`${t.folder||"/"}${".."==t.name?"":"/"+t.name}`.replaceAll("//","/")):null},t.name):e(FileViewer,{key:genUUID(),...t})}}class StorageViewer extends React.Component{constructor(e){super(e),this.state={loaded:!1,path:"/",files:null},this.id=this.props.id||genUUID()}getSystemFolders(){return["/"!=this.state.path?{ftype:"folder",name:"..",folder:dirname(this.state.path)}:null]}GetFileStat(e){if(e.length){var t=e.pop(),s=setTimeout((()=>this.props.pageControler.abort()),3e3);wfetch(`${httpPrefix}/stat${t.folder}/${t.name}`,{method:"post",signal:this.props.pageControler.signal}).then((i=>{clearTimeout(s),i.json().then((e=>{t.size=e.size,this.mounted&&this.setState({loaded:!0,files:this.state.files,total:this.state?.total+e.size})})),e.length&&!this.props.pageControler.signal.aborted&&this.mounted&&this.GetFileStat(e)})).catch((e=>{clearTimeout(s)}))}}fetchFiles(){if(window.location.host||httpPrefix){var e=setTimeout((()=>this.props.pageControler.abort()),3e3);wfetch(`${httpPrefix}/files`+this.state.path,{method:"post",signal:this.props.pageControler.signal}).then((t=>{clearInterval(e),t.json().then((e=>e.sort(((e,t)=>e.ftype!=t.ftype?"folder"==e.ftype?1:-1:e.name==t.name?0:e.name>t.name?1:-1)))).then((e=>{if(this.mounted){this.setState({loaded:!0,files:e,total:e.reduce(((e,t)=>e+t.size),0)});for(var t=e.filter((e=>"file"==e.ftype&&!e.size)),s=0;s<Math.min(3,t.length);s++)t.length&&this.GetFileStat(t)}}))})).catch(console.error)}}componentDidUpdate(e,t){this.state.loaded||(this.state.loaded=!0),t&&t.path!=this.state.path&&this.fetchFiles()}componentDidMount(){this.mounted=!0,this.state?.files||this.fetchFiles()}componentWillUnmount(){this.mounted=!1}SortTable(e){var t;Array.from((t=e.target.closest("div.file-table").querySelector("tbody")).querySelectorAll("tr:nth-child(n+2)")).sort(comparer(Array.from(e.target.parentNode.children).indexOf(e.target),this.asc=!this.asc)).forEach((e=>t.appendChild(e)))}getTableHeader(){return e("thead",{key:genUUID()},e("tr",{key:genUUID()},["Name","Size"].map((t=>e("th",{key:genUUID(),onClick:this.SortTable.bind(this)},t))).concat(e("th",{key:genUUID()},"Op"))))}render(){return this.state?.files?e("div",{key:genUUID(),id:this.id,className:"file-table "+(this.state.loaded?"":"loading")},e("table",{key:genUUID(),className:"greyGridTable"},[e("caption",{key:genUUID()},this.state.path),this.getTableHeader(),e("tbody",{key:genUUID()},this.getSystemFolders().concat(this.state.files).filter((e=>e)).map((t=>e(SFile,{key:genUUID(),file:t,path:this.state.path,onChangeFolder:e=>this.setState({path:e}),OnDelete:()=>this.fetchFiles()})))),e("tfoot",{key:genUUID()},e("tr",{key:genUUID()},[e("td",{key:genUUID()},"Total"),e("td",{key:genUUID()},this.state.total)]))])):e("div",{key:genUUID()},"Loading...")}}class LogLine extends React.Component{isScrolledIntoView(){var e=this.logdiv.getBoundingClientRect(),t=e.top,s=e.bottom;return t>=0&&s<=window.innerHeight}render(){var t=this.props.logln.match(/^[^IDVEW]*(.+)/)[1],s=t.substr(0,1),i=t.match(/.*\) ([^:]*)/g)[0].replaceAll(/^.*\) (.*)/g,"$1"),a=this.props.logln.substr(this.props.logln.indexOf(i)+i.length+2).replaceAll(/^[\r\n]*/g,"").replaceAll(/.\[..\n$/g,"");return e("div",{key:genUUID(),className:`log LOG${s}`},[e("div",{key:genUUID(),ref:e=>this.logdiv=e,className:"LOGLEVEL"},s),e("div",{key:genUUID(),className:"LOGDATE"},t.substr(3,12)),e("div",{key:genUUID(),className:"LOGFUNCTION"},i),e("div",{key:genUUID(),className:"LOGLINE"},a)])}}class LogLines extends React.Component{constructor(e){super(e),this.mounted=!1,this.state={logLines:[]}}componentDidMount(){this.mounted=!0}AddLogLine(e){this.mounted&&this.setState({logLines:[...this.state?.logLines||[],e]})}render(){return this.props.registerLogCallback&&this.props.registerLogCallback(this.AddLogLine.bind(this)),e("div",{key:genUUID(),className:"loglines"},this.state?.logLines?this.state.logLines.map((t=>e(LogLine,{key:genUUID(),logln:t}))):null)}}class SystemPage extends React.Component{SendCommand(e){return wfetch(`${httpPrefix}/status/cmd`,{method:"PUT",body:JSON.stringify(e)}).then((e=>e.text().then(console.log))).catch(console.error).catch(console.error)}render(){return[e("div",{key:genUUID()},[e("button",{key:genUUID(),onClick:e=>this.setState({logLines:[]})},"Clear Logs"),e("button",{key:genUUID(),onClick:e=>this.SendCommand({command:"reboot"})},"Reboot"),e("button",{key:genUUID(),onClick:e=>this.SendCommand({command:"parseFiles"})},"Parse Files"),e("button",{key:genUUID(),onClick:e=>this.SendCommand({command:"factoryReset"})},"Factory Reset"),e(FirmwareUpdater,{key:genUUID()})]),e(LogLines,{key:genUUID(),registerLogCallback:this.props.registerLogCallback})]}}class TripViewer extends React.Component{constructor(e){super(e),this.zoomlevel=15,this.state={images:{}}}componentDidMount(){this.mounted=!0,this.drawMap()}drawMap(){return new Promise(((e,t)=>{this.mounted&&this.widget&&this.props.points&&this.props.points.length?(this.canvas=this.widget.getContext("2d"),this.getTripTiles().then(this.drawTripTiles.bind(this)).then(this.drawTrip.bind(this)).catch(t)):t({})}))}getTripTiles(){return new Promise(((e,t)=>this.props.points?.length?e(this.props.points.reduce(((e,t)=>(e.trip.leftTile=this.lon2tile(e.left=Math.min(e.left,t.longitude)),e.trip.rightTile=this.lon2tile(e.right=Math.max(e.right,t.longitude)),e.trip.topTile=this.lat2tile(e.top=Math.min(e.top,t.latitude)),e.trip.bottomTile=this.lat2tile(e.bottom=Math.max(e.bottom,t.latitude)),e.trip.XTiles=e.trip.rightTile-e.trip.leftTile+1,e.trip.YTiles=e.trip.topTile-e.trip.bottomTile+1,e.margin.bottom=Math.floor((e.maxYTiles-e.trip.YTiles)/2),e.margin.top=e.maxYTiles-e.trip.YTiles-e.margin.bottom,e.margin.left=Math.floor((e.maxXTiles-e.trip.XTiles)/2),e.margin.right=e.maxXTiles-e.trip.XTiles-e.margin.left,e.leftTile=e.trip.leftTile-Math.abs(e.margin.left),e.rightTile=Math.max(e.maxXTiles+e.trip.leftTile,e.trip.rightTile+Math.abs(e.margin.right)),e.bottomTile=e.trip.bottomTile-Math.abs(e.margin.bottom),e.topTile=Math.max(e.maxYTiles+e.trip.bottomTile,e.trip.bottomTile+Math.abs(e.margin.top)),e.points.push(this.pointToCartesian(t)),e)),{left:this.props.points[0].longitude,right:this.props.points[0].longitude,top:this.props.points[0].latitude,bottom:this.props.points[0].latitude,trip:{},margin:{},points:[],margin:[],maxXTiles:Math.ceil(window.innerWidth/256),maxYTiles:Math.ceil(window.innerHeight/256)})):t({error:"no points"})))}setupListeners(e,t){this.widget.addEventListener("mousemove",(s=>{var i=t.points.find((e=>this.getClientX(e,t)>=s.offsetX-5&&this.getClientX(e,t)<=s.offsetX+5&&this.getClientY(e,t)>=s.offsetY-5&&this.getClientY(e,t)<=s.offsetY+5)),a=!1;t.points.filter((e=>e!=i)).forEach((e=>{e.focused&&(e.focused=!1,a=!0)})),a?this.drawMap().then((s=>{i&&!i.focused&&(i.focused=!0,this.drawPointPopup(e,i,t))})):i&&!i.focused&&(i.focused=!0,this.drawPointPopup(e,i,t))}))}drawPointPopup(e,t,s){e.font="10px Helvetica";var i=e.measureText(new Date(`${t.timestamp} UTC`).toLocaleString()),a=i.width+10;e.strokeStyle="#00ffff",e.shadowColor="#00ffff",e.fillStyle="#ffffff",e.lineWidth=1,e.shadowBlur=2,e.beginPath(),e.rect(this.getClientX(t,s),this.getClientY(t,s)-60,a,60),e.fill(),e.stroke(),e.fillStyle="rgba(00, 0, 0, 1)",e.strokeStyle="#000000",e.beginPath();var n=this.getClientY(t,s)-60+i.actualBoundingBoxAscent+3,r=this.getClientX(t,s)+3;e.fillText(new Date(`${t.timestamp} UTC`).toLocaleString(),r,n),n+=i.actualBoundingBoxAscent+3,e.fillText(`Bat: ${Math.floor(t.Battery)}`,r,n),n+=i.actualBoundingBoxAscent+3,e.fillText(`Sats: ${t.Satellites}`,r,n),n+=i.actualBoundingBoxAscent+3,e.fillText(`Speed:${Math.floor(1.852*t.speed/100)} km/h`,r,n),n+=i.actualBoundingBoxAscent+3,e.fillText(`Alt:${Math.floor(t.altitude/100)} m`,r,n),e.stroke()}drawTrip(e){var t=e.points[0];this.canvas.strokeStyle="#00ffff",this.canvas.shadowColor="#00ffff",this.canvas.fillStyle="#00ffff",this.canvas.lineWidth=2,this.canvas.shadowBlur=2,this.canvas.beginPath(),this.canvas.moveTo(this.getClientX(t,e),this.getClientY(t,e)),e.points.forEach((t=>{this.canvas.lineTo(this.getClientX(t,e),this.getClientY(t,e))})),this.canvas.stroke(),this.canvas.strokeStyle="#0000ff",this.canvas.shadowColor="#0000ff",this.canvas.fillStyle="#0000ff",e.points.forEach((t=>{this.canvas.beginPath(),this.canvas.arc(256*(t.tileX-e.leftTile)+256*t.posTileX,256*(t.tileY-e.bottomTile)+256*t.posTileY,5,0,2*Math.PI),this.canvas.stroke()}))}getClientY(e,t){return 256*(e.tileY-t.bottomTile)+256*e.posTileY}getClientX(e,t){return 256*(e.tileX-t.leftTile)+256*e.posTileX}drawTripTiles(e){this.widget.width=256*(e.trip.XTiles+Math.abs(e.margin.left+e.margin.right)),this.widget.height=256*(e.trip.YTiles+Math.abs(e.margin.bottom+e.margin.top)),this.canvas.fillStyle="black",this.canvas.fillRect(0,0,window.innerWidth,window.innerHeight),this.setupListeners(this.canvas,e);for(var t=[],s=e.leftTile;s<=e.rightTile;s++)for(var i=e.bottomTile;i<=e.topTile;i++)t.push(this.drawTile(s,i,0,e));return new Promise(((s,i)=>Promise.all(t).then((t=>s(e))).catch((t=>s(e)))))}drawTile(e,t,s,i){return new Promise(((a,n)=>{if(this.state.images[e]&&this.state.images[e][t])a(this.canvas.drawImage(this.state.images[e][t],this.state.images[e][t].posX*this.state.images[e][t].width,this.state.images[e][t].posY*this.state.images[e][t].height));else{var r=new Image;r.posX=e-i.leftTile,r.posY=t-i.bottomTile,r.onload=s=>{this.state.images[e]||(this.state.images[e]={}),this.state.images[e][t]=s.currentTarget,a(this.canvas.drawImage(s.currentTarget,s.currentTarget.posX*s.currentTarget.width,s.currentTarget.posY*s.currentTarget.height))},r.onerror=r=>{s>3?n(`Failed to fetch tile ${e},${t}`):this.drawTile(e,t,s+1,i).then(a).catch(n)},r.src=`${httpPrefix}/sdcard/web/tiles/${e}/${t}.png`}}))}lon2tile(e){return Math.floor(this.lon2x(e))}lat2tile(e){return Math.floor(this.lat2y(e))}lon2x(e){return(e+180)/360*Math.pow(2,this.zoomlevel)}lat2y(e){return(1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,this.zoomlevel)}tile2long(e,t){return e/Math.pow(2,t)*360-180}tile2lat(e,t){var s=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(s)-Math.exp(-s)))}pointToCartesian(e){return{tileX:this.lon2tile(e.longitude,this.zoomlevel),tileY:this.lat2tile(e.latitude,this.zoomlevel),posTileX:this.lon2x(e.longitude,this.zoomlevel)-this.lon2tile(e.longitude,this.zoomlevel),posTileY:this.lat2y(e.latitude,this.zoomlevel)-this.lat2tile(e.latitude,this.zoomlevel),...e}}closeIt(){this.setState({closed:!0})}render(){return e("div",{key:genUUID(),className:"lightbox "+(this.state?.closed?"closed":"opened")},[e("div",{key:genUUID()},[e("div",{key:genUUID(),className:"tripHeader"},[`Trip with ${this.props.points.length} points`,e("br"),`From ${new Date(`${this.props.points[0].timestamp} UTC`).toLocaleString()} `,`To ${new Date(`${this.props.points[this.props.points.length-1].timestamp} UTC`).toLocaleString()}`]),e("span",{key:genUUID(),className:"close",onClick:this.closeIt.bind(this)},"X")]),e("div",{key:genUUID(),className:"trip"},e("canvas",{onresize:this.drawMap(),key:genUUID(),ref:e=>this.widget=e}))])}}var app=null;function wfetch(e,t){return new Promise(((s,i)=>{var a=getInSpot(app.anims.filter((e=>"post"==e.type&&"browser"==e.from)),"browser"),n=a;a?a.weight++:app.anims.push(n={type:"post",from:"browser",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:5,renderer:app.drawSprite}),fetch(e,t).then((e=>{var t=getInSpot(app.anims.filter((e=>"post"==e.type&&"chip"==e.from)),"chip");t?t.weight++:app.anims.push({type:"post",from:"chip",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:25,renderer:app.drawSprite}),s(e)})).catch((e=>{n.color="red",n.lineColor="red",i(e)}))}))}class MainApp extends React.Component{constructor(e){super(e),this.anims=[],app=this,this.state={pageControler:this.GetPageControler(),selectedDeviceId:"current",httpPrefix:httpPrefix,tabs:{Storage:{active:!0},Status:{active:!1},Config:{active:!1},Logs:{active:!1},Events:{active:!1}},autoRefresh:!(!httpPrefix&&!window.location.hostname)},httpPrefix||window.location.hostname||this.lookForDevs(),this.state?.autoRefresh&&(httpPrefix||window.location.hostname)&&this.openWs()}componentDidUpdate(e,t,s){}componentDidMount(){app=this,this.mountWidget(),this.mounted=!0}componentWillUnmount(){this.mounted=!1}lookForDevs(){this.state.lanDevices=[];for(var e=254;e>0;e--)this.state.lanDevices.push(`192.168.1.${e}`);this.state.lanDevices=this.state.lanDevices.sort((()=>.5-Math.random()));var t=[];for(e=0;e<Math.min(10,this.state.lanDevices.length);e++)this.state.lanDevices.length&&this.scanForDevices(this.state.lanDevices,t)}scanForDevices(e,t){if(e.length){var s=e.pop(),i=new AbortController,a=setTimeout((()=>i.abort()),1e3);wfetch(`http://${s}/config/`,{method:"post",signal:i.signal}).then((e=>(clearTimeout(a),!0,e.json()))).then(fromVersionedToPlain).then((s=>{if(s?.deviceid){var i=getInSpot(this.anims.filter((e=>"ping"==e.type&&"chip"==e.from)),"chip");i?i.weight++:this.anims.push({type:"ping",from:"chip",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:30,renderer:this.drawSprite}),t.push(s),httpPrefix||(httpPrefix=`http://${t[0].devName}`,this.state.autoRefresh=!0,this.state.connecting||this.state.connected||this.openWs()),this.setState({OnLineDevices:t})}e.length&&this.scanForDevices(e,t)})).catch((s=>{e.length&&this.scanForDevices(e,t)}))}}mountWidget(){this.widget.addEventListener("click",(e=>{e.offsetX>2&&e.offsetX<32&&e.offsetY>2&&e.offsetY<32&&(this.state.autoRefresh=!this.state.autoRefresh,this.state.autoRefresh?this.openWs():this.closeWs())})),this.mounted||window.requestAnimationFrame(this.drawDidget.bind(this))}closeWs(){this.ws&&(this.state.autoRefresh=!1,this.ws.close(),this.ws=null)}openWs(){if((window.location.hostname||httpPrefix)&&!this.state?.connecting&&!this.state?.connected){this.state.connecting=!0,this.state.running=!1;var e=this.ws=new WebSocket("ws://"+(""==httpPrefix?window.location.hostname:httpPrefix.substring(7))+"/ws"),t=setTimeout((()=>{e.close(),this.state.connecting=!1}),3e3);e.onmessage=s=>{clearTimeout(t),this.state.running&&!this.state.timeout||(this.state.running=!0,this.state.error=null,this.state.timeout=null),s&&s.data&&("{"==s.data[0]?s.data.startsWith('{"eventBase"')?this.ProcessEvent(fromVersionedToPlain(JSON.parse(s.data))):this.UpdateState(fromVersionedToPlain(JSON.parse(s.data))):s.data.match(/.*\) ([^:]*)/g)&&this.AddLogLine(s.data)),t=setTimeout((()=>{this.state.timeout="Message",e.close()}),3e3)},e.onopen=()=>{clearTimeout(t),this.state.connected=!0,this.state.connecting=!1,e.send("Connected"),t=setTimeout((()=>{this.state.timeout="Connect",e.close()}),3e3)},e.onerror=s=>{clearTimeout(t),this.state.error=s,e.close()},e.onclose=e=>{clearTimeout(t),this.state.connected=!1,this.state.connecting=!1,this.state.autoRefresh&&this.openWs()}}}drawDidget(){if(this.widget){var e=this.widget.getContext("2d");if(e.clearRect(0,0,100,40),this.browser(e,2,2,30,30,10),this.chip(e,70,2,20,30,5),this.anims.length){var t=this.anims.reduce(((e,t)=>((e[t.type]=e[t.type]||[]).push(t),e)),{});for(var s in t)e.beginPath(),t[s].forEach((t=>{this.drawSprite(t,e)}));this.anims=this.anims.filter((e=>2!=e.state))}window.requestAnimationFrame(this.drawDidget.bind(this))}}drawSprite(e,t){e.state?e.x+=2*e.direction:(e.state=1,e.x="chip"==e.from?this.chipX:this.browserX,e.endX="chip"==e.from?this.browserX:this.chipX,e.direction="browser"==e.from?1:-1,e.y=e.startY);var s=Math.min(15,4+e.weight);if(e.y-s/2<=0&&(e.y=s),t.strokeStyle=e.lineColor,t.lineWidth=1,t.shadowBlur=1,t.shadowColor=e.shadowColor,t.fillStyle=e.color,t.moveTo(e.x+s,e.y),t.arc(e.x,e.y,s,0,2*Math.PI),"browser"!=e.from&&"log"!=e.type||t.fill(),e.weight>1){var i=""+e.weight;t.font=Math.min(20,8+e.weight)+"px Helvetica";var a=t.measureText(i);"browser"!=e.from&&"log"!=e.type||(t.strokeStyle="black",t.fillStyle="black"),t.fillText(i,e.x-a.width/2,e.y+a.actualBoundingBoxAscent/2),"browser"!=e.from&&"log"!=e.type||(t.strokeStyle=e.lineColor,t.fillStyle=e.color)}return t.stroke(),(1==e.direction?e.x>e.endX:e.x<e.endX)&&(e.state=2),e}browser(e,t,s,i,a,n){this.browserX=t+i,e.beginPath(),e.strokeStyle="#00ffff",e.lineWidth=2,e.shadowBlur=2,e.shadowColor="#00ffff",e.fillStyle=this.state?.autoRefresh?this.state?.error||this.state?.timeout?"#f27c7c":this.state?.connected?"#00ffff59":"#0396966b":"#000000",this.roundedRectagle(e,t,s,i,a,n),e.fill(),this.state?.lanDevices?.length&&this.roundedRectagle(e,t,s,i,a*(this.state.lanDevices.length/254),n),e.stroke()}chip(e,t,s,i,a,n){this.chipX=t,e.beginPath();e.strokeStyle="#00ffff",e.lineWidth=2,e.shadowBlur=2,e.shadowColor="#00ffff",e.fillStyle="#00ffff",this.roundedRectagle(e,t,s,i,a,n);for(var r=0;r<3;r++)e.moveTo(t,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t-4,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t-4,1.5*n+2+s+r*((a-2*n)/3)),e.lineTo(t,1.5*n+2+s+r*((a-2*n)/3)),e.moveTo(t+i,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t+i+4,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t+i+4,1.5*n+2+s+r*((a-2*n)/3)),e.lineTo(t+i,1.5*n+2+s+r*((a-2*n)/3));e.stroke()}roundedRectagle(e,t,s,i,a,n){e.moveTo(t+n,s),e.lineTo(t+i-2*n,s),e.arcTo(t+i,s,t+i,s+n,n),e.lineTo(t+i,s+a-n),e.arcTo(t+i,s+a,t+i-n,s+a,n),e.lineTo(t+n,s+a),e.arcTo(t,s+a,t,s+a-n,n),e.lineTo(t,s+n),e.arcTo(t,s,t+n,s,n)}AddLogLine(e){var t=getInSpot(this.anims.filter((t=>"log"==t.type&&t.level==e[0])),"chip");t?t.weight++:this.anims.push({type:"log",from:"chip",level:e[0],color:"D"==e[0]?"green":"W"==e[0]?"yellow":"red",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:25,renderer:this.drawSprite}),this.callbacks.logCBFn.forEach((t=>t(e)))}UpdateState(e){var t=getInSpot(this.anims.filter((e=>"state"==e.type)),"chip");t?t.weight++:this.anims.push({type:"state",from:"chip",color:"#00ffff",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:5,renderer:this.drawSprite}),this.callbacks.stateCBFn.forEach((t=>t(e)))}ProcessEvent(e){var t=getInSpot(this.anims.filter((e=>"event"==e.type)),"chip");t?t.weight++:this.anims.push({type:"event",from:"chip",eventBase:e.eventBase,color:"#7fffd4",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:15,renderer:this.drawSprite}),this.callbacks.eventCBFn.forEach((t=>t.fn(e)))}GetPageControler(){var e=new AbortController;return e.onabort=this.OnAbort,e}OnAbort(){this.state.pageControler=this.GetPageControler()}setActiveTab(e){this.state.tabs[e].active=!0,Object.keys(this.state.tabs).filter((t=>t!=e)).forEach((e=>this.state.tabs[e].active=!1)),this.refreshActiveTab()}refreshActiveTab(){Object.keys(this.state.tabs).forEach((e=>{var t=document.getElementById(`${e}`),s=document.getElementById(`a${e}`);this.state.tabs[e].active?(s.classList.add("active"),t&&t.classList.add("active"),"Config"==e||"Status"==e||"Events"==e?(document.getElementById("controls").classList.remove("hidden"),document.querySelector("div.slides").classList.remove("expanded")):(document.getElementById("controls").classList.add("hidden"),document.querySelector("div.slides").classList.add("expanded"))):(s.classList.remove("active"),t.classList.remove("active"))}))}registerStateCallback(e){this.callbacks.stateCBFn.find((t=>t.name==e.name))||this.callbacks.stateCBFn.push(e)}registerLogCallback(e){this.callbacks.logCBFn.find((t=>t.name==e.name))||this.callbacks.logCBFn.push(e)}registerEventInstanceCallback(e,t){var s=null;(s=this.callbacks.eventCBFn.find((s=>s.fn.name==e.name&&s.instance===t)))?s.fn=e:this.callbacks.eventCBFn.push({fn:e,instance:t})}registerEventCallback(e){this.callbacks.eventCBFn.find((t=>t.fn.name==e.name&&void 0===t.instance))||this.callbacks.eventCBFn.push({fn:e})}getPage(t){return"Storage"==t?e(StorageViewer,{pageControler:this.state.pageControler,active:this.state.tabs.Storage.active}):"Status"==t?e(MainAppState,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Status.active,registerEventInstanceCallback:this.registerEventInstanceCallback.bind(this),registerStateCallback:this.registerStateCallback.bind(this)}):"Config"==t?e(ConfigPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Config.active}):"Logs"==t?e(SystemPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Logs.active,registerLogCallback:this.registerLogCallback.bind(this)}):"Events"==t?e(EventsPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Events.active,registerEventCallback:this.registerEventCallback.bind(this)}):null}ReloadPage(){this.setState({pageControler:this.GetPageControler()})}render(){return this.callbacks={stateCBFn:[],logCBFn:[],eventCBFn:[]},e("div",{key:genUUID(),className:"mainApp"},[e("fieldset",{key:genUUID(),className:"slides",id:"controls"},[this.state?.OnLineDevices?.length&&!window.location.hostname?e("select",{key:genUUID(),className:"landevices",value:httpPrefix.substring(7),onChange:e=>{httpPrefix=`http://${e.target.value}`,this.state?.httpPrefix!=httpPrefix&&this.setState({httpPrefix:httpPrefix}),this.ws?.close()}},this.state.OnLineDevices.map((t=>e("option",{key:genUUID(),className:"landevice"},t.devName)))):null,e("canvas",{key:genUUID(),height:40,width:100,ref:e=>this.widget=e}),e(DeviceList,{key:genUUID(),selectedDeviceId:this.state.selectedDeviceId,httpPrefix:httpPrefix,onSet:e=>this.state?.selectedDeviceId!=e?this.setState({selectedDeviceId:e}):null})]),Object.keys(this.state.tabs).map((t=>e("details",{key:genUUID(),id:t,className:"appPage slides",open:this.state.tabs[t].active,onClick:e=>{e.target.parentElement.setAttribute("open",!0),Object.keys(this.state.tabs).forEach((e=>this.state.tabs[e].active=e==t)),[].slice.call(e.target.parentElement.parentElement.children).filter((t=>t!=e)).forEach((e=>e.removeAttribute("open")))}},[e("summary",{key:genUUID(),className:"appTab"},t),e("div",{key:genUUID(),className:"Status"==t?"pageContent system-config":"pageContent"},this.getPage(t))])))])}}function getInSpot(e,t){return e.filter((e=>e.from==t)).find((e=>void 0===e.x||("browser"==t?e.x<=app.browserX+4+e.weight:e.x>=app.chipX-4-e.weight)))}ReactDOM.render(e(MainApp,{key:genUUID(),className:"slider"}),document.querySelector(".slider"));