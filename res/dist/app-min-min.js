"use strict";const e=React.createElement;var httpPrefix="",hexcase=0,b64pad="";function hex_sha1(e){return rstr2hex(rstr_sha1(str2rstr_utf8(e)))}function hex_hmac_sha1(e,t){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(e){return binb2rstr(binb_sha1(rstr2binb(e),8*e.length))}function rstr_hmac_sha1(e,t){var s=rstr2binb(e);s.length>16&&(s=binb_sha1(s,8*e.length));for(var i=Array(16),a=Array(16),n=0;n<16;n++)i[n]=909522486^s[n],a[n]=1549556828^s[n];var r=binb_sha1(i.concat(rstr2binb(t)),512+8*t.length);return binb2rstr(binb_sha1(a.concat(r),672))}function rstr2hex(e){try{}catch(e){hexcase=0}for(var t,s=hexcase?"0123456789ABCDEF":"0123456789abcdef",i="",a=0;a<e.length;a++)t=e.charCodeAt(a),i+=s.charAt(t>>>4&15)+s.charAt(15&t);return i}function str2rstr_utf8(e){for(var t,s,i="",a=-1;++a<e.length;)t=e.charCodeAt(a),s=a+1<e.length?e.charCodeAt(a+1):0,55296<=t&&t<=56319&&56320<=s&&s<=57343&&(t=65536+((1023&t)<<10)+(1023&s),a++),t<=127?i+=String.fromCharCode(t):t<=2047?i+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?i+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(i+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return i}function rstr2binb(e){for(var t=Array(e.length>>2),s=0;s<t.length;s++)t[s]=0;for(s=0;s<8*e.length;s+=8)t[s>>5]|=(255&e.charCodeAt(s/8))<<24-s%32;return t}function binb2rstr(e){for(var t="",s=0;s<32*e.length;s+=8)t+=String.fromCharCode(e[s>>5]>>>24-s%32&255);return t}function binb_sha1(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var s=Array(80),i=1732584193,a=-271733879,n=-1732584194,r=271733878,o=-1009589776,l=0;l<e.length;l+=16){for(var h=i,p=a,d=n,c=r,m=o,u=0;u<80;u++){s[u]=u<16?e[l+u]:bit_rol(s[u-3]^s[u-8]^s[u-14]^s[u-16],1);var g=safe_add(safe_add(bit_rol(i,5),sha1_ft(u,a,n,r)),safe_add(safe_add(o,s[u]),sha1_kt(u)));o=r,r=n,n=bit_rol(a,30),a=i,i=g}i=safe_add(i,h),a=safe_add(a,p),n=safe_add(n,d),r=safe_add(r,c),o=safe_add(o,m)}return Array(i,a,n,r,o)}function sha1_ft(e,t,s,i){return e<20?t&s|~t&i:e<40?t^s^i:e<60?t&s|t&i|s&i:t^s^i}function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function safe_add(e,t){var s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function bit_rol(e,t){return e<<t|e>>>32-t}function genUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}function dirname(e){return(e.match(/.*\//)+"").replace(/(.+)\/$/g,"$1")}function isFloat(e){return Number(e)===e&&e%1!=0}function IsDatetimeValue(e){return e.match(".*ime_.s$")||e.match(".*ime_sec$")}function IsBooleanValue(e){return"true"==e||"yes"==e||!0===e||"false"==e||"no"==e||!1===e}function IsNumberValue(e){return!0!==e&&!1!==e&&"string"!=typeof e&&!isNaN(e)&&""!==e}function degToRad(e){return e*(Math.PI/180)}function fromVersionedToPlain(e,t=""){var s,i={},a=Object.keys(e);for(s in a){var n=a[s],r=!1;"object"==typeof e[n]&&2==Object.keys(e[n]).filter((e=>!(r|=!("version"==e||"value"==e)))).length?i[n]=e[n].value:Array.isArray(e[n])?(i[n]=[],e[n].forEach(((s,a)=>{e[n][a].boper?i[n][i[n].length-1].boper=e[n][a].boper:i[n].push(fromVersionedToPlain(s,`${t}/${n}[${a}]`))}))):"object"==typeof e[n]?i[n]=fromVersionedToPlain(e[n],`${t}/${n}`):i[n]=e[n]}return i}function fromPlainToVersionned(e,t,s=""){var i={},a=Object.keys(e);for(var n in a){var r=a[n],o=t?t[r]:void 0;if(Array.isArray(e[r])){i[r]=[];for(var l=0;l<e[r].length;l++){var h=fromPlainToVersionned(e[r][l],o?o[l]:null,`${s}/${r}[${l}]`);i[r].push(h),h.boper&&(i[r].push({boper:h.boper}),delete h.boper)}}else"object"==typeof e[r]?i[r]=fromPlainToVersionned(e[r],o,`${s}/${r}`):i[r]="boper"===r||"operator"===r||"otype"===r||"value"===r||"name"===r?e[r]:{version:void 0===o?0:e[r]===o.value?o.version:o.version+1,value:e[r]}}return i}const getCellValue=(e,t)=>e.children[t].innerText||e.children[t].textContent,comparer=(e,t)=>(s,i)=>{return a=getCellValue(t?s:i,e),n=getCellValue(t?i:s,e),""===a||""===n||isNaN(a)||isNaN(n)?a.toString().localeCompare(n):a-n;var a,n};class BoolInput extends React.Component{constructor(e){super(e),this.id=this.props.id||genUUID(),this.props.onOn&&this.props.initialState&&this.props.onOn(),this.props.onOff&&!this.props.initialState&&this.props.onOff()}toggleChange=e=>{e.target.checked?this.props.onOn&&this.props.onOn(e.target):this.props.onOff&&this.props.onOff(e.target),this.props.onChange&&this.props.onChange(e.target.checked)};render(){return e("label",{key:genUUID(),className:"editable "+(this.props.blurred?"loading":""),id:`lbl${this.id}`,key:this.id},e("div",{key:genUUID(),className:"label",id:`dlbl${this.id}`},this.props.label),e("input",{key:genUUID(),type:"checkbox",onChange:this.toggleChange,id:`in${this.id}`,checked:this.props.initialState}))}}class CmdButton extends React.Component{runIt(){wfetch(`${httpPrefix}/status/cmd`,{method:this.props.HTTP_METHOD,body:JSON.stringify({command:this.props.command,name:this.props.name,param1:this.props.param1,param2:this.props.param2})}).then((e=>e.text())).then(this.props.onSuccess?this.props.onSuccess:console.log).catch(this.props.onError?this.props.onError:console.error)}render(){return e("button",{key:genUUID(),onClick:this.runIt.bind(this)},this.props.caption)}}class DeviceList extends React.Component{getDevices(){(window.location.host||httpPrefix)&&wfetch(`${httpPrefix}/files/lfs/config`,{method:"post"}).then((e=>e.json())).then((e=>e.filter((e=>"file"==e.ftype)))).then((e=>{var t=e.map((e=>e.name.substr(0,e.name.indexOf("."))));this.setState({devices:t,httpPrefix:httpPrefix}),this.props?.onGotDevices&&this.props.onGotDevices(t)})).catch((e=>{this.setState({error:e})}))}componentDidMount(){this.getDevices()}componentDidUpdate(e,t,s){e?.httpPrefix!=this.props.httpPrefix&&this.getDevices(this.props.httpPrefix)}render(){return this.state?.devices?.length>1?e("select",{key:genUUID(),value:this.props.selectedDeviceId,onChange:e=>this.props?.onSet(e.target.value)},(this.state?.devices||this.props.devices).map((t=>e("option",{key:genUUID(),value:t},t)))):null}}class IntInput extends React.Component{toggleChange=e=>{this.props.onChange&&this.props.onChange(e.target.value)};render(){return e("label",{key:genUUID(),className:"editable",id:`lbl${this.id}`,key:this.id},e("div",{key:genUUID(),className:"label",id:`div${this.id}`},this.props.label),e("input",{key:genUUID(),type:"number",value:this.props.defaultValue,onChange:this.toggleChange.bind(this),id:`${this.id}`}))}}class StateCommands extends React.Component{render(){return e("div",{key:"commands",name:"commands",className:"commands"},this.props.commands.map((t=>e(CmdButton,{key:genUUID(),caption:t.caption||t.command,command:t.command,name:this.props.name,onSuccess:this.props.onSuccess,onError:this.props.onError,param1:t.param1,param2:t.param2,HTTP_METHOD:t.HTTP_METHOD}))))}}class EditableLabel extends React.Component{constructor(e){super(e),this.state={editing:!1}}getLabel(){return e("div",{onClick:e=>this.setState({editing:!0}),className:"label"},this.props.label)}updateLabel(e){this.newLabel=e.target.value}cancelUpdate(e){this.newLabel=void 0,this.setState({editing:!1})}getEditable(){return[e("input",{key:"edit",defaultValue:this.props.label,onChange:this.updateLabel.bind(this)}),e("div",{key:"ok",onClick:e=>this.setState({editing:!1}),className:"ok-button",dangerouslySetInnerHTML:{__html:"&check;"}}),e("div",{key:"cancel",onClick:this.cancelUpdate.bind(this),className:"cancel-button",dangerouslySetInnerHTML:{__html:"&Chi;"}})]}componentDidUpdate(e,t,s){this.props.onChange&&this.newLabel&&t.editing!==this.state.editing&&this.props.onChange(this.newLabel,this.props.label)}render(){return this.state.editing?this.getEditable():this.getLabel()}}class LocalJSONEditor extends React.Component{constructor(e){super(e),this.state={json:e.json},this.props.registerEventInstanceCallback&&this.props.name&&this.props.registerEventInstanceCallback(this.ProcessEvent.bind(this),`${this.props.class}-${this.props.name}`)}componentWillUnmount(){this.mounted=!1}componentDidMount(){this.mounted=!0}componentDidUpdate(e,t,s){e&&e.json&&e.json!=this.props.json&&this.setState({json:this.props.json})}ProcessEvent(e){this.mounted&&e?.data&&e.data?.name==this.props.name&&this.setState({json:e.data})}removeField(e){delete this.state.json[e],this.setState({value:this.state.json})}changeLabel(e,t){e!==t&&(Object.defineProperty(this.state.json,e,Object.getOwnPropertyDescriptor(this.state.json,t)),delete this.state.json[t])}fieldControlPannel(t){return this.props.editable?e("div",{key:`fcpnolabel${t}header`,className:"fieldHeader"},[e(EditableLabel,{key:`flabel${t}`,label:t,onChange:this.changeLabel.bind(this)}),e("div",{key:`fcpnolabel${t}popupmenu`,className:"popupMenu"},[e("div",{key:"removefield",onClick:e=>this.removeField(t)},"Remove")])]):e("div",{key:`fcpnolabel${t}`,className:"label",id:`dlbl${this.id}`},t)}Parse(t){return void 0!==t&&null!=t?"object"==typeof t&&void 0===t.version?e("div",{key:"jsonobject",className:"statusclass jsonNodes"},this.getSortedProperties(t).map((s=>Array.isArray(t[s])?"commands"==s?{fld:s,element:e(StateCommands,{key:"jofieldcmds",name:t.name,commands:t[s],onSuccess:this.props.updateAppStatus})}:{fld:s,element:e(Table,{key:`Table-Object-${this.props.path}/${s}`,name:s,path:`${this.props.path}/${s}`,label:s,json:t[s],registerEventInstanceCallback:this.props.registerEventInstanceCallback,editable:this.props.editable,sortable:this.props.sortable})}:t[s]&&"object"==typeof t[s]&&void 0===t[s].version?{fld:s,element:e(LocalJSONEditor,{key:`JE-${this.props.path}/${s}`,path:`${this.props.path}/${s}`,name:s,label:s,editable:this.props.editable,json:t[s],updateAppStatus:this.props.updateAppStatus,registerEventInstanceCallback:this.props.registerEventInstanceCallback})}:"class"==s||"name"==s&&t.name==t.class?void 0:{fld:s,element:this.props.editable?e("label",{key:`${s}label`},[this.fieldControlPannel(s),e("input",{key:"input",defaultValue:void 0===t[s].value?t[s]:t[s].value,onChange:this.processUpdate.bind(this)})]):e(ROProp,{key:`rofld${s}`,value:t[s],name:s,label:s})})).reduce(((e,s)=>{if(s){var i=this.getFieldClass(t,s.fld),a=e.find((e=>e.fclass==i));a?a.elements.push(s.element):e.push({fclass:i,elements:[s.element]})}return e}),[]).map(((t,s)=>e("div",{key:`fg-${t.fclass}`,className:`fieldgroup ${t.fclass}`},t.elements)))):void 0!==t.version||this.props.editable&&"object"!=typeof t?e("input",{key:"input",defaultValue:void 0===t.value?t:t.value,onChange:this.processUpdate.bind(this)}):e(ROProp,{key:"rofield",value:t,name:""}):null}processUpdate(e,t){t?(void 0===this.state.json[t]&&(this.state.json[t]={version:-1}),this.state.json[t].value=e.target.value,this.state.json[t].version++):(this.state.json.value=e.target.value,this.state.json.version++)}getSortedProperties(e){return Object.keys(e).sort(((t,s)=>{var i=this.getFieldWeight(e,t),a=this.getFieldWeight(e,s);return i==a?t.localeCompare(s):i>a?1:a>i?-1:0})).filter((t=>!e[t]||!("object"==typeof e[t]&&0==Object.keys(e[t]).filter((e=>"class"!=e&&"name"!=e)).length)))}getFieldWeight(e,t){return IsDatetimeValue(t)||e&&void 0!==e[t]?Array.isArray(e[t])?6:"object"==typeof e[t]?e[t]&&e[t].commands?4:5:IsDatetimeValue(t)?1:3:2}getFieldClass(e,t){return e&&e[t]?Array.isArray(e[t])?"array":"object"==typeof e[t]&&void 0===e[t].version?e[t].commands?"commandable":"object":"field":"field"}addNewProperty(){this.state.json[`prop${Object.keys(this.state.json).filter((e=>e.match(/^prop.*/))).length+1}`]=null,this.setState({value:this.state.json})}objectControlPannel(){return[e("div",{key:"ocplabel",className:"jsonlabel"},this.props.label),this.props.editable?e("div",{key:genUUID(),className:"popupMenu"},e("div",{key:"removeprop",onClick:e=>this.addNewProperty()},"Add Column")):null]}render(){return null===this.state.json||void 0===this.state.json?e("div",{id:`loading${this.id}`},"Loading..."):null!=this.props.label?e("fieldset",{id:`fs${this.props.label}`,className:"jsonNodes"},[e("legend",{key:"legend"},this.objectControlPannel()),this.Parse(this.state.json)]):this.Parse(this.state.json)}}class ROProp extends React.Component{constructor(e){super(e),this.id=this.props.id||genUUID(),IsNumberValue(this.props.value)&&(this.state={maxLastStates:50,lastStates:[{value:this.props.value,ts:Date.now()}]})}getValue(t,s){return void 0!==s?.value?this.getValue(t,s.value):(IsNumberValue(s)&&isFloat(s)&&(s="lattitude"!=this.props.name.toLowerCase()&&"longitude"!=this.props.name.toLowerCase()&&"lat"!=this.props.name&&"lng"!=this.props.name?parseFloat(s).toFixed(2):parseFloat(s).toFixed(8)),IsBooleanValue(s)&&(s="true"==s||"yes"==s||!0===s?"Y":"N"),"name"==this.props.name&&s.match(/\/.*\.[a-z]{3}$/)?e("a",{href:`${httpPrefix}${s}`},s.split("/").reverse()[0]):s)}componentDidUpdate(e,t,s){if(IsDatetimeValue(this.props.name)&&this.renderTime(document.getElementById(`vel${this.id}`),this.props.name,this.getValue(this.props.name,this.props.value)),this.state?.lastStates&&this.props.value!==e?.value)for(this.state.lastStates.push({value:this.props.value,ts:Date.now()});this.state.lastStates.length>this.state.maxLastStates;)this.state.lastStates.pop()}renderTime(e,t,s){if(null!=e){var i=t.endsWith("_us")?new Date(s/1e3):t.endsWith("_sec")?new Date(1e3*s):new Date(s);i.getFullYear()<=1970&&i.setTime(i.getTime()+60*i.getTimezoneOffset()*1e3);var a=i.toLocaleDateString("en-US",{dateStyle:"short"}),n=i.toLocaleTimeString("en-US",{hour12:!1}),r=i.getHours(),o=i.getMinutes(),l=i.getSeconds(),h=i.getMilliseconds(),p=o+(l+h/1e3)/60;i.getFullYear()<=1970&&(a=i.getDate()-1+" Days",n=0==r?(o?o+":":"")+("0"+l).slice(-2)+"."+h:("0"+r).slice(-2)+":"+("0"+o).slice(-2)+":"+("0"+l).slice(-2));var d=e.querySelector("canvas")||e.appendChild(document.createElement("canvas"));d.height=100,d.width=110;var c=d.getContext("2d");c.strokeStyle="#00ffff",c.lineWidth=4,c.shadowBlur=2,c.shadowColor="#00ffff";var m=e.getBoundingClientRect();m.height=d.height,m.width=d.width;var u=c.createRadialGradient(m.width/2,m.height/2,5,m.width/2,m.height/2,m.height+5);u.addColorStop(0,"#03303a"),u.addColorStop(1,"black"),c.fillStyle=u,c.clearRect(0,0,m.width,m.height),c.beginPath(),c.arc(m.width/2,m.height/2,.44*m.height,degToRad(270),degToRad(270+30*(r>12?r-12:r))),c.stroke(),c.beginPath(),c.arc(m.width/2,m.height/2,.38*m.height,degToRad(270),degToRad(270+6*p)),c.stroke(),c.font="12px Helvetica",c.fillStyle="rgba(00, 255, 255, 1)";var g=c.measureText(a);c.fillText(a,m.width/2-g.width/2,.65*m.height),c.font="12px Helvetica",c.fillStyle="rgba(00, 255, 255, 1)",g=c.measureText(n),c.fillText(n,.5*m.width-g.width/2,.45*m.height)}}render(){return this.props.label?e("label",{className:"readonly",id:`lbl${this.id}`,key:this.id},[e("div",{key:"label",className:"label",id:`dlbl${this.id}`},this.props.label),e("div",{key:"value",className:"value",id:`vel${this.id}`},IsDatetimeValue(this.props.name)?"":this.getValue(this.props.name,this.props.value))]):e("div",{key:"timevalue",className:"value",id:`vel${this.id}`},IsDatetimeValue(this.props.name)?"":this.getValue(this.props.name,this.props.value))}}class Table extends React.Component{constructor(e){super(e),this.id=this.props.id||genUUID()}SortTable(e){var t;this.props.sortable&&Array.from((t=e.target.closest("table").querySelector("tbody")).querySelectorAll("tr:nth-child(n)")).sort(comparer(Array.from(e.target.parentNode.children).indexOf(e.target),this.asc=!this.asc)).forEach((e=>t.appendChild(e)))}BuildHeaderField(e){return e}addRow(e){e.stopPropagation(),e.preventDefault(),0==this.props.json.length||"object"==typeof this.props.json[0]?this.props.json.push({}):Array.isArray(this.props.json[0])?this.props.json.push([]):this.props.json.push(""),this.setState({json:this.props.json})}BuildTablePannel(){return this.props.editable?e("div",{key:genUUID(),className:"popupMenu"},e("div",{key:"removeprop",onClick:e=>this.addRow(e)},"Add Row")):null}BuildCaption(){return this.props.editable?e("caption",{key:"caption"},[e("div",{key:"table-panel",className:"objectButtons"},this.BuildTablePannel()),e("div",{key:"label",className:"jsonlabel"},this.props.label)]):e("caption",{key:"caption"},this.props.label)}getValue(t,s){return void 0!==s?.value?s.value:t.endsWith("_sec")&&s>1e7?new Date(1e3*s).toLocaleString():(IsNumberValue(s)&&isFloat(s)&&(s="lattitude"!=this.props.name.toLowerCase()&&"longitude"!=this.props.name.toLowerCase()&&"lat"!=this.props.name&&"lng"!=this.props.name?parseFloat(s).toFixed(2):parseFloat(s).toFixed(8)),IsBooleanValue(s)&&(s="true"==s||"yes"==s||!0===s?"Y":"N"),"name"==t&&s.match(/\/.*\.[a-z]{3}$/)?e("a",{href:`${httpPrefix}${s}`},s):s)}DeleteLine(e,t){t.stopPropagation(),t.preventDefault(),this.props.json.splice(e,1),this.setState({json:this.props.json})}DuplicateLine(e,t){t.stopPropagation(),t.preventDefault(),this.props.json.push(this.props.json[e]),this.setState({json:this.props.json})}BuildLinePannel(t){return this.props.editable?e("div",{key:"linepanel",className:"stackedMenu"},[e("div",{key:genUUID(),className:"popupMenu"},e("div",{key:"del",onClick:e=>this.DeleteLine(t,e)},"Delete")),e("div",{key:genUUID(),className:"popupMenu"},e("div",{key:"dup",onClick:e=>this.DuplicateLine(t,e)},"Duplicate"))]):null}BuildLine(t,s){return e("tr",{key:`row-${s}`},[[this.props.editable?e("td",{key:`row-${s}-panel`,className:"readonly"},this.BuildLinePannel(s)):null,this.cols.map((i=>e("td",{key:`row-${s}-${i}-cell-panel`,className:"readonly"},this.BuildCell(t,i))))]])}addString(e,t){e[t]={value:"",version:0},this.setState({json:this.props.json})}clearCell(e,t){e[t].value?e[t].value=null:e[t]=null,this.setState({json:this.props.json})}BuildCellControlPannel(t,s){if(this.props.editable){var i=t[s];return e("div",{key:genUUID(),className:"popupMenu"},i?e("div",{key:"addpropr",onClick:e=>this.clearCell(t,s)},"Set Null"):e("div",{key:"addpropr",onClick:e=>this.addString(t,s)},"Add String"))}return null}BuildCell(t,s){return[Array.isArray(t[s])?t[s].length?e(Table,{key:`Table-Array-Line-${this.props.path}/${s}`,path:`${this.props.path}/${s}`,editable:this.props.editable,sortable:this.props.sortable,name:s,json:t[s],name:s}):null:e(LocalJSONEditor,{key:`JE-${this.props.path}/${s}`,path:`${this.props.path}/${s}`,editable:this.props.editable,json:t[s],name:s,registerEventInstanceCallback:this.props.registerEventInstanceCallback}),this.BuildCellControlPannel(t,s)]}render(){return void 0===this.props.json?null:(this.cols=[],e("label",{key:"label",id:this.id,className:"table"},e("table",{key:"table",className:"greyGridTable"},[[e("thead",{key:"head",onClick:this.SortTable.bind(this)},e("tr",{key:"headrow"},[this.props.editable?e("th",{key:"header"}):null,...this.props.json.flatMap((e=>Object.keys(e))).filter(((e,t,s)=>void 0!==e&&s.indexOf(e)===t)).map((t=>{if(!this.cols.some((e=>t==e))){this.cols.push(t);var s=this.getValue(t,this.props.json[0][t]);this.sortedOn||Array.isArray(s)||"object"==typeof s||!isNaN(this.getValue(t,s))||(this.sortedOn=t)}return e("th",{key:`header-col-${t}`},this.BuildHeaderField(t))}))])),void 0!==this.props.label?this.BuildCaption():null],e("tbody",{key:"body"},this.props.sortable?this.props.json.sort(((e,t)=>(this.getValue(this.sortedOn,e[this.sortedOn])+"").localeCompare(this.getValue(this.sortedOn,t[this.sortedOn])+""))).map(this.BuildLine.bind(this)):this.props.json.map(this.BuildLine.bind(this)))])))}}class StatusPage extends React.Component{constructor(e){super(e),this.mounted=!1}componentWillUnmount(){this.mounted=!1}componentDidMount(){this.mounted=!0,this.updateAppStatus(),this.props.registerStateCallback&&this.props.registerStateCallback(this.refreshStatus.bind(this))}updateAppStatus(){this.updateStatuses([{url:"/status/"},{url:"/status/app"},{url:"/status/tasks",path:"tasks"}],{})}refreshStatus(e){this.mounted&&(e?this.filterProperties(e).then((e=>{const t=Object.keys(e);var s=this.state?.status||{};for(const i in t)s[t[i]]=e[t[i]];this.setState({status:s})})):this.updateAppStatus())}filterProperties(e){return new Promise(((t,s)=>{t(Object.keys(e).filter((t=>!t.match(/^MALLOC_.*/)||0!=e[t])).reduce(((t,s)=>(t[s]=e[s],t)),{}))}))}updateStatuses(e,t){if(window.location.host||httpPrefix){var s=new AbortController,i=setTimeout((()=>s.abort()),4e3);"current"==this.props.selectedDeviceId?Promise.all(e.map((i=>new Promise(((a,n)=>{wfetch(`${httpPrefix}${i.url}`,{method:"post",signal:s.signal}).then((e=>e.json())).then(this.filterProperties.bind(this)).then((s=>{e=e.filter((e=>e!=i)),i.path?t[i.path]=Object.values(s):Object.assign(t,s),a({path:i.path,stat:s})})).catch((e=>{i.retryCnt=1+(0|i.retryCnt),i.waitFor=1e3,i.error=e,n(e)}))}))))).then((e=>{clearTimeout(i),document.getElementById("Status").style.opacity=1,this.mounted&&this.setState({error:null,status:this.orderResults(t)})})).catch((s=>{if(clearTimeout(i),20!=s.code){var a=e.filter((e=>e.error));document.getElementById("Status").style.opacity=.5,a[0].waitFor?setTimeout((()=>{s.message,this.updateStatuses(e,t)}),a[0].waitFor):this.updateStatuses(e,t)}})):this.props.selectedDeviceId&&wfetch(`${httpPrefix}/lfs/status/${this.props.selectedDeviceId}.json`,{method:"get",signal:s.signal}).then((e=>e.json())).then(fromVersionedToPlain).then((e=>{this.mounted&&this.setState({status:this.orderResults(e)})}))}}orderResults(e){var t={};return Object.keys(e).filter((t=>"object"!=typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>"object"==typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>Array.isArray(e[t]))).forEach((s=>t[s]=e[s])),t}render(){return this.state?.status?[e("button",{key:genUUID(),onClick:e=>this.updateAppStatus()},"Refresh"),e(LocalJSONEditor,{key:"StateViewer",path:"/",json:this.state.status,editable:!1,selectedDeviceId:this.props.selectedDeviceId,registerStateCallback:this.props.registerStateCallback,registerEventInstanceCallback:this.props.registerEventInstanceCallback})]:e("div",{key:genUUID()},"Loading...")}}class ConfigPage extends React.Component{componentDidMount(){if(window.location.host||httpPrefix){var e=new AbortController,t=setTimeout((()=>e.abort()),4e3);wfetch(`${httpPrefix}/config/${"current"==this.props.selectedDeviceId?"":this.props.selectedDeviceId+".json"}`,{method:"post",signal:e.signal}).then((e=>e.json())).then(this.orderResults).then((e=>{clearTimeout(t),this.setState({config:fromVersionedToPlain(e),original:e})}))}}componentDidUpdate(e,t,s){if(this.state?.config&&void 0===this.jsoneditor)try{this.jsoneditor=new JSONEditor(this.container,{onChangeJSON:e=>this.setState({newconfig:e})},this.state.config)}catch(e){this.jsoneditor=null}}orderResults(e){var t={};return Object.keys(e).filter((t=>"object"!=typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>"object"==typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>Array.isArray(e[t]))).forEach((s=>t[s]=e[s])),t}getEditor(){return[e("div",{key:"fancy-editor",ref:e=>this.container=e,id:`${this.props.id||genUUID()}`,"data-theme":"spectre"}),null===this.jsoneditor&&this.state?.config?e(LocalJSONEditor,{key:"ConfigEditor",path:"/",json:this.state.config,selectedDeviceId:this.props.selectedDeviceId,editable:!0}):null,this.state?.newconfig?e("button",{key:"save",onClick:this.saveChanges.bind(this)},"Save"):null]}saveChanges(){var e=new AbortController,t=setTimeout((()=>e.abort()),4e3);wfetch(`${httpPrefix}/config`,{method:"put",signal:e.signal,body:JSON.stringify(fromPlainToVersionned(this.state.newconfig,this.state.original))}).then((e=>e.json())).then(this.orderResults).then(fromVersionedToPlain).then((e=>{clearTimeout(t),this.setState({config:e})})).catch(console.err)}render(){return window.location.host||httpPrefix?[e("button",{key:genUUID(),onClick:e=>this.componentDidMount()},"Refresh"),this.getEditor()]:e("div",{key:genUUID()},"Loading....")}}class TypedField extends React.Component{render(){return[e("div",{key:genUUID(),className:this.props.type},this.props.type),this.props.path?e("div",{key:genUUID(),className:"path"},this.props.path):null]}}class LitteralField extends React.Component{render(){return e("div",{key:genUUID(),className:"litteral"},this.props.value)}}class EventField extends React.Component{render(){return e("div",{key:genUUID(),className:"conditionField"},this.props.name?e(TypedField,{key:genUUID(),type:this.props.name,value:this.props.value,path:this.props.path}):e(LitteralField,{key:genUUID(),value:this.props.value}))}}class EventCondition extends React.Component{render(){return e("div",{key:genUUID(),className:"condition"},[e(EventField,{key:genUUID(),...this.props.src}),e("div",{key:genUUID(),className:"operator"},this.props.operator),e(EventField,{key:genUUID(),...this.props.comp})])}}class EventConditions extends React.Component{render(){return e("details",{key:genUUID(),className:"conditions "+(0==this.props.conditions.length?"hidden":"")},[e("summary",{key:genUUID()},"Conditions"),this.props.conditions.map((t=>e(EventCondition,{key:genUUID(),...t})))])}}class EventLine extends React.Component{render(){return"conditions"==this.props.name?e(EventConditions,{key:genUUID(),className:this.props.name,conditions:this.props.value}):Array.isArray(this.props.value)?this.props.value.length>0?e("details",{key:genUUID(),className:`arrayfield ${this.props.name}`},e("summary",{key:genUUID(),className:"name"},this.props.name),this.props.value.map((t=>e("div",{key:genUUID(),className:"arrayItem"},Object.keys(t).map((s=>e(EventLine,{key:genUUID(),name:s,value:t[s]}))))))):null:"object"==typeof this.props.value?Object.keys(this.props.value).length>0?e("details",{key:genUUID(),className:`object ${this.props.name}`},[e("summary",{key:genUUID(),className:"object name"},this.props.name),Object.keys(this.props.value).map((t=>e("details",{key:genUUID(),className:"name"},[e("summary",{key:genUUID()},t),e("div",{key:genUUID(),className:t},this.props.value[t])])))]):null:e("details",{key:genUUID(),className:this.props.name},[e("summary",{key:genUUID()},this.props.name),this.props.value])}}class Event extends React.Component{render(){return e("details",{key:genUUID(),className:"event"},[e("summary",{key:genUUID(),className:"name"},[e("div",{key:genUUID(),className:"eventBase"},this.props.eventBase),e("div",{key:genUUID(),className:"eventId"},this.props.eventId)]),Object.keys(this.props).filter((e=>"name"!=e)).map((t=>e(EventLine,{key:genUUID(),name:t,value:this.props[t]})))])}}class LiveEvent extends React.Component{render(){return this.props?.event?.dataType?this.renderComponent(this.props.event):e("summary",{key:genUUID(),className:"liveEvent"},e("div",{key:genUUID(),className:"description"},[e("div",{key:genUUID(),className:"eventBase"},"Loading"),e("div",{key:genUUID(),className:"eventId"},"...")]))}renderComponent(t){return e("summary",{key:genUUID(),className:"liveEvent"},[e("div",{key:genUUID(),className:"description"},[e("div",{key:genUUID(),className:"eventBase"},t.eventBase),e("div",{key:genUUID(),className:"eventId"},t.eventId)]),t.data?e("details",{key:genUUID(),className:"data"},this.parseData(t)):null])}parseData(t){return"Number"==t.dataType?e("div",{key:genUUID(),className:"description"},e("div",{key:genUUID(),className:"propNumber"},t.data)):Object.keys(t.data).filter((e=>"object"!=typeof t.data[e]&&!Array.isArray(t.data[e]))).map((s=>e("div",{key:genUUID(),className:"description"},[e("div",{key:genUUID(),className:"propName"},s),e("div",{key:genUUID(),className:s},t.data[s])])))}}class LiveEventPannel extends React.Component{constructor(e){super(e),this.eventTypes=[],this.eventTypeRequests=[],this.props.registerEventCallback&&this.props.registerEventCallback(this.ProcessEvent.bind(this)),this.mounted=!1,this.state={filters:{}}}componentDidMount(){this.mounted=!0}componentWillUnmount(){this.mounted=!1}ProcessEvent(e){if(this.mounted){for(var t=this.state?.lastEvents||[];t.length>100;)t.shift();var s=Object.entries(t.filter((e=>e.eventBase&&e.eventId)).reduce(((e,t)=>(e[t.eventBase]?e[t.eventBase].eventIds.find((e=>e.eventId===t.eventId))||e[t.eventBase].eventIds.push({filtered:!1,eventId:t.eventId}):e[t.eventBase]={filtered:!1,eventIds:[{filtered:!1,eventId:t.eventId}]},e)),{})),i=!1;Object.values(s).forEach((e=>{this.state.filters[e[0]]?e[1].eventIds.find((t=>!this.state.filters[e[0]].eventIds.find((e=>e.eventId===t.eventId))))&&(this.state.filters[e[0]].eventIds=this.state.filters[e[0]].eventIds.concat(e[1].eventIds.filter((t=>!this.state.filters[e[0]].eventIds.find((e=>t.eventId===e.eventId))))),i=!0):(this.state.filters[e[0]]=e[1],i=!0)})),i&&this.setState({filters:this.state.filters}),Object.entries(this.state.filters).find((t=>t[0]===e.eventBase&&t[1].filtered||t[0]===e.eventBase&&t[1].eventIds.find((t=>t.filtered&&t.eventId===e.eventId))))||this.setState({lastEvents:t.concat(e)})}}parseEvent(e){var t=this.eventTypes.find((t=>t.eventBase==e.eventBase&&t.eventName==e.eventId));return t?{dataType:t.dataType,...e}:(!this.eventTypeRequests.find((t=>t.eventBase==e.eventBase&&t.eventId==e.eventId))&&this.mounted&&this.getEventDescriptor(e).then((e=>this.setState({lastState:this.state.lastEvents.map((t=>t.eventBase==e.eventBase&&t.eventId==e.eventName?{dataType:e.dataType,...t}:{event:t}))}))),{...e})}getEventDescriptor(e){var t;return this.eventTypeRequests.push(t={waiters:[],...e}),new Promise(((s,i)=>{var a=this.eventTypes.find((t=>t.eventBase==e.eventBase&&t.eventName==e.eventId));if(a)s({dataType:a.dataType,...e});else{var n=new AbortController;const a=setTimeout((()=>n.abort()),3e3);wfetch(`${httpPrefix}/eventDescriptor/${e.eventBase}/${e.eventId}`,{method:"post",signal:n.signal}).then((e=>(clearTimeout(a),e.json()))).then((e=>{this.eventTypes.push(e),s(e)})).catch((e=>{clearTimeout(a),t.waiters.forEach((t=>{t.reject(e)})),i(e)}))}}))}updateFilters(e,t){e.filtered=t,this.setState({filters:this.state.filters})}filterPanel(){return e("div",{className:"filterPanel"},Object.entries(this.state.filters).map((t=>e("div",{key:t[0],className:`filter ${t[0]}`},[e("input",{key:"filtered",checked:t[1].filtered,onChange:e=>this.updateFilters(e[1],e.target.checked),type:"checkbox"}),e("div",{key:"label",className:`label ${t[0]}`},t[0]),e("div",{key:"filterList",className:"filters"},t[1].eventIds.map((t=>e("div",{key:t.eventId,className:`filteritem ${t.eventId}`},[e("input",{key:"filtered",checked:t.filtered,onChange:e=>this.updateFilters(t,e.target.checked),type:"checkbox"}),e("div",{key:"chklabel",className:"label"},t.eventId)]))))]))))}render(){return e("div",{key:"eventPanel",className:"eventPanel"},[e("div",{key:"control",className:"control"},[e("div",{key:"header"},`${this.state?.lastEvents?.length||"Waiting on "} event${this.state?.lastEvents?.length?"s":""}`),e("button",{key:"clearbtn",onClick:e=>this.setState({lastEvents:[]})},"Clear")]),this.filterPanel(),e("div",{key:"eventList",className:"eventList"},this.state?.lastEvents?.map(((t,s)=>e(LiveEvent,{key:s,event:this.parseEvent(t)}))).reverse())])}}class EventsPage extends React.Component{componentWillUnmount(){this.mounted=!1}componentDidMount(){this.mounted=!0,(window.location.hostname||httpPrefix)&&this.getJsonConfig().then((e=>this.mounted?this.setState({events:e.events,programs:e.programs}):null))}getJsonConfig(){return new Promise(((e,t)=>{if(window.location.hostname||httpPrefix){const s=setTimeout((()=>this.props.pageControler.abort()),3e3);wfetch(`${httpPrefix}/config${"current"==this.props.selectedDeviceId?"":`/${this.props.selectedDeviceId}`}`,{method:"post",signal:this.props.pageControler.signal}).then((e=>(clearTimeout(s),e.json()))).then((t=>e(fromVersionedToPlain(t)))).catch((e=>{clearTimeout(s),t(e)}))}else t({error:"Not connected"})}))}render(){return this.state?.events?[e(LiveEventPannel,{key:"eventpannel",registerEventCallback:this.props.registerEventCallback})]:e("div",{key:"loading"},"Loading.....")}}class FirmwareUpdater extends React.Component{UploadFirmware(e){if(e.preventDefault(),this.setState({loaded:`Sending ${this.state.len} firmware bytes`}),this.state.fwdata&&this.state.md5)return wfetch(`${httpPrefix}/ota/flash?md5=${this.state.md5}&len=${this.state.len}`,{method:"post",body:this.state.fwdata}).then((e=>e.text())).then((e=>this.setState({loaded:e})))}waitForDevFlashing(){var e=new AbortController,t=setTimeout((()=>{e.abort()}),1e3);wfetch(`${httpPrefix}/status/app`,{method:"post",signal:e.signal}).then((e=>(clearTimeout(t),e.json()))).then((e=>this.setState({waiter:null,loaded:`Loaded version ${e.build.ver} built on ${e.build.date}`}))).catch((e=>{clearTimeout(t),this.setState({waiter:setTimeout((()=>this.waitForDevFlashing()),500)})}))}componentDidUpdate(e,t,s){if("Flashing"==this.state.loaded&&null==this.state.waiter&&this.waitForDevFlashing(),this.state.firmware&&!this.state.md5){this.state.md5="loading";var i=new FileReader;i.onload=()=>{var e=i.resultString||i.result,t=CryptoJS.algo.SHA256.create();t.update(CryptoJS.enc.Latin1.parse(i.result)),this.state.fwdata=new Uint8Array(this.state.firmware.size);for(var s=0;s<e.length;s++)this.state.fwdata[s]=e.charCodeAt(s);this.setState({md5:t.finalize().toString(CryptoJS.enc.Hex),fwdata:this.state.fwdata,len:this.state.firmware.size})},i.onprogress=e=>this.setState({loaded:1*this.state.firmware.size/(1*e.loaded)*100+"% loaded"}),i.onerror=e=>this.setState({md5:null,firmware:null,error:e.textContent}),i.onabort=e=>this.setState({md5:null,firmware:null,error:"Aborted"}),i.readAsBinaryString(this.state.firmware)}}render(){return e("form",{key:genUUID(),onSubmit:this.UploadFirmware.bind(this)},e("fieldset",{key:genUUID()},[e("input",{key:genUUID(),type:"file",name:"firmware",onChange:e=>this.setState({firmware:e.target.files[0]})}),e("button",{key:genUUID()},"Upload"),e("div",{key:genUUID()},this.state?.loaded)]))}}class ProgramLine extends React.Component{render(){return Array.isArray(this.props.value)?e("details",{key:genUUID(),className:`arrayfield ${this.props.name}`},e("summary",{key:genUUID(),className:"name"},this.props.name),this.props.value.map((t=>e("div",{key:genUUID(),className:"arrayItem"},Object.keys(t).map((s=>e(ProgramLine,{key:genUUID(),name:s,value:t[s]}))))))):"object"==typeof this.props.value?e("details",{key:genUUID(),className:`object ${this.props.name}`},[e("summary",{key:genUUID(),className:"object name"},this.props.name),Object.keys(this.props.value).map((t=>e("details",{key:genUUID(),className:"name"},[e("summary",{key:genUUID()},t),e("div",{key:genUUID(),className:t},this.props.value[t])])))]):e("details",{key:genUUID(),className:this.props.name},[e("summary",{key:genUUID()},this.props.name),this.props.value])}}class Program extends React.Component{render(){return e("details",{key:genUUID(),className:"program"},[e("summary",{key:genUUID(),className:"name"},this.props.name),Object.keys(this.props).filter((e=>"name"!=e)).map((t=>e(ProgramLine,{key:genUUID(),name:t,value:this.props[t]})))])}}class TripWithin extends React.Component{getIconColor(){return this.state?.points?this.props.points.length?"aquamarine":"#ff0000":"#00ff00"}getIcon(){return e("svg",{key:genUUID(),xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64",onClick:e=>this.setState({viewer:"trip"})},[e("path",{key:genUUID(),style:{fill:this.getIconColor()},d:"M17.993 56h20v6h-20zm-4.849-18.151c4.1 4.1 9.475 6.149 14.85 6.149 5.062 0 10.11-1.842 14.107-5.478l.035.035 1.414-1.414-.035-.035c7.496-8.241 7.289-20.996-.672-28.957A20.943 20.943 0 0 0 27.992 2a20.927 20.927 0 0 0-14.106 5.477l-.035-.035-1.414 1.414.035.035c-7.496 8.243-7.289 20.997.672 28.958zM27.992 4.001c5.076 0 9.848 1.976 13.437 5.563 7.17 7.17 7.379 18.678.671 26.129L15.299 8.892c3.493-3.149 7.954-4.891 12.693-4.891zm12.696 33.106c-3.493 3.149-7.954 4.892-12.694 4.892a18.876 18.876 0 0 1-13.435-5.563c-7.17-7.17-7.379-18.678-.671-26.129l26.8 26.8z"}),e("path",{key:genUUID(),style:{fill:this.getIconColor()},d:"M48.499 2.494l-2.828 2.828c4.722 4.721 7.322 10.999 7.322 17.678s-2.601 12.957-7.322 17.678S34.673 48 27.993 48s-12.957-2.601-17.678-7.322l-2.828 2.828C12.962 48.983 20.245 52 27.993 52s15.031-3.017 20.506-8.494c5.478-5.477 8.494-12.759 8.494-20.506S53.977 7.97 48.499 2.494z"})])}render(){return e("div",{key:genUUID(),className:"rendered trip"},[this.getIcon(),"trip"==this.state?.viewer?e(TripViewer,{key:genUUID(),points:this.props.points,cache:this.props.cache}):null])}}class FileViewer extends React.Component{constructor(e){super(e),this.buildRenderers(0)}buildRenderers(e){this.props.name.endsWith(".csv")&&!this.state?.renderes?.some("trip")&&wfetch(`${httpPrefix}${this.props.folder}/${this.props.name}`).then((e=>e.text())).then((e=>{var t=e.split(/\n|\r\n/)[0].split(",");this.setState({renderes:[{name:"trip",points:e.split(/\n|\r\n/).splice(1).map((e=>{var s={};return e.split(",").forEach(((e,i)=>s[t[i]]=isNaN(e)?e:parseFloat(e))),s})).filter((e=>e.timestamp&&e.timestamp.match(/[0-9]{4}\/[0-9]{2}\/[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}/)))}]})})).catch((t=>{e++<3&&this.buildRenderers(e++)})),this.props.name.endsWith(".log")&&!this.state?.renderes?.some("trip")&&wfetch(`${httpPrefix}${this.props.folder}/${this.props.name}`).then((e=>e.text())).then((e=>this.setState({renderes:[{name:"trip",points:e.split("\n").filter((e=>e.match(/[ID] \([0-9]{2}:[0-9]{2}:[0-9]{2}[.][0-9]{3}\).* Location:.*/))).map((e=>e.match(/[ID] \((?<timestamp>.*)\).*Location:\s*(?<latitude>[0-9.-]+),\s*(?<longitude>[0-9.-]+).*speed:\s*(?<speed>[0-9.]+).*altitude:\s*(?<altitude>[0-9.]+).*course:\s*(?<course>[0-9.]+).*bat:\s*(?<Battery>[0-9.]+)/i)?.groups)).filter((e=>e)).map((e=>(Object.keys(e).forEach((t=>e[t]=isNaN(e[t])?e[t]:parseFloat(e[t]))),e.timestamp=`1970-01-01 ${e.timestamp}`,e.altitude*=100,e.speed*=100,e)))}]}))).catch((t=>{e++<3&&this.buildRenderers(e++)}))}getRenderers(){return this.state?.renderes&&this.state.renderes.length?this.state.renderes.map((t=>{switch(t.name){case"trip":return t.points.length?e(TripWithin,{key:genUUID(),points:t.points,cache:this.props.cache}):null;default:return null}})):null}render(){return[e("a",{key:genUUID(),href:`${httpPrefix}${this.props.folder}/${this.props.name}`},this.props.name.split("/").reverse()[0]),this.getRenderers()]}}class SFile extends React.Component{render(){return e("tr",{key:genUUID(),className:this.props.file.ftype},[e("td",{key:genUUID()},this.getLink(this.props.file)),e("td",{key:genUUID()},"file"!=this.props.file.ftype?"":this.props.file.size),e("td",{key:genUUID()},this.getDeleteLink())])}getDeleteLink(){return"/"==this.props.path||".."==this.props.file.name?null:e("a",{key:genUUID(),href:"#",onClick:()=>{wfetch(`${httpPrefix}/stat${"/"===this.props.path?"":this.props.path}/${this.props.file.name}`,{method:"post",headers:{ftype:"file"==this.props.file.ftype?"file":"directory",operation:"delete"}}).then(this.props.OnDelete?this.props.OnDelete():null).catch((e=>{}))}},"Del")}getLink(t){return"folder"==t.ftype?e("a",{key:genUUID(),href:"#",onClick:()=>this.props.onChangeFolder?this.props.onChangeFolder(`${t.folder||"/"}${".."==t.name?"":"/"+t.name}`.replaceAll("//","/")):null},t.name):e(FileViewer,{cache:this.props.cache,key:genUUID(),...t})}}class StorageViewer extends React.Component{constructor(e){super(e),this.state={loaded:!1,path:"/",cache:{images:{}},files:null},this.id=this.props.id||genUUID()}getSystemFolders(){return["/"!=this.state.path?{ftype:"folder",name:"..",folder:dirname(this.state.path)}:null]}GetFileStat(e){if(e.length){var t=e.pop(),s=setTimeout((()=>this.props.pageControler.abort()),3e3);wfetch(`${httpPrefix}/stat${t.folder}/${t.name}`,{method:"post",signal:this.props.pageControler.signal}).then((i=>{clearTimeout(s),i.json().then((e=>{t.size=e.size,this.mounted&&this.setState({loaded:!0,files:this.state.files,total:this.state?.total+e.size})})),e.length&&!this.props.pageControler.signal.aborted&&this.mounted&&this.GetFileStat(e)})).catch((e=>{clearTimeout(s)}))}}fetchFiles(){if(window.location.host||httpPrefix){var e=setTimeout((()=>this.props.pageControler.abort()),3e3);wfetch(`${httpPrefix}/files`+this.state.path,{method:"post",signal:this.props.pageControler.signal}).then((t=>{clearInterval(e),t.json().then((e=>e.sort(((e,t)=>e.ftype!=t.ftype?"folder"==e.ftype?1:-1:e.name==t.name?0:e.name>t.name?1:-1)))).then((e=>{if(this.mounted){this.setState({loaded:!0,files:e,total:e.reduce(((e,t)=>e+t.size),0)});for(var t=e.filter((e=>"file"==e.ftype&&!e.size)),s=0;s<Math.min(3,t.length);s++)t.length&&this.GetFileStat(t)}}))})).catch(console.error)}}componentDidUpdate(e,t){this.state.loaded||(this.state.loaded=!0),t&&t.path!=this.state.path&&this.fetchFiles()}componentDidMount(){this.mounted=!0,this.state?.files||this.fetchFiles()}componentWillUnmount(){this.mounted=!1}SortTable(e){var t;Array.from((t=e.target.closest("div.file-table").querySelector("tbody")).querySelectorAll("tr:nth-child(n+2)")).sort(comparer(Array.from(e.target.parentNode.children).indexOf(e.target),this.asc=!this.asc)).forEach((e=>t.appendChild(e)))}getTableHeader(){return e("thead",{key:genUUID()},e("tr",{key:genUUID()},["Name","Size"].map((t=>e("th",{key:genUUID(),onClick:this.SortTable.bind(this)},t))).concat(e("th",{key:genUUID()},"Op"))))}render(){return this.state?.files?e("div",{key:genUUID(),id:this.id,className:"file-table "+(this.state.loaded?"":"loading")},e("table",{key:genUUID(),className:"greyGridTable"},[e("caption",{key:genUUID()},this.state.path),this.getTableHeader(),e("tbody",{key:genUUID()},this.getSystemFolders().concat(this.state.files).filter((e=>e)).map((t=>e(SFile,{key:genUUID(),file:t,path:this.state.path,cache:this.state.cache,onChangeFolder:e=>this.setState({path:e}),OnDelete:()=>this.fetchFiles()})))),e("tfoot",{key:genUUID()},e("tr",{key:genUUID()},[e("td",{key:genUUID()},"Total"),e("td",{key:genUUID()},this.state.total)]))])):e("div",{key:genUUID()},"Loading......")}}class LogLine extends React.Component{isScrolledIntoView(){var e=this.logdiv.getBoundingClientRect(),t=e.top,s=e.bottom;return t>=0&&s<=window.innerHeight}render(){var t=this.props.logln.match(/^[^IDVEW]*(.+)/)[1],s=t.substr(0,1),i=t.match(/.*\) ([^:]*)/g)[0].replaceAll(/^.*\) (.*)/g,"$1"),a=this.props.logln.substr(this.props.logln.indexOf(i)+i.length+2).replaceAll(/^[\r\n]*/g,"").replaceAll(/.\[..\n$/g,"");return e("div",{key:genUUID(),className:`log LOG${s}`},[e("div",{key:genUUID(),ref:e=>this.logdiv=e,className:"LOGLEVEL"},s),e("div",{key:genUUID(),className:"LOGDATE"},t.substr(3,12)),e("div",{key:genUUID(),className:"LOGFUNCTION"},i),e("div",{key:genUUID(),className:"LOGLINE"},a)])}}class LogLines extends React.Component{constructor(e){super(e),this.mounted=!1,this.state={logLines:[]}}componentDidMount(){this.mounted=!0}AddLogLine(e){this.mounted&&this.setState({logLines:[...this.state?.logLines||[],e]})}render(){return this.props.registerLogCallback&&this.props.registerLogCallback(this.AddLogLine.bind(this)),e("div",{key:genUUID(),className:"logContainer"},e("div",{key:genUUID(),className:"loglines"},this.state?.logLines?this.state.logLines.map((t=>e(LogLine,{key:genUUID(),logln:t}))):null))}}class SystemPage extends React.Component{SendCommand(e){return wfetch(`${httpPrefix}/status/cmd`,{method:"PUT",body:JSON.stringify(e)}).then((e=>e.text().then(console.log))).catch(console.error).catch(console.error)}render(){return[e("div",{key:genUUID(),className:"logpannel"},[e("button",{key:genUUID(),onClick:e=>this.setState({logLines:[]})},"Clear Logs"),e("button",{key:genUUID(),onClick:e=>this.SendCommand({command:"reboot"})},"Reboot"),e("button",{key:genUUID(),onClick:e=>this.SendCommand({command:"parseFiles"})},"Parse Files"),e("button",{key:genUUID(),onClick:e=>this.SendCommand({command:"factoryReset"})},"Factory Reset"),e(FirmwareUpdater,{key:genUUID()})]),e(LogLines,{key:genUUID(),registerLogCallback:this.props.registerLogCallback})]}}class TripViewer extends React.Component{constructor(e){super(e),this.state={cache:this.props.cache,zoomlevel:15}}componentDidMount(){this.mounted=!0,this.needsRefresh=!0,this.canvas=this.widget.getContext("2d"),this.widget.addEventListener("mousemove",this.mouseEvent.bind(this)),this.getTripTiles(),window.requestAnimationFrame(this.drawMap.bind(this))}componentDidUpdate(e,t,s){this.canvas=this.widget.getContext("2d"),this.widget.addEventListener("mousemove",this.mouseEvent.bind(this)),this.getTripTiles(),this.needsRefresh=!0}drawMap(){if(this.needsRefresh){if(this.needsRefresh=!1,!(this.mounted&&this.widget&&this.props.points&&this.props.points.length))return;this.drawTripTiles().then(this.drawTrip.bind(this)).then(this.drawPointPopup.bind(this)).then((e=>window.requestAnimationFrame(this.drawMap.bind(this)))).catch((e=>{window.requestAnimationFrame(this.drawMap.bind(this))}))}else window.requestAnimationFrame(this.drawMap.bind(this))}getTripTiles(){var e=this.props.points.map(this.pointToCartesian.bind(this));this.tiles={points:e,trip:{leftTile:e.reduce(((e,t)=>e<t.tileX?e:t.tileX),99999),rightTile:e.reduce(((e,t)=>e>t.tileX?e:t.tileX),0),bottomTile:e.reduce(((e,t)=>e<t.tileY?e:t.tileY),99999),topTile:e.reduce(((e,t)=>e>t.tileY?e:t.tileY),0)},maxXTiles:Math.ceil(window.innerWidth/256)+1,maxYTiles:Math.ceil(window.innerHeight/256)+1},this.tiles.trip.XTiles=this.tiles.trip.rightTile-this.tiles.trip.leftTile+1,this.tiles.trip.YTiles=this.tiles.trip.bottomTile-this.tiles.trip.bottomTile+1,this.tiles.margin={left:this.tiles.maxXTiles>this.tiles.trip.XTiles?Math.floor((this.tiles.maxXTiles-this.tiles.trip.XTiles)/2):0,bottom:this.tiles.maxYTiles>this.tiles.trip.YTiles?Math.floor((this.tiles.maxYTiles-this.tiles.trip.YTiles)/2):0},this.tiles.margin.right=this.tiles.maxXTiles>this.tiles.trip.XTiles?this.tiles.maxXTiles-this.tiles.trip.XTiles-this.tiles.margin.left:0,this.tiles.margin.top=this.tiles.maxYTiles>this.tiles.trip.YTiles?this.tiles.maxYTiles-this.tiles.trip.YTiles-this.tiles.margin.bottom:0,this.tiles.leftTile=Math.max(0,this.tiles.trip.leftTile-this.tiles.margin.left),this.tiles.rightTile=this.tiles.trip.rightTile+this.tiles.margin.right,this.tiles.bottomTile=Math.max(0,this.tiles.trip.bottomTile-this.tiles.margin.bottom),this.tiles.topTile=this.tiles.trip.topTile+this.tiles.margin.top}drawTripTiles(){this.widget.width=256*(this.tiles.rightTile-this.tiles.leftTile),this.widget.height=256*(this.tiles.topTile-this.tiles.bottomTile),this.canvas.fillStyle="black",this.canvas.fillRect(0,0,window.innerWidth,window.innerHeight);for(var e=[],t=this.tiles.leftTile;t<=this.tiles.rightTile;t++)for(var s=this.tiles.bottomTile;s<=this.tiles.topTile;s++)e.unshift({tileX:t,tileY:s});return Promise.all(Array.from(Array(Math.min(3,e.length)).keys()).map((t=>this.drawTile(e))))}drawPointPopup(){if(this.focused){this.canvas.font="12px Helvetica";var e=this.canvas.measureText(new Date(`${this.focused.timestamp} UTC`).toLocaleString()),t=Object.keys(this.focused).filter((e=>"timestamp"!=e&&!e.match(/.*tile.*/i))),s=50+9*t.length,i=e.width+10;this.canvas.strokeStyle="green",this.canvas.shadowColor="#00ffff",this.canvas.fillStyle="#000000",this.canvas.lineWidth=1,this.canvas.shadowBlur=2,this.canvas.beginPath(),this.canvas.rect(this.getClientX(this.focused),this.getClientY(this.focused)-s,i,s),this.canvas.fill(),this.canvas.stroke(),this.canvas.fillStyle="rgba(00, 0, 0, 1)",this.canvas.strokeStyle="#000000",this.canvas.beginPath();var a=this.getClientY(this.focused)-s+e.actualBoundingBoxAscent+3,n=this.getClientX(this.focused)+3;this.canvas.strokeStyle="#97ea44",this.canvas.shadowColor="#ffffff",this.canvas.fillStyle="#97ea44",this.canvas.lineWidth=1,this.canvas.shadowBlur=2,this.canvas.fillText(new Date(`${this.focused.timestamp} UTC`).toLocaleString(),n,a),a+=5,a+=e.actualBoundingBoxAscent+3,t.forEach((t=>{var s=this.getPropValue(t,this.focused[t]);this.canvas.strokeStyle="aquamarine",this.canvas.shadowColor="#ffffff",this.canvas.fillStyle="aquamarine",this.canvas.fillText(`${t}: `,n,a),e=this.canvas.measureText(s),this.canvas.strokeStyle="#97ea44",this.canvas.shadowColor="#ffffff",this.canvas.fillStyle="#97ea44",this.canvas.fillText(s,n+(i-e.width)-5,a),a+=e.actualBoundingBoxAscent+3})),this.canvas.stroke()}}drawTrip(){return new Promise(((e,t)=>{var s=this.tiles.points[0];s?(this.canvas.strokeStyle="#00ffff",this.canvas.shadowColor="#00ffff",this.canvas.fillStyle="#00ffff",this.canvas.lineWidth=2,this.canvas.shadowBlur=2,this.canvas.beginPath(),this.canvas.moveTo(this.getClientX(s),this.getClientY(s)),this.tiles.points.forEach((e=>{this.canvas.lineTo(this.getClientX(e),this.getClientY(e))})),this.canvas.stroke(),this.canvas.strokeStyle="#0000ff",this.canvas.shadowColor="#0000ff",this.canvas.fillStyle="#0000ff",this.tiles.points.forEach((e=>{this.canvas.beginPath(),this.canvas.arc(256*(e.tileX-this.tiles.leftTile)+256*e.posTileX,256*(e.tileY-this.tiles.bottomTile)+256*e.posTileY,5,0,2*Math.PI),this.canvas.stroke()})),e(this.tiles)):t({error:"no points"})}))}mouseEvent(e){var t=this.tiles.points.find((t=>this.getClientX(t)>=e.offsetX-10&&this.getClientX(t)<=e.offsetX+10&&this.getClientY(t)>=e.offsetY-10&&this.getClientY(t)<=e.offsetY+10));this.needsRefresh=t!=this.focused,this.focused=t}getPropValue(e,t){return"speed"==e?`${Math.floor(1.852*t/100)} km/h`:"altitude"==e?`${Math.floor(t/100)}m`:"longitude"==e||"latitude"==e?t:Math.round(t)}drawTile(e){return new Promise(((t,s)=>{var i=e.pop();if(i)if(this.state.cache.images[this.state.zoomlevel]&&this.state.cache.images[this.state.zoomlevel][i.tileX]&&this.state.cache.images[this.state.zoomlevel][i.tileX][i.tileY]){var a=this.state.cache.images[this.state.zoomlevel][i.tileX][i.tileY];try{this.canvas.drawImage(a,a.posX*a.width,a.posY*a.height),e.length?t(this.drawTile(e)):t({})}catch(s){this.state.cache.images[this.state.zoomlevel][i.tileX][i.tileY]=null,t(this.drawTile(e))}}else this.getTile(i.tileX,i.tileY,0).then((s=>{var a=new Image;a.posX=i.tileX-this.tiles.leftTile,a.posY=i.tileY-this.tiles.bottomTile,a.src=(window.URL||window.webkitURL).createObjectURL(s),this.state.cache.images[this.state.zoomlevel]||(this.state.cache.images[this.state.zoomlevel]={}),this.state.cache.images[this.state.zoomlevel][i.tileX]||(this.state.cache.images[this.state.zoomlevel][i.tileX]={}),this.state.cache.images[this.state.zoomlevel][i.tileX][i.tileY]=a,a.onload=s=>{this.canvas.drawImage(a,a.posX*a.width,a.posY*a.height),e.length?t(this.drawTile(e)):t({})}})).catch(s);else t({})}))}downloadTile(e,t){return new Promise(((s,i)=>{var a;wfetch(`https://tile.openstreetmap.de/${this.state.zoomlevel}/${e}/${t}.png`).then((e=>e.blob())).then((i=>wfetch(`${httpPrefix}/sdcard/web/tiles/${this.state.zoomlevel}/${e}/${t}.png`,{method:"put",body:a=i}).then(s(a)))).catch(i)}))}getTile(e,t,s){return new Promise(((i,a)=>{wfetch(`${httpPrefix}/sdcard/web/tiles/${this.state.zoomlevel}/${e}/${t}.png`).then((s=>i(s.status>=300?this.downloadTile(e,t):s.blob()))).catch((n=>{s>3?a({error:`Error in downloading ${this.state.zoomlevel}/${e}/${t}`}):i(this.getTile(e,t,s++))}))}))}getClientY(e){return 256*(e.tileY-this.tiles.bottomTile)+256*e.posTileY}getClientX(e){return 256*(e.tileX-this.tiles.leftTile)+256*e.posTileX}lon2tile(e){return Math.floor(this.lon2x(e))}lat2tile(e){return Math.floor(this.lat2y(e))}lon2x(e){return(e+180)/360*Math.pow(2,this.state.zoomlevel)}lat2y(e){return(1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,this.state.zoomlevel)}tile2long(e,t){return e/Math.pow(2,t)*360-180}tile2lat(e,t){var s=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(s)-Math.exp(-s)))}pointToCartesian(e){return{tileX:this.lon2tile(e.longitude,this.state.zoomlevel),tileY:this.lat2tile(e.latitude,this.state.zoomlevel),posTileX:this.lon2x(e.longitude,this.state.zoomlevel)-this.lon2tile(e.longitude,this.state.zoomlevel),posTileY:this.lat2y(e.latitude,this.state.zoomlevel)-this.lat2tile(e.latitude,this.state.zoomlevel),...e}}closeIt(){this.setState({closed:!0})}render(){return e("div",{key:genUUID(),className:"lightbox "+(this.state?.closed?"closed":"opened")},[e("div",{key:genUUID()},[e("div",{key:genUUID(),className:"tripHeader"},[`Trip with ${this.props.points.length} points`,e("br",{key:genUUID()}),`From ${new Date(`${this.props.points[0].timestamp} UTC`).toLocaleString()} `,`To ${new Date(`${this.props.points[this.props.points.length-1].timestamp} UTC`).toLocaleString()} Zoom:`,e("select",{key:genUUID(),onChange:e=>this.setState({zoomlevel:e.target.value}),value:this.state.zoomlevel},Array.from(Array(18).keys()).map((t=>e("option",{key:genUUID()},t+1))))]),e("span",{key:genUUID(),className:"close",onClick:this.closeIt.bind(this)},"X")]),e("div",{key:genUUID(),className:"trip"},e("canvas",{key:genUUID(),ref:e=>this.widget=e}))])}}var app=null;function wfetch(e,t){return new Promise(((s,i)=>{var a=getInSpot(app.anims.filter((e=>"post"==e.type&&"browser"==e.from)),"browser"),n=a;a?a.weight++:app.anims.push(n={type:"post",from:"browser",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:5,renderer:app.drawSprite});try{fetch(e,t).then((e=>{var t=getInSpot(app.anims.filter((e=>"post"==e.type&&"chip"==e.from)),"chip");t?t.weight++:app.anims.push({type:"post",from:"chip",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:25,renderer:app.drawSprite}),s(e)})).catch((e=>{n.color="red",n.lineColor="red",i(e)}))}catch(e){n.color="red",n.lineColor="red",i(err)}}))}class MainApp extends React.Component{constructor(e){super(e),this.anims=[],app=this,this.state={pageControler:this.GetPageControler(),selectedDeviceId:"current",httpPrefix:httpPrefix,tabs:{Storage:{active:!0},Status:{active:!1},Config:{active:!1},Logs:{active:!1},Events:{active:!1}},autoRefresh:!(!httpPrefix&&!window.location.hostname)},httpPrefix||window.location.hostname||this.lookForDevs(),this.state?.autoRefresh&&(httpPrefix||window.location.hostname)&&this.openWs()}componentDidUpdate(e,t,s){}componentDidMount(){app=this,this.mountWidget(),this.mounted=!0}componentWillUnmount(){this.mounted=!1}lookForDevs(){var e=window.webkitRTCPeerConnection||window.mozRTCPeerConnection;e?(()=>{var t=new e({iceServers:[]});function s(e){if(~e.indexOf("a=candidate")){var t=(s=e.split(" "))[4];s[7]}else if(~e.indexOf("c=")){t=(s=e.split(" "))[2].split(".");var s,i=s[1];if("0"===t[0]&&(t[0]=192,t[1]=168,t[2]=0),"IP4"===i&&t[0]){this.state.lanDevices=[];for(var a=254;a>0;a--)t[3]=a,this.state.lanDevices.push(t.join("."));this.state.lanDevices=this.state.lanDevices.sort((()=>.5-Math.random()));var n=[];for(a=0;a<Math.min(10,this.state.lanDevices.length);a++)this.state.lanDevices.length&&this.scanForDevices(this.state.lanDevices,n)}}}t.createDataChannel("",{reliable:!1}),t.onicecandidate=e=>{e.candidate&&s.bind(this)("a="+e.candidate.candidate)},t.createOffer(function(e){e.sdp.split("\r\n").forEach(s.bind(this)),t.setLocalDescription(e)}.bind(this),(e=>{})),Object.create(null)["0.0.0.0"]=!1}).bind(this)():(document.getElementById("list").innerHTML='<code>ifconfig| grep inet | grep -v inet6 | cut -d" " -f2 | tail -n1</code>',document.getElementById("list").nextSibling.textContent="In Chrome and Firefox your IP should display automatically, by the power of WebRTCskull.")}scanForDevices(e,t){if(e.length){var s=e.pop(),i=new AbortController,a=setTimeout((()=>i.abort()),1e3);wfetch(`http://${s}/config/`,{method:"post",signal:i.signal}).then((e=>(clearTimeout(a),!0,e.json()))).then(fromVersionedToPlain).then((i=>{if(i?.deviceid){var a=getInSpot(this.anims.filter((e=>"ping"==e.type&&"chip"==e.from)),"chip");a?a.weight++:this.anims.push({type:"ping",from:"chip",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:30,renderer:this.drawSprite}),i.ip=s,t.push(i),httpPrefix||(httpPrefix=`http://${t[0].ip}`,this.state.autoRefresh=!0,this.state.connecting||this.state.connected||this.openWs()),this.setState({OnLineDevices:t})}e.length&&this.scanForDevices(e,t)})).catch((s=>{e.length&&this.scanForDevices(e,t)}))}}mountWidget(){this.widget.addEventListener("click",(e=>{e.offsetX>2&&e.offsetX<32&&e.offsetY>2&&e.offsetY<32&&(this.state.autoRefresh=!this.state.autoRefresh,this.state.autoRefresh?this.openWs():this.closeWs())})),this.mounted||window.requestAnimationFrame(this.drawDidget.bind(this))}closeWs(){this.ws&&(this.state.autoRefresh=!1,this.ws.close(),this.ws=null)}openWs(){if((window.location.hostname||httpPrefix)&&!this.state?.connecting&&!this.state?.connected){this.state.connecting=!0,this.state.running=!1;var e=this.ws=new WebSocket("ws://"+(""==httpPrefix?window.location.hostname:httpPrefix.substring(7))+"/ws"),t=setTimeout((()=>{e.close(),this.state.connecting=!1}),3500);e.onmessage=s=>{clearTimeout(t),this.state.running&&!this.state.timeout||(this.state.running=!0,this.state.error=null,this.state.timeout=null),s&&s.data&&("{"==s.data[0]?s.data.startsWith('{"eventBase"')?this.ProcessEvent(fromVersionedToPlain(JSON.parse(s.data))):this.UpdateState(fromVersionedToPlain(JSON.parse(s.data))):s.data.match(/.*\) ([^:]*)/g)&&this.AddLogLine(s.data)),t=setTimeout((()=>{this.state.timeout="Message",e.close()}),3500)},e.onopen=()=>{clearTimeout(t),this.state.connected=!0,this.state.connecting=!1,e.send("Connected"),t=setTimeout((()=>{this.state.timeout="Connect",e.close()}),3500)},e.onerror=s=>{clearTimeout(t),this.state.error=s,e.close()},e.onclose=e=>{clearTimeout(t),this.state.connected=!1,this.state.connecting=!1,this.state.autoRefresh&&this.openWs()}}}drawDidget(){if(this.widget){var e=this.widget.getContext("2d");if(e.clearRect(0,0,100,40),this.browser(e,2,2,30,30,10),this.chip(e,70,2,20,30,5),this.anims.length){var t=this.anims.reduce(((e,t)=>((e[t.type]=e[t.type]||[]).push(t),e)),{});for(var s in t)e.beginPath(),t[s].forEach((t=>{this.drawSprite(t,e)}));this.anims=this.anims.filter((e=>2!=e.state))}window.requestAnimationFrame(this.drawDidget.bind(this))}}drawSprite(e,t){e.state?e.x+=2*e.direction:(e.state=1,e.x="chip"==e.from?this.chipX:this.browserX,e.endX="chip"==e.from?this.browserX:this.chipX,e.direction="browser"==e.from?1:-1,e.y=e.startY);var s=Math.min(15,4+e.weight);if(e.y-s/2<=0&&(e.y=s),t.strokeStyle=e.lineColor,t.lineWidth=1,t.shadowBlur=1,t.shadowColor=e.shadowColor,t.fillStyle=e.color,t.moveTo(e.x+s,e.y),t.arc(e.x,e.y,s,0,2*Math.PI),"browser"!=e.from&&"log"!=e.type||t.fill(),e.weight>1){var i=""+e.weight;t.font=Math.min(20,8+e.weight)+"px Helvetica";var a=t.measureText(i);"browser"!=e.from&&"log"!=e.type||(t.strokeStyle="black",t.fillStyle="black"),t.fillText(i,e.x-a.width/2,e.y+a.actualBoundingBoxAscent/2),"browser"!=e.from&&"log"!=e.type||(t.strokeStyle=e.lineColor,t.fillStyle=e.color)}return t.stroke(),(1==e.direction?e.x>e.endX:e.x<e.endX)&&(e.state=2),e}browser(e,t,s,i,a,n){this.browserX=t+i,e.beginPath(),e.strokeStyle="#00ffff",e.lineWidth=2,e.shadowBlur=2,e.shadowColor="#00ffff",e.fillStyle=this.state?.autoRefresh?this.state?.error||this.state?.timeout?"#f27c7c":this.state?.connected?"#00ffff59":"#0396966b":"#000000",this.roundedRectagle(e,t,s,i,a,n),e.fill(),this.state?.lanDevices?.length&&this.roundedRectagle(e,t,s,i,a*(this.state.lanDevices.length/254),n),e.stroke()}chip(e,t,s,i,a,n){this.chipX=t,e.beginPath();e.strokeStyle="#00ffff",e.lineWidth=2,e.shadowBlur=2,e.shadowColor="#00ffff",e.fillStyle="#00ffff",this.roundedRectagle(e,t,s,i,a,n);for(var r=0;r<3;r++)e.moveTo(t,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t-4,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t-4,1.5*n+2+s+r*((a-2*n)/3)),e.lineTo(t,1.5*n+2+s+r*((a-2*n)/3)),e.moveTo(t+i,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t+i+4,1.5*n+s+r*((a-2*n)/3)),e.lineTo(t+i+4,1.5*n+2+s+r*((a-2*n)/3)),e.lineTo(t+i,1.5*n+2+s+r*((a-2*n)/3));e.stroke()}roundedRectagle(e,t,s,i,a,n){e.moveTo(t+n,s),e.lineTo(t+i-2*n,s),e.arcTo(t+i,s,t+i,s+n,n),e.lineTo(t+i,s+a-n),e.arcTo(t+i,s+a,t+i-n,s+a,n),e.lineTo(t+n,s+a),e.arcTo(t,s+a,t,s+a-n,n),e.lineTo(t,s+n),e.arcTo(t,s,t+n,s,n)}AddLogLine(e){var t=getInSpot(this.anims.filter((t=>"log"==t.type&&t.level==e[0])),"chip");t?t.weight++:this.anims.push({type:"log",from:"chip",level:e[0],color:"D"==e[0]?"green":"W"==e[0]?"yellow":"red",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:25,renderer:this.drawSprite}),this.callbacks.logCBFn.forEach((t=>t(e)))}UpdateState(e){var t=getInSpot(this.anims.filter((e=>"state"==e.type)),"chip");t?t.weight++:this.anims.push({type:"state",from:"chip",color:"#00ffff",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:5,renderer:this.drawSprite}),this.callbacks.stateCBFn.forEach((t=>t(e)))}ProcessEvent(e){var t=getInSpot(this.anims.filter((e=>"event"==e.type)),"chip");t?t.weight++:this.anims.push({type:"event",from:"chip",eventBase:e.eventBase,color:"#7fffd4",weight:1,lineColor:"#00ffff",shadowColor:"#00ffff",startY:15,renderer:this.drawSprite}),this.callbacks.eventCBFn.forEach((t=>t.fn(e)))}GetPageControler(){var e=new AbortController;return e.onabort=this.OnAbort,e}OnAbort(){this.state.pageControler=this.GetPageControler()}setActiveTab(e){this.state.tabs[e].active=!0,Object.keys(this.state.tabs).filter((t=>t!=e)).forEach((e=>this.state.tabs[e].active=!1)),this.refreshActiveTab()}refreshActiveTab(){Object.keys(this.state.tabs).forEach((e=>{var t=document.getElementById(`${e}`),s=document.getElementById(`a${e}`);this.state.tabs[e].active?(s.classList.add("active"),t&&t.classList.add("active"),"Config"==e||"Status"==e||"Events"==e?(document.getElementById("controls").classList.remove("hidden"),document.querySelector("div.slides").classList.remove("expanded")):(document.getElementById("controls").classList.add("hidden"),document.querySelector("div.slides").classList.add("expanded"))):(s.classList.remove("active"),t.classList.remove("active"))}))}registerStateCallback(e){this.callbacks.stateCBFn.find((t=>t.name==e.name))||this.callbacks.stateCBFn.push(e)}registerLogCallback(e){this.callbacks.logCBFn.find((t=>t.name==e.name))||this.callbacks.logCBFn.push(e)}registerEventInstanceCallback(e,t){var s=null;(s=this.callbacks.eventCBFn.find((s=>s.fn.name==e.name&&s.instance===t)))?s.fn=e:this.callbacks.eventCBFn.push({fn:e,instance:t})}registerEventCallback(e){this.callbacks.eventCBFn.find((t=>t.fn.name==e.name&&void 0===t.instance))||this.callbacks.eventCBFn.push({fn:e})}getPage(t){return"Storage"==t?e(StorageViewer,{pageControler:this.state.pageControler,active:this.state.tabs.Storage.active}):"Status"==t?e(StatusPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Status.active,registerEventInstanceCallback:this.registerEventInstanceCallback.bind(this),registerStateCallback:this.registerStateCallback.bind(this)}):"Config"==t?e(ConfigPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Config.active}):"Logs"==t?e(SystemPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Logs.active,registerLogCallback:this.registerLogCallback.bind(this)}):"Events"==t?e(EventsPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Events.active,registerEventCallback:this.registerEventCallback.bind(this)}):null}ReloadPage(){this.setState({pageControler:this.GetPageControler()})}render(){return this.callbacks={stateCBFn:[],logCBFn:[],eventCBFn:[]},e("div",{key:genUUID(),className:"mainApp"},[Object.keys(this.state.tabs).map((t=>e("details",{key:genUUID(),id:t,className:"appPage slides",open:this.state.tabs[t].active,onClick:e=>{e.target.classList.contains("appTab")&&(e.target.parentElement.setAttribute("open",!0),Object.keys(this.state.tabs).forEach((e=>this.state.tabs[e].active=e==t)),[].slice.call(e.target.parentElement.parentElement.children).filter((t=>t!=e)).forEach((e=>e.removeAttribute("open"))))}},[e("summary",{key:genUUID(),className:"appTab"},t),e("div",{key:genUUID(),className:"Status"==t?"pageContent system-config":"pageContent"},this.getPage(t))]))),e("canvas",{key:genUUID(),height:40,width:100,ref:e=>this.widget=e}),e("fieldset",{key:genUUID(),className:"slides",id:"controls"},[this.state?.OnLineDevices?.length&&!window.location.hostname?e("select",{key:genUUID(),className:"landevices",value:httpPrefix.substring(7),onChange:e=>{httpPrefix=`http://${e.target.value}`,this.state?.httpPrefix!=httpPrefix&&this.setState({httpPrefix:httpPrefix}),this.ws?.close()}},this.state.OnLineDevices.map((t=>e("option",{key:genUUID(),className:"landevice"},t.ip)))):null,e(DeviceList,{key:genUUID(),selectedDeviceId:this.state.selectedDeviceId,httpPrefix:httpPrefix,onSet:e=>this.state?.selectedDeviceId!=e?this.setState({selectedDeviceId:e}):null})])])}}function getInSpot(e,t){return e.filter((e=>e.from==t)).find((e=>void 0===e.x||("browser"==t?e.x<=app.browserX+4+e.weight:e.x>=app.chipX-4-e.weight)))}ReactDOM.render(e(MainApp,{key:genUUID(),className:"slider"}),document.querySelector(".slider"));