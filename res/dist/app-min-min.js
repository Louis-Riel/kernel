"use strict";const e=React.createElement;var httpPrefix="";function wfetch(e,t){return new Promise(((s,i)=>{var a=getInSpot(app.anims.filter((e=>"post"==e.type&&"browser"==e.from)),"browser"),r=a;a?a.weight++:app.anims.push(r={type:"post",from:"browser",weight:1,lineColor:"#00ffff",textColor:"#00ffff",shadowColor:"#000000",fillColor:"#004444",startY:5,renderer:app.drawSprite});try{fetch(e,t).then((e=>{var t=getInSpot(app.anims.filter((e=>"post"==e.type&&"chip"==e.from)),"chip");t?t.weight++:app.anims.push({type:"post",from:"chip",weight:1,lineColor:"#00ffff",textColor:"#00ffff",shadowColor:"#000000",fillColor:"#004444",startY:25,renderer:app.drawSprite}),s(e)})).catch((e=>{r.color="red",r.lineColor="red",i(e)}))}catch(e){r.color="red",r.lineColor="red",i(err)}}))}var hexcase=0,b64pad="";function hex_sha1(e){return rstr2hex(rstr_sha1(str2rstr_utf8(e)))}function hex_hmac_sha1(e,t){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(e){return binb2rstr(binb_sha1(rstr2binb(e),8*e.length))}function rstr_hmac_sha1(e,t){var s=rstr2binb(e);s.length>16&&(s=binb_sha1(s,8*e.length));for(var i=Array(16),a=Array(16),r=0;r<16;r++)i[r]=909522486^s[r],a[r]=1549556828^s[r];var n=binb_sha1(i.concat(rstr2binb(t)),512+8*t.length);return binb2rstr(binb_sha1(a.concat(n),672))}function rstr2hex(e){try{}catch(e){hexcase=0}for(var t,s=hexcase?"0123456789ABCDEF":"0123456789abcdef",i="",a=0;a<e.length;a++)t=e.charCodeAt(a),i+=s.charAt(t>>>4&15)+s.charAt(15&t);return i}function str2rstr_utf8(e){for(var t,s,i="",a=-1;++a<e.length;)t=e.charCodeAt(a),s=a+1<e.length?e.charCodeAt(a+1):0,55296<=t&&t<=56319&&56320<=s&&s<=57343&&(t=65536+((1023&t)<<10)+(1023&s),a++),t<=127?i+=String.fromCharCode(t):t<=2047?i+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?i+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(i+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return i}function rstr2binb(e){for(var t=Array(e.length>>2),s=0;s<t.length;s++)t[s]=0;for(s=0;s<8*e.length;s+=8)t[s>>5]|=(255&e.charCodeAt(s/8))<<24-s%32;return t}function binb2rstr(e){for(var t="",s=0;s<32*e.length;s+=8)t+=String.fromCharCode(e[s>>5]>>>24-s%32&255);return t}function binb_sha1(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var s=Array(80),i=1732584193,a=-271733879,r=-1732584194,n=271733878,o=-1009589776,l=0;l<e.length;l+=16){for(var h=i,p=a,d=r,c=n,u=o,m=0;m<80;m++){s[m]=m<16?e[l+m]:bit_rol(s[m-3]^s[m-8]^s[m-14]^s[m-16],1);var g=safe_add(safe_add(bit_rol(i,5),sha1_ft(m,a,r,n)),safe_add(safe_add(o,s[m]),sha1_kt(m)));o=n,n=r,r=bit_rol(a,30),a=i,i=g}i=safe_add(i,h),a=safe_add(a,p),r=safe_add(r,d),n=safe_add(n,c),o=safe_add(o,u)}return Array(i,a,r,n,o)}function sha1_ft(e,t,s,i){return e<20?t&s|~t&i:e<40?t^s^i:e<60?t&s|t&i|s&i:t^s^i}function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function safe_add(e,t){var s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function bit_rol(e,t){return e<<t|e>>>32-t}function genUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}function dirname(e){return(e.match(/.*\//)+"").replace(/(.+)\/$/g,"$1")}function isFloat(e){return Number(e)===e&&e%1!=0}function IsDatetimeValue(e){return e.match(".*ime_.s$")||e.match(".*ime_sec$")}function IsBooleanValue(e){return"true"==e||"yes"==e||!0===e||"false"==e||"no"==e||!1===e}function IsNumberValue(e){return!0!==e&&!1!==e&&"string"!=typeof e&&!isNaN(e)&&""!==e}function degToRad(e){return e*(Math.PI/180)}function fromVersionedToPlain(e,t=""){var s,i={},a=Object.keys(e);for(s in a){var r=a[s],n=!1;"object"==typeof e[r]&&2==Object.keys(e[r]).filter((e=>!(n|=!("version"==e||"value"==e)))).length?i[r]=e[r].value:Array.isArray(e[r])?(i[r]=[],e[r].forEach(((s,a)=>{e[r][a].boper?i[r][i[r].length-1].boper=e[r][a].boper:i[r].push(fromVersionedToPlain(s,`${t}/${r}[${a}]`))}))):"object"==typeof e[r]?i[r]=fromVersionedToPlain(e[r],`${t}/${r}`):i[r]=e[r]}return i}function fromPlainToVersionned(e,t,s=""){var i={},a=Object.keys(e);for(var r in a){var n=a[r],o=t?t[n]:void 0;if(Array.isArray(e[n])){i[n]=[];for(var l=0;l<e[n].length;l++){var h=fromPlainToVersionned(e[n][l],o?o[l]:null,`${s}/${n}[${l}]`);i[n].push(h),h.boper&&(i[n].push({boper:h.boper}),delete h.boper)}}else"object"==typeof e[n]?i[n]=fromPlainToVersionned(e[n],o,`${s}/${n}`):i[n]="boper"===n||"operator"===n||"otype"===n||"value"===n||"name"===n?e[n]:{version:void 0===o?0:e[n]===o.value?o.version:o.version+1,value:e[n]}}return i}const getCellValue=(e,t)=>e.children[t].innerText||e.children[t].textContent,comparer=(e,t)=>(s,i)=>{return a=getCellValue(t?s:i,e),r=getCellValue(t?i:s,e),""===a||""===r||isNaN(a)||isNaN(r)?a.toString().localeCompare(r):a-r;var a,r};class BoolInput extends React.Component{constructor(e){super(e),this.id=this.props.id||genUUID(),this.props.onOn&&this.props.initialState&&this.props.onOn(),this.props.onOff&&!this.props.initialState&&this.props.onOff()}toggleChange=e=>{e.target.checked?this.props.onOn&&this.props.onOn(e.target):this.props.onOff&&this.props.onOff(e.target),this.props.onChange&&this.props.onChange(e.target.checked)};render(){return e("label",{key:genUUID(),className:"editable "+(this.props.blurred?"loading":""),id:`lbl${this.id}`,key:this.id},e("div",{key:genUUID(),className:"label",id:`dlbl${this.id}`},this.props.label),e("input",{key:genUUID(),type:"checkbox",onChange:this.toggleChange,id:`in${this.id}`,checked:this.props.initialState}))}}class CmdButton extends React.Component{constructor(e){super(e),this.state={param1:this.props.param1,param2:this.props.param2,param3:this.props.param3,param4:this.props.param4,param5:this.props.param5,param6:this.props.param6}}runIt(){wfetch(`${httpPrefix}/status/cmd`,{method:this.props.HTTP_METHOD,body:JSON.stringify({command:this.props.command,className:this.props.className,name:this.props.name,...this.state})}).then((e=>e.text())).then(this.props.onSuccess?this.props.onSuccess:console.log).catch(this.props.onError?this.props.onError:console.error)}simpleCommand(){return e("button",{key:"simpleCommand",onClick:this.runIt.bind(this)},this.props.caption)}GetPropertyEditor(t){return e(MaterialUI.FormControl,{key:t},[e(MaterialUI.InputLabel,{key:"label",className:"label",id:`${t}-label`},this.props[`${t}_label`]||t),e(MaterialUI.Input,{key:"input",id:`${t}-input`,type:"number"!=typeof this.state[t]&&isNaN(this.state[t])?"text":"number",label:t,value:this.state[t],onChange:e=>{this.state[t]="number"===e.target.type?parseInt(e.target.value):e.target.value,this.setState(this.state)}})])}complexCommand(){return e("div",{key:"complexCommand",className:"complex-command"},[Object.keys(this.props).filter((e=>e.startsWith("param")&&this.props[e+"_editable"])).map((e=>this.GetPropertyEditor(e))),e("button",{key:genUUID(),onClick:this.runIt.bind(this)},this.props.caption)])}hasComplexCommand(){return Object.keys(this.props).filter((e=>e.endsWith("_editable")&&this.props[e])).length>0}render(){return this.hasComplexCommand()?this.complexCommand():this.simpleCommand()}}class DeviceList extends React.Component{getDevices(){(window.location.host||httpPrefix)&&wfetch(`${httpPrefix}/files/lfs/config`,{method:"post"}).then((e=>e.json())).then((e=>e.filter((e=>"file"==e.ftype)))).then((e=>{var t=e.map((e=>e.name.substr(0,e.name.indexOf("."))));this.setState({devices:t,httpPrefix:httpPrefix}),this.props?.onGotDevices&&this.props.onGotDevices(t)})).catch((e=>{this.setState({error:e})}))}componentDidMount(){this.getDevices()}componentDidUpdate(e,t,s){e?.httpPrefix!=this.props.httpPrefix&&this.getDevices(this.props.httpPrefix)}render(){return this.state?.devices?.length>1?e("select",{key:genUUID(),value:this.props.selectedDeviceId,onChange:e=>this.props?.onSet(e.target.value)},(this.state?.devices||this.props.devices).map((t=>e("option",{key:genUUID(),value:t},t)))):null}}class IntInput extends React.Component{toggleChange=e=>{this.props.onChange&&this.props.onChange(e.target.value)};render(){return e("label",{key:genUUID(),className:"editable",id:`lbl${this.id}`,key:this.id},e("div",{key:genUUID(),className:"label",id:`div${this.id}`},this.props.label),e("input",{key:genUUID(),type:"number",value:this.props.defaultValue,onChange:this.toggleChange.bind(this),id:`${this.id}`}))}}class StateCommands extends React.Component{render(){return e("div",{key:"commands",name:"commands",className:"commands"},this.props.commands.map((t=>e(CmdButton,{key:`${t.command}-${t.param1}`,name:this.props.name,onSuccess:this.props.onSuccess,onError:this.props.onError,...t}))))}}class EditableLabel extends React.Component{constructor(e){super(e),this.state={editing:!1}}getLabel(){return e("div",{onClick:e=>this.setState({editing:!0}),className:"label"},this.props.label)}updateLabel(e){this.newLabel=e.target.value}cancelUpdate(e){this.newLabel=void 0,this.setState({editing:!1})}getEditable(){return[e("input",{key:"edit",defaultValue:this.props.label,onChange:this.updateLabel.bind(this)}),e("div",{key:"ok",onClick:e=>this.setState({editing:!1}),className:"ok-button",dangerouslySetInnerHTML:{__html:"&check;"}}),e("div",{key:"cancel",onClick:this.cancelUpdate.bind(this),className:"cancel-button",dangerouslySetInnerHTML:{__html:"&Chi;"}})]}componentDidUpdate(e,t,s){this.props.onChange&&this.newLabel&&t.editing!==this.state.editing&&this.props.onChange(this.newLabel,this.props.label)}render(){return this.state.editing?this.getEditable():this.getLabel()}}class LocalJSONEditor extends React.Component{constructor(e){super(e),this.state={json:e.json},this.props.registerEventInstanceCallback&&this.props.name&&this.props.registerEventInstanceCallback(this.ProcessEvent.bind(this),`${this.props.class}-${this.props.name}`)}componentWillUnmount(){this.mounted=!1}componentDidMount(){this.mounted=!0}componentDidUpdate(e,t,s){e&&e.json&&e.json!=this.props.json&&this.setState({json:this.props.json})}ProcessEvent(e){this.mounted&&e?.data&&e.data?.name==this.props.name&&this.setState({json:e.data})}removeField(e){delete this.state.json[e],this.setState({value:this.state.json})}changeLabel(e,t){e!==t&&(Object.defineProperty(this.state.json,e,Object.getOwnPropertyDescriptor(this.state.json,t)),delete this.state.json[t])}fieldControlPannel(t){return this.props.editable?e("div",{key:`fcpnolabel${t}header`,className:"fieldHeader"},[e(EditableLabel,{key:`flabel${t}`,label:t,onChange:this.changeLabel.bind(this)}),e("div",{key:`fcpnolabel${t}popupmenu`,className:"popupMenu"},[e("div",{key:"removefield",onClick:e=>this.removeField(t)},"Remove")])]):e("div",{key:`fcpnolabel${t}`,className:"label",id:`dlbl${this.id}`},t)}Parse(t){return void 0!==t&&null!=t?"object"==typeof t&&void 0===t.version?e("div",{key:"jsonobject",className:"statusclass jsonNodes"},this.getSortedProperties(t).map((e=>this.renderField(t,e))).reduce(((e,s)=>{if(s){var i=this.getFieldClass(t,s.fld),a=e.find((e=>e.fclass==i));a?a.elements.push(s.element):e.push({fclass:i,elements:[s.element]})}return e}),[]).map((t=>e("div",{key:`fg-${t.fclass}`,className:`fieldgroup ${t.fclass}`},t.elements)))):this.renderVersioned(t):null}renderField(e,t){return Array.isArray(e[t])?"commands"==t?this.renderCommands(t,e):this.renderArray(t,e):e[t]&&"object"==typeof e[t]&&void 0===e[t].version?this.renderObject(t,e):"class"==t||"name"==t&&e.name==e.class?void 0:this.renderFieldValue(t,e)}renderFieldValue(t,s){return{fld:t,element:this.props.editable?e("label",{key:`${t}label`},[this.fieldControlPannel(t),e("input",{key:"input",defaultValue:void 0===s[t].value?s[t]:s[t].value,onChange:this.processUpdate.bind(this)})]):e(ROProp,{key:`rofld${t}`,value:s[t],name:t,label:t})}}renderObject(t,s){return{fld:t,element:e(LocalJSONEditor,{key:`JE-${this.props.path}/${t}`,path:`${this.props.path}/${t}`,name:t,label:t,editable:this.props.editable,json:s[t],updateAppStatus:this.props.updateAppStatus,registerEventInstanceCallback:this.props.registerEventInstanceCallback})}}renderArray(t,s){return{fld:t,element:e(Table,{key:`Table-Object-${this.props.path}/${t}`,name:t,path:`${this.props.path}/${t}`,label:t,json:s[t],registerEventInstanceCallback:this.props.registerEventInstanceCallback,editable:this.props.editable,sortable:this.props.sortable})}}renderCommands(t,s){return{fld:t,element:e(StateCommands,{key:`${t}cmds`,name:s.name,commands:s[t],onSuccess:this.props.updateAppStatus})}}renderVersioned(t){return void 0!==t.version||this.props.editable&&"object"!=typeof t?e("input",{key:"input",defaultValue:void 0===t.value?t:t.value,onChange:this.processUpdate.bind(this)}):e(ROProp,{key:"rofield",value:t,name:""})}processUpdate(e,t){t?(void 0===this.state.json[t]&&(this.state.json[t]={version:-1}),this.state.json[t].value=e.target.value,this.state.json[t].version++):(this.state.json.value=e.target.value,this.state.json.version++)}getSortedProperties(e){return Object.keys(e).sort(((t,s)=>{var i=this.getFieldWeight(e,t),a=this.getFieldWeight(e,s);return i==a?t.localeCompare(s):i>a?1:a>i?-1:0})).filter((t=>!e[t]||!("object"==typeof e[t]&&0==Object.keys(e[t]).filter((e=>"class"!=e&&"name"!=e)).length)))}getFieldWeight(e,t){return IsDatetimeValue(t)||e&&void 0!==e[t]?Array.isArray(e[t])?6:"object"==typeof e[t]?e[t]&&e[t].commands?4:5:IsDatetimeValue(t)?1:3:2}getFieldClass(e,t){return e&&e[t]?Array.isArray(e[t])?"array":"object"==typeof e[t]&&void 0===e[t].version?e[t].commands?"commandable":"object":"field":"field"}addNewProperty(){this.state.json[`prop${Object.keys(this.state.json).filter((e=>e.match(/^prop.*/))).length+1}`]=null,this.setState({value:this.state.json})}objectControlPannel(){return[e("div",{key:"ocplabel",className:"jsonlabel"},this.props.label),this.props.editable?e("div",{key:genUUID(),className:"popupMenu"},e("div",{key:"removeprop",onClick:e=>this.addNewProperty()},"Add Column")):null]}render(){return null===this.state.json||void 0===this.state.json?e("div",{id:`loading${this.id}`},"Loading..."):null!=this.props.label?e("fieldset",{id:`fs${this.props.label}`,className:"jsonNodes"},[e("legend",{key:"legend"},this.objectControlPannel()),this.Parse(this.state.json)]):this.Parse(this.state.json)}}class ROProp extends React.Component{constructor(e){super(e),this.id=this.props.id||genUUID(),IsNumberValue(this.props.value)&&(this.state={maxLastStates:50,lastStates:[{value:this.props.value,ts:Date.now()}]})}getValue(t,s){return void 0!==s?.value?this.getValue(t,s.value):IsNumberValue(s)&&isFloat(s)?parseFloat(s).toFixed(this.isGeoField()?8:2).replace(/0+$/,""):IsBooleanValue(s)?"true"===s||"yes"===s||!0===s?"Y":"N":"name"===this.props.name&&s.match(/\/.*\.[a-z]{3}$/)?e("a",{href:`${httpPrefix}${s}`},s.split("/").reverse()[0]):s}isGeoField(){return"lattitude"===this.props.name.toLowerCase()||"longitude"===this.props.name.toLowerCase()||"lat"===this.props.name||"lng"===this.props.name}componentDidMount(){IsDatetimeValue(this.props.name)&&this.renderTime(document.getElementById(`vel${this.id}`),this.props.name,this.getValue(this.props.name,this.props.value))}componentDidUpdate(e,t,s){IsDatetimeValue(this.props.name)&&this.renderTime(document.getElementById(`vel${this.id}`),this.props.name,this.getValue(this.props.name,this.props.value)),this.state?.lastStates&&this.props.value!==e?.value&&this.setState({lastStates:[...this.getActiveLastStates(),{value:this.getValue(this.props.name,this.props.value),ts:Date.now()}]})}getActiveLastStates(){return this.state.lastStates.length>this.state.maxLastStates-1?this.state.lastStates.splice(this.state.lastStates.length-this.state.maxLastStates):this.state.lastStates}renderTime(e,t,s){if(null!=e){var i=t.endsWith("_us")?new Date(s/1e3):t.endsWith("_sec")?new Date(1e3*s):new Date(s);i.getFullYear()<=1970&&i.setTime(i.getTime()+60*i.getTimezoneOffset()*1e3);var a=i.toLocaleDateString("en-US",{dateStyle:"short"}),r=i.toLocaleTimeString("en-US",{hour12:!1}),n=i.getHours(),o=i.getMinutes(),l=i.getSeconds(),h=i.getMilliseconds(),p=o+(l+h/1e3)/60;i.getFullYear()<=1970&&(a=i.getDate()-1+" Days",r=0==n?(o?o+":":"")+("0"+l).slice(-2)+"."+h:("0"+n).slice(-2)+":"+("0"+o).slice(-2)+":"+("0"+l).slice(-2));var d=e.querySelector("canvas")||e.appendChild(document.createElement("canvas"));d.height=100,d.width=110;var c=d.getContext("2d");c.strokeStyle="#00ffff",c.lineWidth=4,c.shadowBlur=2,c.shadowColor="#00ffff";var u=e.getBoundingClientRect();u.height=d.height,u.width=d.width,this.drawBackground(c,u,n,p),this.drawClock(c,a,u,r)}}drawClock(e,t,s,i){e.font="12px Helvetica",e.fillStyle="rgba(00, 255, 255, 1)";var a=e.measureText(t);e.fillText(t,s.width/2-a.width/2,.65*s.height),e.font="12px Helvetica",e.fillStyle="rgba(00, 255, 255, 1)",a=e.measureText(i),e.fillText(i,.5*s.width-a.width/2,.45*s.height)}drawBackground(e,t,s,i){var a=e.createRadialGradient(t.width/2,t.height/2,5,t.width/2,t.height/2,t.height+5);a.addColorStop(0,"#03303a"),a.addColorStop(1,"black"),e.fillStyle=a,e.clearRect(0,0,t.width,t.height),e.beginPath(),e.arc(t.width/2,t.height/2,.44*t.height,degToRad(270),degToRad(270+30*(s>12?s-12:s))),e.stroke(),e.beginPath(),e.arc(t.width/2,t.height/2,.38*t.height,degToRad(270),degToRad(270+6*i)),e.stroke()}getGraphButton(){var t=null;return this.hasStats()&&(t=e(MaterialUI.Tooltip,{className:"graphtooltip",key:"tooltip",width:"200",height:"100",title:this.state.graph?"Close":this.getReport(!0)},e("i",{className:"reportbtn fa fa-line-chart",key:"graphbtn",onClick:e=>this.setState({graph:!this.state.graph})}))),t}hasStats(){return!IsDatetimeValue(this.props.name)&&IsNumberValue(this.props.value)&&this.state?.lastStates&&this.state.lastStates.reduce(((e,t)=>e.find((e=>e===t.value))?e:[t.value,...e]),[]).length>2}getReport(t){return e(Recharts.ResponsiveContainer,{key:"chartcontainer",className:"chartcontainer"},e(Recharts.LineChart,{key:"chart",data:this.state.lastStates,className:"chart",margin:{left:20}},[e(Recharts.Line,{key:"line",dot:!t,type:"monotone",dataKey:"value",stroke:"#8884d8",isAnimationActive:!1}),t?null:e(Recharts.CartesianGrid,{key:"grid",hide:t,strokeDasharray:"5 5",stroke:"#ccc"}),e(Recharts.XAxis,{key:"thexs",hide:t,dataKey:"ts",type:"number",domain:["auto","auto"],name:"Time",tickFormatter:e=>new Date(e).toLocaleTimeString(),type:"number"}),e(Recharts.YAxis,{key:"theys",hide:t,dataKey:"value",domain:["auto","auto"]}),e(Recharts.Tooltip,{key:"tooltip",contentStyle:{backgroundColor:"black"},labelStyle:{backgroundColor:"black"},className:"tooltip",labelFormatter:e=>new Date(e).toLocaleString()})]))}getLabeledField(){return e("label",{className:"readonly "+(this.state?.graph?"graph":""),id:`lbl${this.id}`,key:this.id},[e("div",{key:"label",className:"label",id:`dlbl${this.id}`},[this.props.label,this.getGraphButton()]),e("div",{key:"value",className:"value",id:`vel${this.id}`},IsDatetimeValue(this.props.name)?"":this.getValue(this.props.name,this.props.value)),this.state?.graph&&this.hasStats()?this.getReport(!1):null])}getTableField(){return e("div",{key:"timevalue",className:"value",id:`vel${this.id}`},IsDatetimeValue(this.props.name)?"":[this.getValue(this.props.name,this.props.value),this.getGraphButton()])}render(){return this.props.label?this.getLabeledField():this.getTableField()}}class Table extends React.Component{constructor(e){super(e),this.id=this.props.id||genUUID(),this.state={keyColumn:this.getKeyColumn()}}componentDidUpdate(e,t){var s=this.getKeyColumn();this.state.keyColumn!=s&&this.setState({keyColumn:s})}getKeyColumn(){if(this.props.json&&this.props.json.length>0&&"object"==typeof this.props.json[0]){var e=Object.keys(this.props.json[0])[0];return this.props.json.reduce(((t,s)=>t.find((t=>t[e]===s[e]))?t:[...t,s]),[]).length===this.props.json.length?e:null}}SortTable(e){var t;this.props.sortable&&Array.from((t=e.target.closest("table").querySelector("tbody")).querySelectorAll("tr:nth-child(n)")).sort(comparer(Array.from(e.target.parentNode.children).indexOf(e.target),this.asc=!this.asc)).forEach((e=>t.appendChild(e)))}BuildHeaderField(t){return e("th",{key:`header-col-${t}`,onClick:this.SortTable.bind(this)},t)}addRow(e){e.stopPropagation(),e.preventDefault(),0==this.props.json.length||"object"==typeof this.props.json[0]?this.props.json.push({}):Array.isArray(this.props.json[0])?this.props.json.push([]):this.props.json.push(""),this.setState({json:this.props.json})}BuildTablePannel(){return this.props.editable?e("div",{key:genUUID(),className:"popupMenu"},e("div",{key:"removeprop",onClick:e=>this.addRow(e)},"Add Row")):null}BuildCaption(){return this.props.editable?e("caption",{key:"caption"},[e("div",{key:"table-panel",className:"objectButtons"},this.BuildTablePannel()),e("div",{key:"label",className:"jsonlabel"},this.props.label)]):e("caption",{key:"caption"},`${this.props.label} - ${this.state.keyColumn}`)}getValue(t,s){return void 0===t||void 0===s?"":void 0!==s?.value?s.value:t.endsWith("_sec")&&s>1e7?new Date(1e3*s).toLocaleString():(IsNumberValue(s)&&isFloat(s)&&(s="lattitude"!=this.props.name.toLowerCase()&&"longitude"!=this.props.name.toLowerCase()&&"lat"!=this.props.name&&"lng"!=this.props.name?parseFloat(s).toFixed(2):parseFloat(s).toFixed(8)),IsBooleanValue(s)&&(s="true"==s||"yes"==s||!0===s?"Y":"N"),"name"==t&&s.match(/\/.*\.[a-z]{3}$/)?e("a",{href:`${httpPrefix}${s}`},s):s)}DeleteLine(e,t){t.stopPropagation(),t.preventDefault(),this.props.json.splice(e,1),this.setState({json:this.props.json})}DuplicateLine(e,t){t.stopPropagation(),t.preventDefault(),this.props.json.push(this.props.json[e]),this.setState({json:this.props.json})}BuildLinePannel(t){return this.props.editable?e("div",{key:"linepanel",className:"stackedMenu"},[e("div",{key:genUUID(),className:"popupMenu"},e("div",{key:"del",onClick:e=>this.DeleteLine(t,e)},"Delete")),e("div",{key:genUUID(),className:"popupMenu"},e("div",{key:"dup",onClick:e=>this.DuplicateLine(t,e)},"Duplicate"))]):null}BuildLine(t,s){return e("tr",{key:this.getRowKey(t,s)},[[this.props.editable?e("td",{key:`${this.getRowKey(t,s)}-panel`,className:"readonly"},this.BuildLinePannel(s)):null,this.cols.map((i=>e("td",{key:`${this.getRowKey(t,s)}-${i}-cell-panel`,className:"readonly"},this.BuildCell(t,i))))]])}getRowKey(e,t){return`row-${this.state.keyColumn?e[this.state.keyColumn]:t}`}addString(e,t){e[t]={value:"",version:0},this.setState({json:this.props.json})}clearCell(e,t){e[t].value?e[t].value=null:e[t]=null,this.setState({json:this.props.json})}BuildCellControlPannel(t,s){if(this.props.editable){var i=t[s];return e("div",{key:genUUID(),className:"popupMenu"},i?e("div",{key:"addpropr",onClick:e=>this.clearCell(t,s)},"Set Null"):e("div",{key:"addpropr",onClick:e=>this.addString(t,s)},"Add String"))}return null}BuildCell(t,s){return[Array.isArray(t[s])?t[s].length?e(Table,{key:`Table-Array-Line-${this.props.path}/${s}`,path:`${this.props.path}/${s}`,editable:this.props.editable,sortable:this.props.sortable,name:s,json:t[s],name:s}):null:e(LocalJSONEditor,{key:`JE-${this.props.path}/${s}`,path:`${this.props.path}/${s}`,editable:this.props.editable,json:t[s],name:s,registerEventInstanceCallback:this.props.registerEventInstanceCallback}),this.BuildCellControlPannel(t,s)]}render(){return void 0===this.props.json?null:(this.cols=[],e("label",{key:"label",id:this.id,className:"table"},e("table",{key:"table",className:"greyGridTable"},[[e("thead",{key:"head"},e("tr",{key:"headrow"},[this.props.editable?e("th",{key:"header"}):null,...this.props.json.flatMap((e=>Object.keys(e))).filter(((e,t,s)=>void 0!==e&&s.indexOf(e)===t)).map((e=>{if(!this.cols.some((t=>e==t))){this.cols.push(e);var t=this.getValue(e,this.props.json[0][e]);this.sortedOn||Array.isArray(t)||"object"==typeof t||!isNaN(this.getValue(e,t))||(this.sortedOn=e)}return this.BuildHeaderField(e)}))])),void 0!==this.props.label?this.BuildCaption():null],e("tbody",{key:"body"},this.props.sortable?this.props.json.sort(((e,t)=>(this.getValue(this.sortedOn,e[this.sortedOn])+"").localeCompare(this.getValue(this.sortedOn,t[this.sortedOn])+""))).map(this.BuildLine.bind(this)):this.props.json.map(this.BuildLine.bind(this)))])))}}class AnalogPinConfig extends React.Component{constructor(e){super(e),this.state={pin:e.item,errors:[]},this.state.pin.channel=this.state.pin.channel?this.state.pin.channel:this.pinNoToChannel(this.state.pin.pinNo),this.state.pin.channel_width=this.state.pin.channel_width?this.state.pin.channel_width:9,this.state.pin.channel_atten=this.state.pin.channel_atten?this.state.pin.channel_atten:0,this.state.pin.waitTime=this.state.pin.waitTime?this.state.pin.waitTime:1e4,this.state.pin.minValue=this.state.pin.minValue?this.state.pin.minValue:0,this.state.pin.maxValue=this.state.pin.maxValue?this.state.pin.maxValue:4096}componentDidUpdate(e,t){this.state!=t&&this.props.onChange&&this.props.onChange(this.state),e?.item!=this.props?.item&&this.setState({pin:this.props.item})}getErrors(){return this.state.errors.map(((t,s)=>e(MaterialUI.Snackbar,{key:`error${s}`,className:"popuperror",anchorOrigin:{vertical:"top",horizontal:"right"},autoHideDuration:3e3,onClose:(e,s)=>{t.visible=!1,this.setState(this.state)},open:t.visible},e(MaterialUI.Alert,{key:`error${s}`,severity:"error"},t.error))))}onChange(e,t){this.state.pin[e]="name"==e?t:"channel_atten"==e?parseFloat(t):parseInt(t),"pinNo"==e&&(this.state.pin.channel=this.pinNoToChannel(this.state.pin.pinNo)),this.setState(this.state),(this.state.pin.channel_width<9||this.state.pin.channel_width>12)&&setTimeout((()=>{this.state.errors.push({visible:!0,error:`Invalid channel width for ${this.state.pin.name}, needs to bebetween 9 and 12`}),this.setState(this.state)}),300)}pinNoToChannel(e){switch(e){case 32:return 4;case 33:return 5;case 34:return 6;case 35:return 7;case 36:return 0;case 37:return 1;case 38:return 2;case 39:return 3;default:return this.state.errors.push({visible:!0,error:`Invalid pin number, ${e} cannot be an analog pin`}),setTimeout((()=>{this.state.errors.push({visible:!0,error:`Invalid pin number, ${e} cannot be an analog pin`}),this.setState(this.state)}),300),-1}}render(){return e(MaterialUI.Card,{key:this.state.pin.pinName,className:"pin-config"},[e(MaterialUI.CardHeader,{key:"header",title:this.state.pin.name}),e(MaterialUI.CardContent,{key:"details"},e(MaterialUI.List,{key:"items"},[e(MaterialUI.ListItem,{key:"pinName"},e(MaterialUI.TextField,{key:"pinName",autoFocus:!0,value:this.state.pin.name,label:"Name",type:"text",onChange:e=>this.onChange("name",e.target.value)})),e(MaterialUI.ListItem,{key:"pinNo"},e(MaterialUI.TextField,{key:"pinNo",value:this.state.pin.pinNo,label:"PinNo",type:"number",onChange:e=>this.onChange("pinNo",parseInt(e.target.value))})),e(MaterialUI.ListItem,{key:"channel"},e(MaterialUI.TextField,{key:"channel",inputProps:{readOnly:!0},value:this.state.pin.channel,label:"Channel",type:"number",onChange:e=>this.onChange("channel",parseInt(e.target.value))})),e(MaterialUI.ListItem,{key:"channel_width"},e(MaterialUI.TextField,{key:"channel_width",value:this.state.pin.channel_width,label:"Channel Width",type:"number",min:9,max:12,onChange:e=>this.onChange("channel_width",parseInt(e.target.value))})),e(MaterialUI.ListItem,{key:"channel_atten"},[e(MaterialUI.InputLabel,{key:"attenLabel",id:"channel_atten_label"},"Channel Attennuation"),e(MaterialUI.Select,{key:"attenSelect",value:this.state.pin.channel_atten,label:"Channel Attennuation",onChange:e=>this.onChange("channel_atten",parseFloat(e.target.value))},[e(MaterialUI.MenuItem,{key:"atten0",value:0},"0 dB - 100 mV ~ 950 mV"),e(MaterialUI.MenuItem,{key:"atten1",value:2.5},"2.5 dB - 100 mV ~ 1250 mV"),e(MaterialUI.MenuItem,{key:"atten2",value:6},"6.0 dB - 100 mV ~ 1750 mV"),e(MaterialUI.MenuItem,{key:"atten3",value:11},"11.0 dB - 100 mV ~ 2450 mV")])]),e(MaterialUI.ListItem,{key:"waitTime"},e(MaterialUI.TextField,{key:"waitTime",value:this.state.pin.waitTime,label:"Wait Time",type:"number",onChange:e=>this.onChange("waitTime",parseInt(e.target.value))})),e(MaterialUI.ListItem,{key:"min"},e(MaterialUI.TextField,{key:"min",value:this.state.pin.minValue,label:"Minimum",type:"number",onChange:e=>this.onChange("minValue",parseInt(e.target.value))})),e(MaterialUI.ListItem,{key:"max"},e(MaterialUI.TextField,{key:"max",value:this.state.pin.maxValue,label:"Maximum",type:"number",onChange:e=>this.onChange("maxValue",parseInt(e.target.value))}))])),this.getErrors()])}}class ConfigGroup extends React.Component{constructor(e){super(e),this.supportedTypes={analogPins:{caption:"Analog Pins",class:"AnalogPin",component:AnalogPinConfig},pins:{caption:"Digital Pins",class:"Pin",component:DigitalPinConfig}},this.state={currentTab:void 0},wfetch(`${httpPrefix}/templates/config`,{method:"post"}).then((e=>e.json())).then(this.updateConfigTemplates.bind(this)).catch(console.error)}updateConfigTemplates(e){this.setState({configTemplates:e,currentTab:e[0].collectionName})}render(){return this.props.config&&this.state.configTemplates?this.renderArrayTypes():e("div",{key:"loading"},"Loading...")}renderArrayTypes(){var t=this.state.configTemplates.filter((e=>e.isArray));return[e(MaterialUI.Tabs,{value:this.state.currentTab,onChange:(e,t)=>{this.setState({currentTab:t})},key:"ConfigTypes"},[...t.map(this.renderTypeTab.bind(this)),e(MaterialUI.Tab,{key:"full-config",label:"Configuration",value:"Configuration"})]),t.map(this.renderConfigType.bind(this))]}renderTypeTab(t){return t.isArray?e(MaterialUI.Tab,{key:t.collectionName,label:this.supportedTypes[t.collectionName]?.caption||t.collectionName,value:t.collectionName}):e(MaterialUI.Tab,{key:t.class,label:this.supportedTypes[t.class]?.caption||t.class,value:t.class})}renderConfigType(t){return e("div",{key:`${t.class}-control-panel`,className:"edior-pannel "+(this.state.currentTab===t.collectionName?"":"hidden")},[e("button",{key:"add",onClick:e=>{this.props.config[t.collectionName]?this.props.config[t.collectionName].push({}):this.props.config[t.collectionName]=[{}],this.props.onChange()}},e("i",{key:"add",className:"fa fa-plus-square"})),e("div",{key:"items",className:"config-cards"},this.props.config[t.collectionName]?Object.keys(this.props.config[t.collectionName]).map((e=>this.renderEditor(t,this.props.config[t.collectionName],e))):null)])}renderConfigItemTab(t,s,i){return e(MaterialUI.Tab,{key:s,label:i+1,value:t})}renderEditor(t,s,i){return e("div",{key:`${t.collectionName}-${i}-control-editor`,className:"control-editor"},[e(this.supportedTypes[t.collectionName]?.component||ConfigItem,{key:t.collectionName+i,value:t,role:"tabpanel",item:s[i],onChange:this.props.onChange}),e("button",{key:"dup",onClick:e=>{this.props.config[t.collectionName].push(JSON.parse(JSON.stringify(this.props.config[t.collectionName][i]))),this.props.onChange()}},e("i",{key:"copy",className:"fa fa-clone"})),e("button",{key:"delete",onClick:e=>{this.props.config[t.collectionName].splice(i,1),this.props.onChange()}},e("i",{key:"copy",className:"fa fa-trash-o"}))])}isSupported(e){return Object.keys(this.supportedTypes).indexOf(e)>-1}}class ConfigItem extends React.Component{constructor(e){super(e),"{}"===JSON.stringify(e.item)&&Object.keys(e.value).filter((e=>!["collectionName","class","isArray"].find((t=>t===e)))).forEach((t=>e.item[t]=e.value[t])),this.state={instance:e.item}}componentDidUpdate(e,t){this.state!=t&&this.props.onChange&&this.props.onChange(this.state.instance)}getFieldType(e){var t=this.props.item[e];return void 0!==t[e]?isNaN(t[e])?"text":"number":"text"}parseFieldValue(e){if(void 0!==e){if(isNaN(e))return e;if("string"==typeof e)return-1!=e.indexOf(".")?parseFloat(e):parseInt(e)}return e}onChange(e,t){this.props.item[e]=this.parseFieldValue(t),this.setState(this.state)}getFieldWeight(e){if(e==this.props.nameField)return 100;switch(this.getFieldType(e,this.props.item[e])){case"text":return 75;case"number":return 50;default:return 25}}render(){return e(MaterialUI.Card,{key:this.props.item[this.props.nameField],className:"config-item"},[e(MaterialUI.CardHeader,{key:"header",title:this.props.item[this.props.nameField]}),e(MaterialUI.CardContent,{key:"details"},e(MaterialUI.List,{key:"items"},Object.keys("{}"===JSON.stringify(this.props.item)?this.props.value:this.props.item).filter((e=>!["collectionName","class","isArray"].find((t=>t===e)))).sort(((e,t)=>{var s=this.getFieldWeight(e),i=this.getFieldWeight(t);return s==i?e.localeCompare(t):i-s})).map(this.getEditor.bind(this))))])}getEditor(t){return e(MaterialUI.ListItem,{key:t},e(MaterialUI.TextField,{key:t,autoFocus:"text"==this.getFieldType(t),value:this.parseFieldValue(this.props.item[t]),label:t,type:this.getFieldType(t),onChange:e=>this.onChange(t,e.target.value)}))}}class DigitalPinConfig extends React.Component{constructor(e){super(e),this.state={pin:e.item}}componentDidUpdate(e,t){this.state!=t&&this.props.onChange&&this.props.onChange(this.state),e?.item!=this.props?.item&&this.setState({pin:this.props.item})}onChange(e,t){this.state.pin[e]="pinName"==e?t:parseInt(t),this.setState(this.state)}render(){return e(MaterialUI.Card,{key:this.state.pin.pinName,className:"pin-config"},[e(MaterialUI.CardHeader,{key:"header",title:this.state.pin.pinName}),e(MaterialUI.CardContent,{key:"details"},e(MaterialUI.List,{key:"items"},[e(MaterialUI.ListItem,{key:"pinName"},e(MaterialUI.TextField,{key:"pinName",autoFocus:!0,value:this.state.pin.pinName,label:"Name",type:"text",onChange:e=>this.onChange("pinName",e.target.value)})),e(MaterialUI.ListItem,{key:"pinNo"},e(MaterialUI.TextField,{key:"pinNo",value:this.state.pin.pinNo,label:"PinNo",type:"number",onChange:e=>this.onChange("pinNo",e.target.value)})),e(PinDriverFlags,{key:"driverFlags",autoFocus:!0,value:this.state.pin.driverFlags,onChange:e=>this.onChange("driverFlags",e)})]))])}}class IRReceiver extends React.Component{constructor(e){super(e),this.state={...e.config},this.state.timing_groups||(this.state.timing_groups=this.getDefaultTimingGroup())}buildTimingGroup(e,t,s,i,a,r,n,o,l,h,p){return{tag:e,carrier_freq_hz:t,duty_cycle:s,bit_length:i,invert:a,header_mark_us:r,header_space_us:n,one_mark_us:o,one_space_us:l,zero_mark_us:h,zero_space_us:p}}getDefaultTimingGroup(){return[this.buildTimingGroup("HiSense",38e3,33,28,0,9e3,4200,650,1600,650,450),this.buildTimingGroup("NEC",38e3,33,32,0,9e3,4250,560,1690,560,560),this.buildTimingGroup("LG",38e3,33,28,0,9e3,4200,550,1500,550,550),this.buildTimingGroup("samsung",38e3,33,32,0,4600,4400,650,1500,553,453),this.buildTimingGroup("LG32",38e3,33,32,0,4500,4500,500,1750,500,560)]}getTimingGroupTableHeader(){return e(MaterialUI.TableHead,{key:"IRTrackerTableHeader"},e(MaterialUI.TableRow,{key:"IRTrackerTableRow"},Object.keys(this.state.timing_groups[0]).map((t=>e(MaterialUI.TableCell,{key:t},t)))))}updateTableProperty(e,t,s){isNaN(e.target.value)?t[s]=e.target.value:t[s]=parseInt(e.target.value)}getTimingGroupTableBody(){return e(MaterialUI.TableBody,{key:"IRTrackerTableBody"},this.state.timing_groups.map(((t,s)=>e(MaterialUI.TableRow,{key:t.tag+s},Object.keys(t).map((s=>e(MaterialUI.TableCell,{key:s},e(MaterialUI.TextField,{key:s,onChange:e=>this.updateTableProperty(e,t,s),defaultValue:t[s]}))))))))}getTimingGroupTable(){return e(MaterialUI.TableContainer,{key:"IRTrackerTableContainer"},e(MaterialUI.Table,{key:"IRTrackerTable"},[this.getTimingGroupTableHeader(),this.getTimingGroupTableBody()]))}updateProperty(e){isNaN(e.target.value)?this.state[e.target.labels[0].outerText]=e.target.value:this.state[e.target.labels[0].outerText]=parseInt(e.target.value)}Apply(){Object.keys(this.state).forEach((e=>{this.props.config[e]=this.state[e]})),this.props.saveChanges()}render(){return e(MaterialUI.Card,{key:"IRTracker",variant:"outlined"},e(MaterialUI.CardContent,{key:"IRTrackerContent"},[e(MaterialUI.Typography,{key:"IRTrackerTitle",variant:"h5"},e("span",{key:"IRTrackerTitleText"},"IR Receiver"),e("span",{key:"filler",className:"filler"}),e(MaterialUI.Button,{key:"Apply",variant:"outlined",onClick:this.Apply.bind(this)},"Apply")),e(MaterialUI.Typography,{key:"IRTrackerSubtitle",variant:"body1"},"Configure the IR Receiver"),e(MaterialUI.Divider,{key:"IRTrackerDivider"}),e(MaterialUI.CardContent,{key:"IRTrackerContent"},[e(MaterialUI.Box,{key:"IRTrackerStack",className:"config-fields"},[Object.keys(this.state).filter((e=>!Array.isArray(this.state[e]))).filter((e=>"object"!=typeof this.state[e])).map((t=>e(MaterialUI.TextField,{key:t,label:t,type:"number",onChange:this.updateProperty.bind(this),defaultValue:this.state[t]})))]),e(MaterialUI.Box,{key:"IRTrackerStackTimingGroups",className:"timing-groups"},this.getTimingGroupTable())])]))}}class PinDriverFlags extends React.Component{constructor(e){super(e),this.state={digital_in:{value:!!(1&e.value),errors:[]},digital_out:{value:!!(2&e.value),errors:[]},pullup:{value:!!(4&e.value),errors:[]},pulldown:{value:!!(8&e.value),errors:[]},touch:{value:!!(16&e.value),errors:[]},wakeonhigh:{value:!!(32&e.value),errors:[]},wakeonlow:{value:!!(64&e.value),errors:[]}}}getValue(e){return e.digital_in.value|e.digital_out.value<<1|e.pullup.value<<2|e.pulldown.value<<3|e.touch.value<<4|e.wakeonhigh.value<<5|e.wakeonlow.value<<6}getFlagNames(e){return[1&e?"digital_in":"",2&e?"digital_out":"",4&e?"pullup":"",8&e?"pulldown":"",16&e?"touch":"",32&e?"wakeonhigh":"",64&e?"wakeonlow":""].filter((e=>e.length>0)).join(", ")}componentDidUpdate(e,t){this.props.value!=this.getValue(this.state)&&this.props.onChange(this.getValue(this.state))}isValidChange(e,t){var s=JSON.parse(JSON.stringify(this.state));return s[e].value=t,"digital_in"!=e&&"digital_out"!=e||!t||("digital_in"==e&&s.digital_out.value&&(this.state.digital_out.value=!1),"digital_out"==e&&s.digital_in.value&&(this.state.digital_in.value=!1,this.state.pullup.value=!1,this.state.pulldown.value=!1,this.state.touch.value=!1,this.state.wakeonhigh.value=!1,this.state.wakeonlow.value=!1)),s.digital_out.value&&124&this.getValue(s)?(this.state[e].errors.push({visible:!0,error:"Can't set "+this.getFlagNames(124&this.getValue(s))+" option for output pins"}),new Promise(((e,t)=>e(this.setState(this.state)))),!1):!(s.touch.value&&12&this.getValue(s))||(this.state[e].errors.push({visible:!0,error:"Can't set "+this.getFlagNames(12&this.getValue(s))+" option for touch pins"}),new Promise(((e,t)=>e(this.setState(this.state)))),!1)}onChange(e,t){return!!this.isValidChange(e,t)&&(this.state[e].value=t,this.props.onChange(this.getValue(this.state)),!0)}getErrors(t){return t.errors.map(((t,s)=>e(MaterialUI.Snackbar,{key:`error${s}`,className:"popuperror",anchorOrigin:{vertical:"top",horizontal:"right"},autoHideDuration:3e3,onClose:(e,s)=>{t.visible=!1,this.setState(this.state)},open:t.visible},e(MaterialUI.Alert,{key:`error${s}`,severity:"error"},t.error))))}renderOption(t,s){return[e(MaterialUI.FormControlLabel,{key:t,className:"driverflag",label:t,control:e(MaterialUI.Checkbox,{key:"ctrl",checked:s.value,onChange:e=>this.onChange(t,e.target.checked)})}),...this.getErrors(s)]}render(){return e(MaterialUI.Card,{key:"driver-flags",className:"driver-flags"},[e(MaterialUI.CardHeader,{key:"header",subheader:"Flags"}),e(MaterialUI.CardContent,{key:"details"},e(MaterialUI.List,{key:"items"},Object.keys(this.state).map((e=>this.renderOption(e,this.state[e])))))])}}class StatusPage extends React.Component{constructor(e){super(e),this.mounted=!1,this.state={refreshRate:"Manual"}}componentWillUnmount(){this.mounted=!1}componentDidMount(){this.mounted=!0,this.updateAppStatus(),this.props.registerStateCallback&&this.props.registerStateCallback(this.refreshStatus.bind(this))}getRefreshRate(){return this.state.refreshRate.indexOf("secs")>0?1e3*Number(this.state.refreshRate.replace(/([0-9]+).*/,"$1")):6e4*Number(this.state.refreshRate.replace(/([0-9]+).*/,"$1"))}componentDidUpdate(e,t,s){this.state.refreshRate!==t.refreshRate&&(this.refreshTimer&&clearInterval(this.refreshTimer),"Manual"!==this.state.refreshRate&&(this.refreshTimer=setInterval((()=>{this.updateAppStatus()}),this.getRefreshRate())))}updateAppStatus(){this.updateStatuses([{url:"/status/"},{url:"/status/app"},{url:"/status/tasks",path:"tasks"},{url:"/status/mallocs",path:"mallocs"},{url:"/status/repeating_tasks",path:"repeating_tasks"}],{})}refreshStatus(e){this.mounted&&(e?this.filterProperties(e).then((e=>{const t=Object.keys(e);var s=this.state?.status||{};for(const i in t)s[t[i]]=e[t[i]];this.setState({status:s})})):this.updateAppStatus())}filterProperties(e){return new Promise(((t,s)=>{t(Object.keys(e).filter((t=>!t.match(/^MALLOC_.*/)||0!=e[t])).reduce(((t,s)=>(t[s]=e[s],t)),{}))}))}updateStatuses(e,t){if(window.location.host||httpPrefix){var s=new AbortController,i=setTimeout((()=>s.abort()),4e3);"current"==this.props.selectedDeviceId?this.updateStatus(e.pop(),s,t).then((s=>{clearTimeout(i),document.getElementById("Status").style.opacity=1,this.mounted&&(e.length>0?this.updateStatuses(e,t):this.setState({error:null,status:this.orderResults(t)}))})).catch((s=>{if(document.getElementById("Status").style.opacity=.5,clearTimeout(i),20!=s.code){var a=e.filter((e=>e.error));document.getElementById("Status").style.opacity=.5,a[0]?.waitFor?setTimeout((()=>{s.message,this.updateStatuses(e,t)}),a[0].waitFor):this.updateStatuses(e,t)}})):this.props.selectedDeviceId&&wfetch(`${httpPrefix}/lfs/status/${this.props.selectedDeviceId}.json`,{method:"get",signal:s.signal}).then((e=>e.json())).then(fromVersionedToPlain).then((e=>{this.mounted&&this.setState({status:this.orderResults(e)})}))}}updateStatus(e,t,s){return new Promise(((i,a)=>wfetch(`${httpPrefix}${e.url}`,{method:"post",signal:t.signal}).then((e=>e.json())).then(this.filterProperties.bind(this)).then((t=>{e.path?s[e.path]=Object.values(t):Object.assign(s,t),i({path:e.path,stat:t})})).catch((t=>{e.retryCnt=1+(0|e.retryCnt),e.waitFor=1e3,e.error=t,a(t)}))))}orderResults(e){var t={};return Object.keys(e).filter((t=>"object"!=typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>"object"==typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>Array.isArray(e[t]))).forEach((s=>t[s]=e[s])),t}render(){return this.state?.status?[e("div",{key:"buttonbar",className:"buttonbar"},[e("button",{key:"refresh",onClick:e=>this.updateAppStatus()},"Refresh"),e(MaterialUI.FormControl,{key:"refreshRate"},[e(MaterialUI.InputLabel,{key:"label",className:"label",id:"stat-refresh-label"},"Refresh Rate"),e(MaterialUI.Select,{key:"options",id:"stat-refresh",labelId:"stat-refresh-label",label:"Refresh Rate",value:this.state.refreshRate,onChange:e=>this.setState({refreshRate:e.target.value})},["Manual","2 secs","5 secs","10 secs","30 secs","1 mins","5 mins","10 mins","30 mins","60 mins"].map(((t,s)=>e(MaterialUI.MenuItem,{key:s,value:t},t))))])]),e(LocalJSONEditor,{key:"StateViewer",path:"/",json:this.state.status,editable:!1,sortable:!0,selectedDeviceId:this.props.selectedDeviceId,registerStateCallback:this.props.registerStateCallback,registerEventInstanceCallback:this.props.registerEventInstanceCallback})]:e("div",{key:genUUID()},"Loading...")}}class ConfigPage extends React.Component{componentDidMount(){if(this.isConnected()){var e=new AbortController,t=setTimeout((()=>e.abort()),4e3);wfetch(`${httpPrefix}/config/${"current"==this.props.selectedDeviceId?"":this.props.selectedDeviceId+".json"}`,{method:"post",signal:e.signal}).then((e=>e.json())).then((e=>{clearTimeout(t),this.setState({config:fromVersionedToPlain(e),newconfig:fromVersionedToPlain(e),original:e})}))}}buildEditor(){try{this.jsoneditor?this.jsoneditor.set(this.state.config):this.jsoneditor=new JSONEditor(this.container,{onChangeJSON:e=>this.state.newconfig=e},this.state.config)}catch(t){this.nativejsoneditor=e(LocalJSONEditor,{key:"ConfigEditor",path:"/",json:this.state.config,selectedDeviceId:this.props.selectedDeviceId,editable:!0})}}componentDidUpdate(e,t,s){!this.state?.config||this.nativejsoneditor||this.jsoneditor||this.buildEditor()}getEditor(){return[e("div",{key:"fancy-editor",ref:e=>this.container=e,id:`${this.props.id||genUUID()}`,"data-theme":"spectre"}),this.nativejsoneditor]}getEditorGroups(){return e(ConfigGroup,{key:"configGroups",config:this.state?.newconfig,onChange:e=>{this.jsoneditor.set(this.state.newconfig),this.setState(this.state)}})}saveChanges(){var e=new AbortController,t=setTimeout((()=>e.abort()),4e3);wfetch(`${httpPrefix}/config`,{method:"put",signal:e.signal,body:JSON.stringify(fromPlainToVersionned(this.state.newconfig,this.state.original))}).then((e=>e.json())).then(fromVersionedToPlain).then((e=>{clearTimeout(t),this.setState({config:e})})).catch(console.err)}render(){return this.isConnected()&&this.state?.config?[e("div",{key:"button-bar",className:"button-bar"},[e("button",{key:"refresh",onClick:e=>this.componentDidMount()},"Refresh"),e("button",{key:"save",onClick:this.saveChanges.bind(this)},"Save")]),this.getEditorGroups(),this.getEditor()]:e("div",{key:genUUID()},"Loading....")}isConnected(){return window.location.host||httpPrefix}}class TypedField extends React.Component{render(){return[e("div",{key:genUUID(),className:this.props.type},this.props.type),this.props.path?e("div",{key:genUUID(),className:"path"},this.props.path):null]}}class LitteralField extends React.Component{render(){return e("div",{key:genUUID(),className:"litteral"},this.props.value)}}class EventField extends React.Component{render(){return e("div",{key:genUUID(),className:"conditionField"},this.props.name?e(TypedField,{key:genUUID(),type:this.props.name,value:this.props.value,path:this.props.path}):e(LitteralField,{key:genUUID(),value:this.props.value}))}}class EventCondition extends React.Component{render(){return e("div",{key:genUUID(),className:"condition"},[e(EventField,{key:genUUID(),...this.props.src}),e("div",{key:genUUID(),className:"operator"},this.props.operator),e(EventField,{key:genUUID(),...this.props.comp})])}}class EventConditions extends React.Component{render(){return e("details",{key:genUUID(),className:"conditions "+(0==this.props.conditions.length?"hidden":"")},[e("summary",{key:genUUID()},"Conditions"),this.props.conditions.map((t=>e(EventCondition,{key:genUUID(),...t})))])}}class EventLine extends React.Component{render(){return"conditions"==this.props.name?e(EventConditions,{key:genUUID(),className:this.props.name,conditions:this.props.value}):Array.isArray(this.props.value)?this.props.value.length>0?e("details",{key:genUUID(),className:`arrayfield ${this.props.name}`},e("summary",{key:genUUID(),className:"name"},this.props.name),this.props.value.map((t=>e("div",{key:genUUID(),className:"arrayItem"},Object.keys(t).map((s=>e(EventLine,{key:genUUID(),name:s,value:t[s]}))))))):null:"object"==typeof this.props.value?Object.keys(this.props.value).length>0?e("details",{key:genUUID(),className:`object ${this.props.name}`},[e("summary",{key:genUUID(),className:"object name"},this.props.name),Object.keys(this.props.value).map((t=>e("details",{key:genUUID(),className:"name"},[e("summary",{key:genUUID()},t),e("div",{key:genUUID(),className:t},this.props.value[t])])))]):null:e("details",{key:genUUID(),className:this.props.name},[e("summary",{key:genUUID()},this.props.name),this.props.value])}}class Event extends React.Component{render(){return e("details",{key:genUUID(),className:"event"},[e("summary",{key:genUUID(),className:"name"},[e("div",{key:genUUID(),className:"eventBase"},this.props.eventBase),e("div",{key:genUUID(),className:"eventId"},this.props.eventId)]),Object.keys(this.props).filter((e=>"name"!=e)).map((t=>e(EventLine,{key:genUUID(),name:t,value:this.props[t]})))])}}class LiveEvent extends React.Component{render(){return this.props?.event?.dataType?this.renderComponent(this.props.event):e("summary",{key:"summary",className:"liveEvent"},e("div",{key:"description",className:"description"},[e("div",{key:"base",className:"eventBase"},"Loading"),e("div",{key:"id",className:"eventId"},"...")]))}renderComponent(t){return e("summary",{key:"event",className:"liveEvent"},[e("div",{key:"description",className:"description"},[e("div",{key:"base",className:"eventBase"},t.eventBase),e("div",{key:"id",className:"eventId"},t.eventId)]),t.data?e("details",{key:"details",className:"data"},this.parseData(t)):null])}parseData(t){return"Number"==t.dataType?e("div",{key:t.data.name,className:"description"},e("div",{key:"data",className:"propNumber"},t.data)):Object.keys(t.data).filter((e=>"object"!=typeof t.data[e]&&!Array.isArray(t.data[e]))).map((s=>e("div",{key:s,className:"description"},[e("div",{key:"name",className:"propName"},s),e("div",{key:"data",className:s},t.data[s])])))}}class LiveEventPannel extends React.Component{constructor(e){super(e),this.eventTypes=[],this.eventTypeRequests=[],this.props.registerEventCallback&&this.props.registerEventCallback(this.ProcessEvent.bind(this)),this.mounted=!1,this.state={filters:{}}}componentDidMount(){this.mounted=!0}componentWillUnmount(){this.mounted=!1}ProcessEvent(e){if(e&&this.mounted&&this.isEventVisible(e)){for(var t=(this.state?.lastEvents||[]).concat(e);t.length>100;)t.shift();this.setState({filters:this.updateFilters(t),lastEvents:t})}}updateFilters(e){var t=Object.entries(e.filter((e=>e&&e.eventBase&&e.eventId)).reduce(((e,t)=>(e[t.eventBase]?e[t.eventBase].eventIds.find((e=>e.eventId===t.eventId))||e[t.eventBase].eventIds.push({visible:!0,eventId:t.eventId}):e[t.eventBase]={visible:!0,eventIds:[{visible:!0,eventId:t.eventId}]},e)),{}));return Object.values(t).forEach((e=>{this.state.filters[e[0]]?e[1].eventIds.find((t=>!this.state.filters[e[0]].eventIds.find((e=>e.eventId===t.eventId))))&&(this.state.filters[e[0]].eventIds=this.state.filters[e[0]].eventIds.concat(e[1].eventIds.filter((t=>!this.state.filters[e[0]].eventIds.find((e=>t.eventId===e.eventId)))))):this.state.filters[e[0]]=e[1]})),this.state.filters}parseEvent(e){var t=this.eventTypes.find((t=>t.eventBase==e.eventBase&&t.eventName==e.eventId));return t?{dataType:t.dataType,...e}:(!this.eventTypeRequests.find((t=>t.eventBase==e.eventBase&&t.eventId==e.eventId))&&this.mounted&&this.getEventDescriptor(e).then((e=>this.setState({lastState:this.state.lastEvents.map((t=>t.eventBase==e.eventBase&&t.eventId==e.eventName?{dataType:e.dataType,...t}:{event:t}))}))),{...e})}getEventDescriptor(e){var t;return this.eventTypeRequests.push(t={waiters:[],...e}),new Promise(((s,i)=>{var a=this.eventTypes.find((t=>t.eventBase==e.eventBase&&t.eventName==e.eventId));if(a)s({dataType:a.dataType,...e});else{var r=new AbortController;const a=setTimeout((()=>r.abort()),3e3);wfetch(`${httpPrefix}/eventDescriptor/${e.eventBase}/${e.eventId}`,{method:"post",signal:r.signal}).then((e=>(clearTimeout(a),e.json()))).then((e=>{this.eventTypes.push(e),s(e)})).catch((e=>{clearTimeout(a),t.waiters.forEach((t=>{t.reject(e)})),i(e)}))}}))}updateEventIdFilter(e,t){e.visible=t,this.setState({filters:this.state.filters})}updateEventBaseFilter(e,t){e.visible=t,this.setState({filters:this.state.filters})}filterPanel(){return e("div",{key:"filterPanel",className:"filterPanel"},[e("div",{key:"filters",className:"filters"},[e("div",{key:"label",className:"header"},"Filters"),e("div",{key:"filterlist",className:"filterlist"},Object.entries(this.state.filters).map(this.renderFilter.bind(this)))]),e("div",{key:"control",className:"control"},[this.state?.lastEvents?e("div",{key:"label",className:"header"},`${this.state.lastEvents.length}/${this.state.lastEvents.filter(this.isEventVisible.bind(this)).length} event${this.state?.lastEvents?.length?"s":""}`):"No events",e("button",{key:"clearbtn",onClick:e=>this.setState({lastEvents:[]})},"Clear")])])}renderFilter(t){return e("div",{key:t[0],className:`filter ${t[0]}`},e("div",{key:"evbfiltered",className:"evbfiltered"},e(MaterialUI.FormControlLabel,{key:"visible",className:"ebfiltered",label:t[0],control:e(MaterialUI.Checkbox,{key:"ctrl",checked:t[1].visible,onChange:e=>this.updateEventIdFilter(t[1],e.target.checked)})})),e("div",{key:"filterList",className:"eventIds"},t[1].eventIds.map((t=>e("div",{key:t.eventId,className:`filteritem ${t.eventId}`},[e("div",{key:"evifiltered",className:"evifiltered"},e(MaterialUI.FormControlLabel,{key:t.eventId,className:"eifiltered",label:t.eventId,control:e(MaterialUI.Checkbox,{key:"ctrl",checked:t.visible,onChange:e=>this.updateEventIdFilter(t,e.target.checked)})}))])))))}isEventVisible(e){return e&&(0===Object.keys(this.state.filters).length||!this.state.filters[e.eventBase]?.eventIds?.some((t=>t.eventId===e.eventId)))||Object.keys(this.state.filters).some((t=>e.eventBase===t&&this.state.filters[t].visible))&&Object.keys(this.state.filters).some((t=>e.eventBase===t&&this.state.filters[t].eventIds.some((t=>t.eventId===e.eventId&&t.visible))))}getFilteredEvents(){return e("div",{key:"eventList",className:"eventList"},this.state?.lastEvents?.filter(this.isEventVisible.bind(this)).map(((t,s)=>e(LiveEvent,{key:s,event:this.parseEvent(t)}))).reverse())}render(){return e("div",{key:"eventPanel",className:"eventPanel"},[this.filterPanel(),this.getFilteredEvents()])}}class EventsPage extends React.Component{componentWillUnmount(){this.mounted=!1}componentDidMount(){this.mounted=!0,(window.location.hostname||httpPrefix)&&this.getJsonConfig().then((e=>this.mounted?this.setState({events:e.events,programs:e.programs}):null))}getJsonConfig(){return new Promise(((e,t)=>{if(window.location.hostname||httpPrefix){const s=setTimeout((()=>this.props.pageControler.abort()),3e3);wfetch(`${httpPrefix}/config${"current"==this.props.selectedDeviceId?"":`/${this.props.selectedDeviceId}`}`,{method:"post",signal:this.props.pageControler.signal}).then((e=>(clearTimeout(s),e.json()))).then((t=>e(fromVersionedToPlain(t)))).catch((e=>{clearTimeout(s),t(e)}))}else t({error:"Not connected"})}))}render(){return this.state?.events?[e(LiveEventPannel,{key:"eventpannel",registerEventCallback:this.props.registerEventCallback})]:e("div",{key:"loading"},"Loading.....")}}class FirmwareUpdater extends React.Component{constructor(e){super(e),this.state={}}UploadFirmware(e){if(e.preventDefault(),this.setState({loaded:`Sending ${this.state.len} firmware bytes`}),this.state.fwdata&&this.state.md5)return wfetch(`${httpPrefix}/ota/flash?md5=${this.state.md5}&len=${this.state.len}`,{method:"post",body:this.state.fwdata}).then((e=>e.text())).then((e=>this.setState({loaded:e})))}waitForDevFlashing(){var e=new AbortController,t=setTimeout((()=>{e.abort()}),1e3);wfetch(`${httpPrefix}/status/app`,{method:"post",signal:e.signal}).then((e=>(clearTimeout(t),e.json()))).then((e=>this.setState({waiter:null,loaded:`Loaded version ${e.build.ver} built on ${e.build.date}`}))).catch((e=>{clearTimeout(t),this.setState({waiter:setTimeout((()=>this.waitForDevFlashing()),500)})}))}componentDidUpdate(e,t,s){if("Flashing"==this.state.loaded&&null==this.state.waiter&&this.waitForDevFlashing(),this.state.firmware&&!this.state.md5){this.state.md5="loading";var i=new FileReader;i.onload=()=>{var e=i.resultString||i.result,t=CryptoJS.algo.SHA256.create();t.update(CryptoJS.enc.Latin1.parse(i.result)),this.state.fwdata=new Uint8Array(this.state.firmware.size);for(var s=0;s<e.length;s++)this.state.fwdata[s]=e.charCodeAt(s);this.setState({md5:t.finalize().toString(CryptoJS.enc.Hex),fwdata:this.state.fwdata,len:this.state.firmware.size})},i.onprogress=e=>this.setState({loaded:1*this.state.firmware.size/(1*e.loaded)*100+"% loaded"}),i.onerror=e=>this.setState({md5:null,firmware:null,error:e.textContent}),i.onabort=e=>this.setState({md5:null,firmware:null,error:"Aborted"}),i.readAsBinaryString(this.state.firmware)}}render(){return e("form",{key:genUUID(),onSubmit:this.UploadFirmware.bind(this)},e("fieldset",{key:genUUID()},[e("input",{key:genUUID(),type:"file",name:"firmware",onChange:e=>this.setState({firmware:e.target.files[0]})}),e("button",{key:genUUID()},"Upload"),e("div",{key:genUUID()},this.state?.loaded)]))}}class ProgramLine extends React.Component{render(){return Array.isArray(this.props.value)?e("details",{key:genUUID(),className:`arrayfield ${this.props.name}`},e("summary",{key:genUUID(),className:"name"},this.props.name),this.props.value.map((t=>e("div",{key:genUUID(),className:"arrayItem"},Object.keys(t).map((s=>e(ProgramLine,{key:genUUID(),name:s,value:t[s]}))))))):"object"==typeof this.props.value?e("details",{key:genUUID(),className:`object ${this.props.name}`},[e("summary",{key:genUUID(),className:"object name"},this.props.name),Object.keys(this.props.value).map((t=>e("details",{key:genUUID(),className:"name"},[e("summary",{key:genUUID()},t),e("div",{key:genUUID(),className:t},this.props.value[t])])))]):e("details",{key:genUUID(),className:this.props.name},[e("summary",{key:genUUID()},this.props.name),this.props.value])}}class Program extends React.Component{render(){return e("details",{key:genUUID(),className:"program"},[e("summary",{key:genUUID(),className:"name"},this.props.name),Object.keys(this.props).filter((e=>"name"!=e)).map((t=>e(ProgramLine,{key:genUUID(),name:t,value:this.props[t]})))])}}class TripWithin extends React.Component{getIconColor(){return this.state?.points?this.props.points.length?"aquamarine":"#ff0000":"#00ff00"}getIcon(){return e("svg",{key:"svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64",onClick:e=>this.setState({viewer:"trip"})},[e("path",{key:"path1",style:{fill:this.getIconColor()},d:"M17.993 56h20v6h-20zm-4.849-18.151c4.1 4.1 9.475 6.149 14.85 6.149 5.062 0 10.11-1.842 14.107-5.478l.035.035 1.414-1.414-.035-.035c7.496-8.241 7.289-20.996-.672-28.957A20.943 20.943 0 0 0 27.992 2a20.927 20.927 0 0 0-14.106 5.477l-.035-.035-1.414 1.414.035.035c-7.496 8.243-7.289 20.997.672 28.958zM27.992 4.001c5.076 0 9.848 1.976 13.437 5.563 7.17 7.17 7.379 18.678.671 26.129L15.299 8.892c3.493-3.149 7.954-4.891 12.693-4.891zm12.696 33.106c-3.493 3.149-7.954 4.892-12.694 4.892a18.876 18.876 0 0 1-13.435-5.563c-7.17-7.17-7.379-18.678-.671-26.129l26.8 26.8z"}),e("path",{key:"path2",style:{fill:this.getIconColor()},d:"M48.499 2.494l-2.828 2.828c4.722 4.721 7.322 10.999 7.322 17.678s-2.601 12.957-7.322 17.678S34.673 48 27.993 48s-12.957-2.601-17.678-7.322l-2.828 2.828C12.962 48.983 20.245 52 27.993 52s15.031-3.017 20.506-8.494c5.478-5.477 8.494-12.759 8.494-20.506S53.977 7.97 48.499 2.494z"})])}render(){return e("div",{key:"renderedtrip",className:"rendered trip"},[this.getIcon(),"trip"==this.state?.viewer?e(TripViewer,{key:"tripviewer",points:this.props.points,cache:this.props.cache,onClose:()=>this.setState({viewer:""})}):null])}}class FileViewer extends React.Component{constructor(e){super(e),this.state={renderers:[]}}componentDidMount(){this.props.registerFileWork&&this.props.registerFileWork(this.buildRenderers(0))}buildRenderers(e){return new Promise(((t,s)=>{this.props.name.endsWith(".csv")&&!this.state?.renderers?.some("trip")?(this.setState({renderers:[{name:"loading"}]}),this.parseCsv(t,e,s)):this.props.name.endsWith(".log")&&!this.state?.renderers?.some("trip")?(this.setState({renderers:[{name:"loading"}]}),this.parseLog(t,e,s)):t()}))}parseLog(e,t,s){wfetch(`${httpPrefix}${this.props.folder}/${this.props.name}`).then((e=>e.text())).then((t=>e(this.setState({renderers:[{name:"trip",points:t.split("\n").filter((e=>e.match(/[ID] \([0-9]{2}:[0-9]{2}:[0-9]{2}[.][0-9]{3}\).* Location:.*/))).map((e=>e.match(/[ID] \((?<timestamp>.*)\).*Location:\s*(?<latitude>[0-9.-]+),\s*(?<longitude>[0-9.-]+).*speed:\s*(?<speed>[0-9.]+).*altitude:\s*(?<altitude>[0-9.]+).*course:\s*(?<course>[0-9.]+).*bat:\s*(?<Battery>[0-9.]+)/i)?.groups)).filter((e=>e)).map((e=>(Object.keys(e).forEach((t=>e[t]=isNaN(e[t])?e[t]:parseFloat(e[t]))),e.timestamp=`1970-01-01 ${e.timestamp}`,e.altitude*=100,e.speed*=100,e)))}]})))).catch((e=>{t++<3?this.buildRenderers(t):s(e)}))}parseCsv(e,t,s){wfetch(`${httpPrefix}${this.props.folder}/${this.props.name}`).then((e=>e.text())).then((t=>{var s=t.split(/\n|\r\n/)[0].split(",");e(this.setState({renderers:[{name:"trip",points:t.split(/\n|\r\n/).splice(1).map((e=>{var t={};return e.split(",").forEach(((e,i)=>t[s[i]]=isNaN(e)?e:parseFloat(e))),t})).filter((e=>e.timestamp&&e.timestamp.match(/[0-9]{4}\/[0-9]{2}\/[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}/)))}]}))})).catch((e=>{t++<3?this.buildRenderers(t):s(e)}))}getRenderers(){return this.state?.renderers&&this.state.renderers.length?this.state.renderers.map((t=>{switch(t.name){case"trip":return t.points.length?e(TripWithin,{key:"tripwithin",points:t.points,cache:this.props.cache}):null;case"loading":return e("i",{className:"rendered reportbtn fa fa-spinner",key:"graphbtn"});default:return null}})):null}render(){return[e("a",{key:"filelink",href:`${httpPrefix}${this.props.folder}/${this.props.name}`},this.props.name.split("/").reverse()[0]),this.getRenderers()]}}class SFile extends React.Component{render(){return e("tr",{key:"tr",className:this.props.file.ftype},[e("td",{key:"link"},this.getLink(this.props.file)),e("td",{key:"size"},"file"!=this.props.file.ftype?"":this.props.file.size),e("td",{key:"delete"},this.getDeleteLink())])}getDeleteLink(){return"/"==this.props.path||".."==this.props.file.name?null:e("a",{key:"delete",href:"#",onClick:()=>{wfetch(`${httpPrefix}/stat${"/"===this.props.path?"":this.props.path}/${this.props.file.name}`,{method:"post",headers:{ftype:"file"==this.props.file.ftype?"file":"directory",operation:"delete"}}).then(this.props.OnDelete?this.props.OnDelete():null).catch((e=>{}))}},"Del")}getLink(t){return"folder"==t.ftype?e("a",{key:t.name,href:"#",onClick:()=>this.props.onChangeFolder?this.props.onChangeFolder(`${t.folder||"/"}${".."==t.name?"":"/"+t.name}`.replaceAll("//","/")):null},t.name):e(FileViewer,{key:t.name,cache:this.props.cache,registerFileWork:this.props.registerFileWork,...t})}}class StorageViewer extends React.Component{constructor(e){super(e),this.state={loaded:!1,path:"/",files:null,cache:{images:{}},fileWork:[]}}getSystemFolders(){return["/"!=this.state.path?{ftype:"folder",name:"..",folder:dirname(this.state.path)}:null]}GetFileStat(e){this.mounted&&e.forEach((e=>{this.registerFileWork(new Promise(((t,s)=>{wfetch(`${httpPrefix}/stat${e.folder}/${e.name}`,{method:"post"}).then((s=>{s.json().then((s=>{e.size=s.size,t(this.setState({loaded:!0,files:this.state.files,total:this.state?.total+s.size}))}))})).catch((e=>{s(e)}))})))}))}fetchFiles(){if(window.location.host||httpPrefix){var e=new AbortController,t=setTimeout((()=>e.abort()),3e3);wfetch(`${httpPrefix}/files`+this.state.path,{method:"post",signal:e.signal}).then((e=>{clearInterval(t),e.json().then((e=>e.sort(((e,t)=>e.ftype!=t.ftype?"folder"==e.ftype?1:-1:e.name==t.name?0:e.name>t.name?1:-1)))).then((e=>{if(this.mounted){this.setState({loaded:!0,files:e,total:e.reduce(((e,t)=>e+t.size),0)});for(var t=e.filter((e=>"file"==e.ftype&&!e.size)),s=0;s<Math.min(3,t.length);s++)t.length&&this.GetFileStat(t)}}))})).catch(console.error)}}componentDidUpdate(e,t){this.state.loaded||(this.state.loaded=!0),t&&t.path!=this.state.path&&this.fetchFiles()}componentDidMount(){this.mounted=!0,this.state?.files||this.fetchFiles()}componentWillUnmount(){this.mounted=!1}SortTable(e){var t;Array.from((t=e.target.closest("div.file-table").querySelector("tbody")).querySelectorAll("tr:nth-child(n+2)")).sort(comparer(Array.from(e.target.parentNode.children).indexOf(e.target),this.asc=!this.asc)).forEach((e=>t.appendChild(e)))}getTableHeader(){return e("thead",{key:"head"},e("tr",{key:"row"},["Name","Size"].map((t=>e("th",{key:t,onClick:this.SortTable.bind(this)},t))).concat(e("th",{key:"op"},"Op"))))}registerFileWork(e){this.setState({fileWork:[...this.state.fileWork,e]})}render(){return this.state?.files?e("div",{key:"Files",className:"file-table "+(this.state.loaded?"":"loading")},e("table",{key:"table",className:"greyGridTable"},[e("caption",{key:"caption"},this.state.path),this.getTableHeader(),e("tbody",{key:"body"},this.getSystemFolders().concat(this.state.files).filter((e=>e)).map((t=>e(SFile,{key:t.name,file:t,cache:this.state.cache,path:this.state.path,registerFileWork:this.registerFileWork.bind(this),onChangeFolder:e=>this.setState({path:e,files:[]}),OnDelete:()=>this.fetchFiles()})))),e("tfoot",{key:"tfoot"},e("tr",{key:"trow"},[e("td",{key:"totallbl"},"Total"),e("td",{key:"total"},this.state.total)]))])):e("div",{key:"Loading"},"Loading......")}}class LogLine extends React.Component{isScrolledIntoView(){var e=this.logdiv.getBoundingClientRect(),t=e.top,s=e.bottom;return t>=0&&s<=window.innerHeight}render(){var t=this.props.logln.match(/^[^IDVEW]*(.+)/)[1],s=t.substr(0,1),i=t.match(/.*\) ([^:]*)/g)[0].replaceAll(/^.*\) (.*)/g,"$1"),a=this.props.logln.substr(this.props.logln.indexOf(i)+i.length+2).replaceAll(/^[\r\n]*/g,"").replaceAll(/[^0-9a-zA-Z ]\[..\n.*/g,"");return e("div",{key:"logLine",className:`log LOG${s}`},[e("div",{key:"level",ref:e=>this.logdiv=e,className:"LOGLEVEL"},s),e("div",{key:"date",className:"LOGDATE"},t.substr(3,12)),e("div",{key:"source",className:"LOGFUNCTION"},i),e("div",{key:"message",className:"LOGLINE"},a)])}}class LogLines extends React.Component{constructor(e){super(e),this.state={logLines:[],logLevels:{}},this.props.registerLogCallback&&this.props.registerLogCallback(this.AddLogLine.bind(this))}AddLogLine(e){if(!this.state.logLines.some((t=>t===e))){var t=-1,s=e.match(/^[^IDVEW]*(.+)/)[1],i=s.substr(0,1),a=s.substr(3,12),r=s.match(/.*\) ([^:]*)/g)[0].replaceAll(/^.*\) (.*)/g,"$1");for(this.state.logLines.some(((e,t)=>{var n=e.match(/^[^IDVEW]*(.+)/)[1],o=n.substr(0,1),l=n.substr(3,12),h=s.match(/.*\) ([^:]*)/g)[0].replaceAll(/^.*\) (.*)/g,"$1");return o==i&&l==a&&h==r}))&&(t=this.state.logLines.length);this.state.logLines.length>500;)this.state.logLines.shift();void 0===this.state.logLevels[i]&&(this.state.logLevels[i]={visible:!0}),void 0===this.state.logLevels[i][r]&&(this.state.logLevels[i][r]=!0),t>=0?this.state.logLines[t]=e:this.state.logLines=[...this.state?.logLines||[],e],this.setState(this.state)}}renderLogFunctionFilter(t,s,i){return e(MaterialUI.FormControlLabel,{key:"ffiltered"+t+s,className:"effiltered",label:`${s} (${i.filter((e=>e.match(/.*\) ([^:]*)/g)[0].replaceAll(/^.*\) (.*)/g,"$1")==s)).length})`,control:e(MaterialUI.Checkbox,{key:"ctrl",checked:this.state.logLevels[t][s],onChange:e=>{this.state.logLevels[t][s]=e.target.checked,this.setState(this.state)}})})}renderLogLevelFilterControl(t,s){return e(MaterialUI.FormControlLabel,{key:"lfiltered"+t,className:"elfiltered",label:`Log Level ${t}(${s.length})`,control:e(MaterialUI.Checkbox,{key:"ctrl",checked:this.state.logLevels[t].visible,onChange:e=>{this.state.logLevels[t].visible=e.target.checked,this.setState(this.state)}})})}renderLogFunctionFilters(e,t){return Object.keys(this.state.logLevels[e]).filter((e=>"visible"!==e)).map((s=>this.renderLogFunctionFilter(e,s,t)))}renderLogLevelFilter(t,s){return e("div",{key:"logLevelFilter"+t,className:"logLevelFilter"},[e("div",{key:"logLevelFilterTitle"+t,className:"logLevelFilterTitle"},this.renderLogLevelFilterControl(t,s)),e("div",{key:"logLevelFilterContent"+t,className:"logLevelFilterContent"},this.renderLogFunctionFilters(t,s))])}renderLogLevelFilters(){return Object.keys(this.state.logLevels).map((e=>this.renderLogLevelFilter(e,this.state.logLines.filter((t=>t.match(/^[^IDVEW]*(.+)/)[1].substr(0,1)==e)))))}renderFilterPannel(){return e("div",{key:"filterPannel",className:"filterPannel"},[e("div",{key:"filterPannelTitle",className:"filterPannelTitle"},"Filters"),e("div",{key:"filterPannelContent",className:"filterPannelContent"},this.renderLogLevelFilters())])}renderControlPannel(){return e("div",{key:"logControlPannel",className:"logControlPannel"},[e("button",{key:"clear",onClick:e=>this.setState({logLines:[]})},"Clear Logs"),this.renderFilterPannel()])}isLogVisible(e){var t=e.match(/^[^IDVEW]*(.+)/)[1],s=t.substr(0,1),i=t.match(/.*\) ([^:]*)/g)[0].replaceAll(/^.*\) (.*)/g,"$1");return!(!this.state.logLevels[s].visible||!this.state.logLevels[s][i])}render(){return e("div",{key:"logContainer",className:"logContainer"},[this.renderControlPannel(),e("div",{key:"logLines",className:"loglines"},this.state?.logLines?this.state.logLines.filter(this.isLogVisible.bind(this)).map(((t,s)=>e(LogLine,{key:s,logln:t}))):null)])}}class SystemPage extends React.Component{SendCommand(e){return wfetch(`${httpPrefix}/status/cmd`,{method:"PUT",body:JSON.stringify(e)}).then((e=>e.text().then(console.log))).catch(console.error).catch(console.error)}render(){return[e("div",{key:"logpannel",className:"logpannel"},[e("button",{key:"reboot",onClick:e=>this.SendCommand({command:"reboot"})},"Reboot"),e("button",{key:"parseFiles",onClick:e=>this.SendCommand({command:"parseFiles"})},"Parse Files"),e("button",{key:"factoryReset",onClick:e=>this.SendCommand({command:"factoryReset"})},"Factory Reset"),e(FirmwareUpdater,{key:"firmwareUpdater"})])]}}class TripViewer extends React.Component{constructor(e){super(e),this.state={cache:this.props.cache,zoomlevel:15,latitude:0,longitude:0},this.testing=!1}componentDidMount(){this.getTripTiles(),this.firstRender=!0}componentDidUpdate(e,t,s){e.points&&e.points.length&&e.points.length&&e.points.length==this.props.points.length||(this.firstRender=!0),this.mapCanvas=this.mapWidget.getContext("2d"),this.tripCanvas=this.tripWidget.getContext("2d"),this.popupCanvas=this.popupWidget.getContext("2d"),this.popupWidget.addEventListener("mousemove",this.mouseEvent.bind(this)),window.requestAnimationFrame(this.drawMap.bind(this))}drawMap(){this.mapWidget&&this.props.points&&this.props.points.length&&!this.state.closed&&(this.drawTripVisibleTiles(),this.drawTrip(),this.drawPointPopup())}getTripTiles(){var e=void 0;this.state.points=this.props.points.map(this.pointToCartesian.bind(this)).filter((e=>e.latitude&&e.longitude)).filter((e=>e.latitude>-90&&e.latitude<90)).filter((e=>e.longitude>-180&&e.longitude<180)).filter((t=>!(void 0!==e&&Math.abs(e.longitude-t.longitude)>1||(e=t,0)))),this.state.trip={leftTile:this.state.points.reduce(((e,t)=>e<t.tileX?e:t.tileX),99999),rightTile:this.state.points.reduce(((e,t)=>e>t.tileX?e:t.tileX),-99999),bottomTile:this.state.points.reduce(((e,t)=>e<t.tileY?e:t.tileY),99999),topTile:this.state.points.reduce(((e,t)=>e>t.tileY?e:t.tileY),-99999)},this.state.maxXTiles=Math.ceil(window.innerWidth/256)+1,this.state.maxYTiles=Math.ceil(window.innerHeight/256)+1,this.state.trip.XTiles=this.state.trip.rightTile-this.state.trip.leftTile+1,this.state.trip.YTiles=this.state.trip.topTile-this.state.trip.bottomTile+1,this.state.margin={left:this.state.maxXTiles>this.state.trip.XTiles?Math.floor((this.state.maxXTiles-this.state.trip.XTiles)/2):0,bottom:this.state.maxYTiles>this.state.trip.YTiles?Math.floor((this.state.maxYTiles-this.state.trip.YTiles)/2):0},this.state.margin.right=this.state.maxXTiles>this.state.trip.XTiles?this.state.maxXTiles-this.state.trip.XTiles-this.state.margin.left:0,this.state.margin.top=this.state.maxYTiles>this.state.trip.YTiles?this.state.maxYTiles-this.state.trip.YTiles-this.state.margin.bottom:0,this.state.leftTile=Math.max(0,this.state.trip.leftTile-this.state.margin.left),this.state.rightTile=this.state.trip.rightTile+this.state.margin.right,this.state.bottomTile=Math.max(0,this.state.trip.bottomTile-this.state.margin.bottom),this.state.topTile=this.state.trip.topTile+this.state.margin.top,this.state.leftlatitude=this.state.points.reduce(((e,t)=>e<t.latitude?e:t.latitude),99999),this.state.rightlatitude=this.state.points.reduce(((e,t)=>e>t.latitude?e:t.latitude),-99999),this.state.toplongitude=this.state.points.reduce(((e,t)=>e<t.longitude?e:t.longitude),99999),this.state.bottomlongitude=this.state.points.reduce(((e,t)=>e>t.longitude?e:t.longitude),-99999),this.state.latitude=this.state.leftlatitude+(this.state.rightlatitude-this.state.leftlatitude)/2,this.state.longitude=this.state.toplongitude+(this.state.bottomlongitude-this.state.toplongitude)/2,this.state.windowTiles={center:{tileX:this.lon2tile(this.state.longitude,this.state.zoomlevel),tileY:this.lat2tile(this.state.latitude,this.state.zoomlevel)}},this.state.windowTiles.leftTile=this.state.windowTiles.center.tileX-Math.floor(this.state.maxXTiles/2),this.state.windowTiles.rightTile=this.state.windowTiles.center.tileX+Math.floor(this.state.maxXTiles/2),this.state.windowTiles.bottomTile=this.state.windowTiles.center.tileY-Math.floor(this.state.maxYTiles/2),this.state.windowTiles.topTile=this.state.windowTiles.center.tileY+Math.floor(this.state.maxYTiles/2),this.state.windowTiles.XTiles=this.state.windowTiles.rightTile-this.state.windowTiles.leftTile+1,this.state.windowTiles.YTiles=this.state.windowTiles.topTile-this.state.windowTiles.bottomTile+1,this.setState(this.state)}drawTripVisibleTiles(){return new Promise((async(e,t)=>{this.popupWidget.width=256*(this.state.rightTile-this.state.leftTile),this.popupWidget.height=256*(this.state.topTile-this.state.bottomTile),this.mapWidget.width=256*(this.state.rightTile-this.state.leftTile),this.mapWidget.height=256*(this.state.topTile-this.state.bottomTile),this.tripWidget.width=256*(this.state.rightTile-this.state.leftTile),this.tripWidget.height=256*(this.state.topTile-this.state.bottomTile),this.mapCanvas.fillStyle="black",this.mapCanvas.fillRect(0,0,window.innerWidth,window.innerHeight);var s=this.firstRender;if(this.firstRender){this.firstRender=!1;const e=this.mapWidget.getBoundingClientRect();this.mapWidget.parentElement.scrollTo(e.width/2-512,e.height/2-256)}for(var i=this.state.windowTiles.leftTile;i<=this.state.windowTiles.rightTile;i++)for(var a=this.state.windowTiles.bottomTile;a<=this.state.windowTiles.topTile;a++)this.props.cache.images[this.state.zoomlevel]&&this.props.cache.images[this.state.zoomlevel][i]&&this.props.cache.images[this.state.zoomlevel][i][a]?await this.getTileFromCache(i,a).catch(t):await this.addTileToCache(i,a).catch(t);s&&new Promise(((e,t)=>{for(var s=this.state.trip.leftTile;s<=this.state.trip.rightTile;s++)for(var i=this.state.trip.bottomTile;i<=this.state.trip.topTile;i++)this.props.cache.images[this.state.zoomlevel]&&this.props.cache.images[this.state.zoomlevel][s]&&this.props.cache.images[this.state.zoomlevel][s][i]||this.addTileToCache(s,i).catch(t);e()})),e()}))}drawPointPopup(){if(this.focused){this.popupCanvas.clearRect(0,0,this.popupWidget.width,this.popupWidget.height),this.popupCanvas.fillStyle="transparent",this.popupCanvas.fillRect(0,0,window.innerWidth,window.innerHeight),this.popupCanvas.font="12px Helvetica";var e=this.popupCanvas.measureText(new Date(`${this.focused.timestamp} UTC`).toLocaleString()),t=Object.keys(this.focused).filter((e=>"timestamp"!=e&&!e.match(/.*tile.*/i))),s=50+9*t.length,i=e.width+10;this.popupCanvas.strokeStyle="green",this.popupCanvas.shadowColor="#00ffff",this.popupCanvas.fillStyle="#000000",this.popupCanvas.lineWidth=1,this.popupCanvas.shadowBlur=2,this.popupCanvas.beginPath(),this.popupCanvas.rect(this.getClientX(this.focused),this.getClientY(this.focused)-s,i,s),this.popupCanvas.fill(),this.popupCanvas.stroke(),this.popupCanvas.fillStyle="rgba(00, 0, 0, 1)",this.popupCanvas.strokeStyle="#000000",this.popupCanvas.beginPath();var a=this.getClientY(this.focused)-s+e.actualBoundingBoxAscent+3,r=this.getClientX(this.focused)+3;this.popupCanvas.strokeStyle="#97ea44",this.popupCanvas.shadowColor="#ffffff",this.popupCanvas.fillStyle="#97ea44",this.popupCanvas.lineWidth=1,this.popupCanvas.shadowBlur=2,this.popupCanvas.fillText(new Date(`${this.focused.timestamp} UTC`).toLocaleString(),r,a),a+=5,a+=e.actualBoundingBoxAscent+3,t.forEach((t=>{var s=this.getPropValue(t,this.focused[t]);this.popupCanvas.strokeStyle="aquamarine",this.popupCanvas.shadowColor="#ffffff",this.popupCanvas.fillStyle="aquamarine",this.popupCanvas.fillText(`${t}: `,r,a),e=this.popupCanvas.measureText(s),this.popupCanvas.strokeStyle="#97ea44",this.popupCanvas.shadowColor="#ffffff",this.popupCanvas.fillStyle="#97ea44",this.popupCanvas.fillText(s,r+(i-e.width)-5,a),a+=e.actualBoundingBoxAscent+3})),this.popupCanvas.stroke()}}drawTrip(){return new Promise(((e,t)=>{var s=this.state.points[0];s?(this.tripCanvas.fillStyle="transparent",this.tripCanvas.fillRect(0,0,window.innerWidth,window.innerHeight),this.tripCanvas.strokeStyle="#00ffff",this.tripCanvas.shadowColor="#00ffff",this.tripCanvas.fillStyle="#00ffff",this.tripCanvas.lineWidth=2,this.tripCanvas.shadowBlur=2,this.tripCanvas.beginPath(),this.tripCanvas.moveTo(this.getClientX(s),this.getClientY(s)),this.state.points.forEach((e=>{this.tripCanvas.lineTo(this.getClientX(e),this.getClientY(e))})),this.tripCanvas.stroke(),this.tripCanvas.strokeStyle="#0000ff",this.tripCanvas.shadowColor="#0000ff",this.tripCanvas.fillStyle="#0000ff",this.state.points.forEach((e=>{this.tripCanvas.beginPath(),this.tripCanvas.arc(256*(e.tileX-this.state.leftTile)+256*e.posTileX,256*(e.tileY-this.state.bottomTile)+256*e.posTileY,5,0,2*Math.PI),this.tripCanvas.stroke()})),e(this.state)):t({error:"no points"})}))}mouseEvent(e){var t=this.state.points.find((t=>this.getClientX(t)>=e.offsetX-10&&this.getClientX(t)<=e.offsetX+10&&this.getClientY(t)>=e.offsetY-10&&this.getClientY(t)<=e.offsetY+10));t!=this.focused&&(this.focused=t,window.requestAnimationFrame(this.drawPointPopup.bind(this)))}getPropValue(e,t){return"speed"==e?`${Math.floor(1.852*t/100)} km/h`:"altitude"==e?`${Math.floor(t/100)}m`:"longitude"==e||"latitude"==e?t:Math.round(t)}addTileToCache(e,t){return new Promise(((s,i)=>{this.getTile(e,t,0).then((i=>{var a=new Image;a.posX=e-this.state.leftTile,a.posY=t-this.state.bottomTile,a.src=(window.URL||window.webkitURL).createObjectURL(i),this.props.cache.images[this.state.zoomlevel]||(this.props.cache.images[this.state.zoomlevel]={}),this.props.cache.images[this.state.zoomlevel][e]||(this.props.cache.images[this.state.zoomlevel][e]={}),this.props.cache.images[this.state.zoomlevel][e][t]=a,a.onload=e=>{s(this.mapCanvas.drawImage(a,a.posX*a.width,a.posY*a.height))}})).catch(i)}))}getTileFromCache(e,t){return new Promise(((s,i)=>{var a=this.props.cache.images[this.state.zoomlevel][e][t];try{s(this.mapCanvas.drawImage(a,a.posX*a.width,a.posY*a.height))}catch(s){this.props.cache.images[this.state.zoomlevel][e][t]=null,i(s)}}))}downloadTile(e,t){return new Promise(((s,i)=>{var a;wfetch(`https://tile.openstreetmap.de/${this.state.zoomlevel}/${e}/${t}.png`).then((e=>e.blob())).then((i=>wfetch(`${httpPrefix}/sdcard/web/tiles/${this.state.zoomlevel}/${e}/${t}.png`,{method:"put",body:a=i}).then(s(a)).catch(s(a)))).catch(i)}))}drawWatermark(e,t){return new Promise(((e,t)=>this.mapWidget.toBlob(e)))}getTile(e,t,s){return new Promise(((i,a)=>{if(this.testing)return i(this.drawWatermark(e,t));wfetch(`${httpPrefix}/sdcard/web/tiles/${this.state.zoomlevel}/${e}/${t}.png`).then((s=>i(s.status>=300?this.downloadTile(e,t):s.blob()))).catch((r=>{s>3?a({error:`Error in downloading ${this.state.zoomlevel}/${e}/${t}`}):i(this.getTile(e,t,s++))}))}))}getClientY(e){return 256*(e.tileY-this.state.bottomTile)+256*e.posTileY}getClientX(e){return 256*(e.tileX-this.state.leftTile)+256*e.posTileX}lon2tile(e){return Math.floor(this.lon2x(e))}lat2tile(e){return Math.floor(this.lat2y(e))}lon2x(e){return(e+180)/360*Math.pow(2,this.state.zoomlevel)}lat2y(e){return(1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,this.state.zoomlevel)}tile2long(e,t){return e/Math.pow(2,t)*360-180}tile2lat(e,t){var s=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(s)-Math.exp(-s)))}pointToCartesian(e){return{tileX:this.lon2tile(e.longitude,this.state.zoomlevel),tileY:this.lat2tile(e.latitude,this.state.zoomlevel),posTileX:this.lon2x(e.longitude,this.state.zoomlevel)-this.lon2tile(e.longitude,this.state.zoomlevel),posTileY:this.lat2y(e.latitude,this.state.zoomlevel)-this.lat2tile(e.latitude,this.state.zoomlevel),...e}}closeIt(){this.setState({closed:!0}),this.props.onClose&&this.props.onClose()}render(){return e("div",{key:"trip",className:"lightbox "+(this.state?.closed?"closed":"opened")},[e("div",{key:"control"},[e("div",{key:"tripHeader",className:"tripHeader"},[`Trip with ${this.props.points.length} points`,e("br",{key:"daterange"}),`From ${new Date(`${this.props.points[0].timestamp} UTC`).toLocaleString()} `,`To ${new Date(`${this.props.points[this.props.points.length-1].timestamp} UTC`).toLocaleString()} Zoom:`,e("select",{key:"zoom",onChange:e=>this.setState({zoomlevel:e.target.value}),value:this.state.zoomlevel},Array.from(Array(18).keys()).map((t=>e("option",{key:t},t+1))))]),e("span",{key:"close",className:"close",onClick:this.closeIt.bind(this)},"X")]),e("div",{key:"map",className:"trip"},[e("canvas",{key:"mapWidget",className:"mapCanvas",ref:e=>this.mapWidget=e}),e("canvas",{key:"tripWidget",className:"mapCanvas",ref:e=>this.tripWidget=e}),e("canvas",{key:"popupWidget",className:"mapCanvas",ref:e=>this.popupWidget=e})])])}}var app=null;class MainApp extends React.Component{constructor(e){super(e),this.anims=[],app=this,this.state={pageControler:this.GetPageControler(),selectedDeviceId:"current",httpPrefix:httpPrefix,tabs:{Storage:{active:!0},Status:{active:!1},Config:{active:!1},System:{active:!1},Logs:{active:!1},Events:{active:!1}},autoRefresh:!(!httpPrefix&&!window.location.hostname)},this.callbacks={stateCBFn:[],logCBFn:[],eventCBFn:[]},httpPrefix||window.location.hostname||this.lookForDevs(),this.state?.autoRefresh&&(httpPrefix||window.location.hostname)&&this.openWs()}componentDidMount(){app=this,this.mountWidget(),this.mounted=!0}componentWillUnmount(){this.mounted=!1}lookForDevs(){var e=window.webkitRTCPeerConnection||window.mozRTCPeerConnection;e?(()=>{var t=new e({iceServers:[]});function s(e){if(~e.indexOf("a=candidate")){var t=(s=e.split(" "))[4];s[7]}else if(~e.indexOf("c=")){t=(s=e.split(" "))[2].split(".");var s,i=s[1];if("0"===t[0]&&(t[0]=192,t[1]=168,t[2]=0),"IP4"===i&&t[0]){this.state.lanDevices=[];for(var a=254;a>0;a--)t[3]=a,this.state.lanDevices.push(t.join("."));this.state.lanDevices=this.state.lanDevices.sort((()=>.5-Math.random()));var r=[];for(a=0;a<Math.min(10,this.state.lanDevices.length);a++)this.state.lanDevices.length&&this.scanForDevices(this.state.lanDevices,r)}}}t.createDataChannel("",{reliable:!1}),t.onicecandidate=e=>{e.candidate&&s.bind(this)("a="+e.candidate.candidate)},t.createOffer(function(e){e.sdp.split("\r\n").forEach(s.bind(this)),t.setLocalDescription(e)}.bind(this),(e=>{})),Object.create(null)["0.0.0.0"]=!1}).bind(this)():(document.getElementById("list").innerHTML='<code>ifconfig| grep inet | grep -v inet6 | cut -d" " -f2 | tail -n1</code>',document.getElementById("list").nextSibling.textContent="In Chrome and Firefox your IP should display automatically, by the power of WebRTCskull.")}scanForDevices(e,t){if(e.length){var s=e.pop(),i=new AbortController,a=setTimeout((()=>i.abort()),1e3);wfetch(`http://${s}/config/`,{method:"post",signal:i.signal}).then((e=>(clearTimeout(a),!0,e.json()))).then(fromVersionedToPlain).then((i=>{if(i?.deviceid){var a=getInSpot(this.anims.filter((e=>"ping"==e.type&&"chip"==e.from)),"chip");a?a.weight++:(this.anims.push({type:"ping",from:"chip",weight:1,lineColor:"#00ffff",shadowColor:"#000000",fillColor:"#000000",textColor:"#00ffff",startY:30,renderer:this.drawSprite}),window.requestAnimationFrame(this.drawDidget.bind(this))),i.ip=s,t.push(i),httpPrefix||(httpPrefix=`http://${t[0].ip}`,this.state.autoRefresh=!0,this.state.connecting||this.state.connected||this.openWs()),this.setState({OnLineDevices:t})}e.length&&this.scanForDevices(e,t)})).catch((s=>{e.length&&this.scanForDevices(e,t)}))}}mountWidget(){this.widget.addEventListener("click",(e=>{e.offsetX>2&&e.offsetX<32&&e.offsetY>2&&e.offsetY<32&&(this.state.autoRefresh=!this.state.autoRefresh,this.state.autoRefresh?this.openWs():this.closeWs())})),this.mounted||window.requestAnimationFrame(this.drawDidget.bind(this))}closeWs(){this.ws&&(this.state.autoRefresh=!1,this.ws.close(),this.ws=null,window.requestAnimationFrame(this.drawDidget.bind(this)))}openWs(){(window.location.hostname||httpPrefix)&&(this.state?.connecting||this.state?.connected||(this.state.connecting=!0,this.state.running=!1,this.startWs()))}startWs(){var e=this.ws=new WebSocket("ws://"+(""==httpPrefix?`${window.location.hostname}:${window.location.port}`:httpPrefix.substring(7))+"/ws"),t=setTimeout((()=>{e.close(),this.state.connecting=!1}),3500);e.onmessage=s=>{t=this.processMessage(t,s,e)},e.onopen=()=>{t=this.wsOpen(t,e)},e.onerror=s=>{this.wsError(s,t,e)},e.onclose=e=>{this.wsClose(t)}}wsClose(e){clearTimeout(e),this.state.connected=!1,this.state.connecting=!1,window.requestAnimationFrame(this.drawDidget.bind(this)),this.state.autoRefresh&&this.openWs()}wsError(e,t,s){clearTimeout(t),this.state.error=e,window.requestAnimationFrame(this.drawDidget.bind(this)),s.close()}wsOpen(e,t){return clearTimeout(e),this.state.connected=!0,this.state.connecting=!1,t.send("Connected"),window.requestAnimationFrame(this.drawDidget.bind(this)),e=setTimeout((()=>{this.state.timeout="Connect",t.close()}),3500)}processMessage(e,t,s){if(clearTimeout(e),this.state.running&&!this.state.timeout||(this.state.running=!0,this.state.error=null,this.state.timeout=null),t&&t.data)if("{"==t.data[0])try{t.data.startsWith('{"eventBase"')?this.ProcessEvent(fromVersionedToPlain(JSON.parse(t.data))):this.UpdateState(fromVersionedToPlain(JSON.parse(t.data)))}catch(e){}else t.data.match(/.*\) ([^:]*)/g)&&this.AddLogLine(t.data);else this.ProcessEvent(void 0);return e=setTimeout((()=>{this.state.timeout="Message",s.close()}),4e3)}drawDidget(){if(this.widget){var e=this.widget.getContext("2d");if(e.clearRect(0,0,100,40),this.browser(e,2,2,30,30,10),this.chip(e,70,2,20,30,5),this.anims.length){var t=this.anims.reduce(((e,t)=>((e[t.type]=e[t.type]||[]).push(t),e)),{});for(var s in t)t[s].forEach((t=>{this.drawSprite(t,e)}));this.anims=this.anims.filter((e=>2!=e.state)),window.requestAnimationFrame(this.drawDidget.bind(this))}}}drawSprite(e,t){e.state?e.x+=e.direction*(performance.now()-e.startWindow)/e.tripLen:(e.state=1,e.x="chip"==e.from?this.chipX:this.browserX,e.endX="chip"==e.from?this.browserX:this.chipX,e.direction="browser"==e.from?1:-1,e.y=e.startY,e.tripLen=1600,e.startWindow=performance.now(),e.endWindow=e.startWindow+e.tripLen);var s=Math.min(15,4+e.weight);if(e.y-s/2<=0&&(e.y=s),t.beginPath(),t.lineWidth=2,t.shadowBlur=2,t.strokeStyle=e.lineColor,t.shadowColor=e.fillColor,t.fillStyle=e.fillColor,t.moveTo(e.x+s,e.y),t.arc(e.x,e.y,s,0,2*Math.PI),t.fill(),t.stroke(),e.weight>1){var i=""+e.weight;t.font=Math.min(20,8+e.weight)+"px Helvetica";var a=t.measureText(i);t.fillStyle=e.textColor,t.strokeStyle=e.textColor,t.fillText(i,e.x-a.width/2,e.y+a.actualBoundingBoxAscent/2)}return(1==e.direction?e.x>e.endX:e.x<e.endX)&&(e.state=2),e}browser(e,t,s,i,a,r){this.browserX=t+i,e.beginPath(),e.strokeStyle="#00ffff",e.lineWidth=2,e.shadowBlur=2,e.shadowColor="#002222",e.fillStyle=this.state?.autoRefresh?this.state?.error||this.state?.timeout?"#f27c7c":this.state?.connected?"#00ffff59":"#0396966b":"#000000",this.roundedRectagle(e,t,s,i,a,r),e.fill(),this.state?.lanDevices?.length&&this.roundedRectagle(e,t,s,i,a*(this.state.lanDevices.length/254),r),e.stroke()}chip(e,t,s,i,a,r){this.chipX=t,e.beginPath();e.strokeStyle="#00ffff",e.lineWidth=2,e.shadowBlur=2,e.shadowColor="#000000",e.fillStyle="#00ffff",this.roundedRectagle(e,t,s,i,a,r);for(var n=0;n<3;n++)e.moveTo(t,1.5*r+s+n*((a-2*r)/3)),e.lineTo(t-4,1.5*r+s+n*((a-2*r)/3)),e.lineTo(t-4,1.5*r+2+s+n*((a-2*r)/3)),e.lineTo(t,1.5*r+2+s+n*((a-2*r)/3)),e.moveTo(t+i,1.5*r+s+n*((a-2*r)/3)),e.lineTo(t+i+4,1.5*r+s+n*((a-2*r)/3)),e.lineTo(t+i+4,1.5*r+2+s+n*((a-2*r)/3)),e.lineTo(t+i,1.5*r+2+s+n*((a-2*r)/3));e.stroke()}roundedRectagle(e,t,s,i,a,r){e.moveTo(t+r,s),e.lineTo(t+i-2*r,s),e.arcTo(t+i,s,t+i,s+r,r),e.lineTo(t+i,s+a-r),e.arcTo(t+i,s+a,t+i-r,s+a,r),e.lineTo(t+r,s+a),e.arcTo(t,s+a,t,s+a-r,r),e.lineTo(t,s+r),e.arcTo(t,s,t+r,s,r)}AddLogLine(e){var t=getInSpot(this.anims.filter((t=>"log"==t.type&&t.level==e[0])),"chip");if(t)t.weight++;else{var s=e.match(/^[^IDVEW]*(.+)/)[1].substr(0,1);this.anims.push({type:"log",from:"chip",level:s,weight:1,lineColor:"D"==s||"I"==s?"green":"W"==e[0]?"yellow":"red",shadowColor:"#000000",fillColor:"#000000",textColor:"D"==s||"I"==s?"green":"W"==e[0]?"yellow":"red",startY:25,renderer:this.drawSprite}),window.requestAnimationFrame(this.drawDidget.bind(this))}this.callbacks.logCBFn.forEach((t=>t(e)))}UpdateState(e){var t=getInSpot(this.anims.filter((e=>"state"==e.type)),"chip");t?t.weight++:(this.anims.push({type:"state",from:"chip",weight:1,lineColor:"#00ffff",shadowColor:"#000000",fillColor:"#000000",textColor:"#00ffff",startY:5,renderer:this.drawSprite}),window.requestAnimationFrame(this.drawDidget.bind(this))),this.callbacks.stateCBFn.forEach((t=>t(e)))}ProcessEvent(e){var t=getInSpot(this.anims.filter((e=>"event"==e.type)),"chip");t?t.weight++:(this.anims.push({type:"event",from:"chip",eventBase:e?e.eventBase:void 0,weight:1,lineColor:"#00ffff",shadowColor:"#000000",fillColor:"#000000",textColor:"#7fffd4",startY:15,renderer:this.drawSprite}),window.requestAnimationFrame(this.drawDidget.bind(this))),this.callbacks.eventCBFn.forEach((t=>t.fn(e)))}GetPageControler(){var e=new AbortController;return e.onabort=this.OnAbort,e}OnAbort(){this.state.pageControler=this.GetPageControler()}setActiveTab(e){this.state.tabs[e].active=!0,Object.keys(this.state.tabs).filter((t=>t!=e)).forEach((e=>this.state.tabs[e].active=!1)),this.refreshActiveTab()}refreshActiveTab(){Object.keys(this.state.tabs).forEach((e=>{var t=document.getElementById(`${e}`),s=document.getElementById(`a${e}`);this.state.tabs[e].active?(s.classList.add("active"),t&&t.classList.add("active")):(s.classList.remove("active"),t.classList.remove("active"))}))}registerStateCallback(e){this.callbacks.stateCBFn.find((t=>t.name==e.name))||this.callbacks.stateCBFn.push(e)}registerLogCallback(e){this.callbacks.logCBFn.find((t=>t.name==e.name))||this.callbacks.logCBFn.push(e)}registerEventInstanceCallback(e,t){var s=null;(s=this.callbacks.eventCBFn.find((s=>s.fn.name==e.name&&s.instance===t)))?s.fn=e:this.callbacks.eventCBFn.push({fn:e,instance:t})}registerEventCallback(e){this.callbacks.eventCBFn.find((t=>t.fn.name==e.name&&void 0===t.instance))||this.callbacks.eventCBFn.push({fn:e})}getPage(t){return"Storage"==t?e(StorageViewer,{pageControler:this.state.pageControler,active:this.state.tabs.Storage.active}):"Status"==t?e(StatusPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Status.active,registerEventInstanceCallback:this.registerEventInstanceCallback.bind(this),registerStateCallback:this.registerStateCallback.bind(this)}):"Config"==t?e(ConfigPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Config.active}):"System"==t?e(SystemPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.System.active}):"Logs"==t?e(LogLines,{key:"logLines",registerLogCallback:this.registerLogCallback.bind(this),active:this.state.tabs.System.active}):"Events"==t?e(EventsPage,{pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,active:this.state.tabs.Events.active,registerEventCallback:this.registerEventCallback.bind(this)}):null}ReloadPage(){this.setState({pageControler:this.GetPageControler()})}render(){return e("div",{key:genUUID(),className:"mainApp"},[Object.keys(this.state.tabs).map((t=>e("details",{key:genUUID(),id:t,className:"appPage slides",open:this.state.tabs[t].active,onClick:e=>{e.target.classList.contains("appTab")&&(e.target.parentElement.setAttribute("open",!0),Object.keys(this.state.tabs).forEach((e=>this.state.tabs[e].active=e==t)),[].slice.call(e.target.parentElement.parentElement.children).filter((t=>t!=e)).forEach((e=>e.removeAttribute("open"))))}},[e("summary",{key:genUUID(),className:"appTab"},t),e("div",{key:genUUID(),className:"Status"==t?"pageContent system-config":"pageContent"},this.getPage(t))]))),e("canvas",{key:genUUID(),height:40,width:100,ref:e=>this.widget=e}),e("fieldset",{key:genUUID(),className:"slides",id:"controls"},[this.state?.OnLineDevices?.length&&!window.location.hostname?e("select",{key:genUUID(),className:"landevices",value:httpPrefix.substring(7),onChange:e=>{httpPrefix=`http://${e.target.value}`,this.state?.httpPrefix!=httpPrefix&&this.setState({httpPrefix:httpPrefix}),this.ws?.close()}},this.state.OnLineDevices.map((t=>e("option",{key:genUUID(),className:"landevice"},t.ip)))):null,e(DeviceList,{key:genUUID(),selectedDeviceId:this.state.selectedDeviceId,httpPrefix:httpPrefix,onSet:e=>this.state?.selectedDeviceId!=e?this.setState({selectedDeviceId:e}):null})])])}}function getInSpot(e,t){return e.filter((e=>e.from==t)).find((e=>void 0===e.x||("browser"==t?e.x<=app.browserX+4+e.weight:e.x>=app.chipX-4-e.weight)))}ReactDOM.createRoot(document.querySelector(".slider")).render(e(MainApp,{key:genUUID(),className:"slider"}));