"use strict";const e=React.createElement,httpPrefix="";var hexcase=0,b64pad="";function hex_sha1(e){return rstr2hex(rstr_sha1(str2rstr_utf8(e)))}function hex_hmac_sha1(e,t){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(e){return binb2rstr(binb_sha1(rstr2binb(e),8*e.length))}function rstr_hmac_sha1(e,t){var s=rstr2binb(e);s.length>16&&(s=binb_sha1(s,8*e.length));for(var a=Array(16),i=Array(16),n=0;n<16;n++)a[n]=909522486^s[n],i[n]=1549556828^s[n];var r=binb_sha1(a.concat(rstr2binb(t)),512+8*t.length);return binb2rstr(binb_sha1(i.concat(r),672))}function rstr2hex(e){try{}catch(e){hexcase=0}for(var t,s=hexcase?"0123456789ABCDEF":"0123456789abcdef",a="",i=0;i<e.length;i++)t=e.charCodeAt(i),a+=s.charAt(t>>>4&15)+s.charAt(15&t);return a}function str2rstr_utf8(e){for(var t,s,a="",i=-1;++i<e.length;)t=e.charCodeAt(i),s=i+1<e.length?e.charCodeAt(i+1):0,55296<=t&&t<=56319&&56320<=s&&s<=57343&&(t=65536+((1023&t)<<10)+(1023&s),i++),t<=127?a+=String.fromCharCode(t):t<=2047?a+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?a+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(a+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return a}function rstr2binb(e){for(var t=Array(e.length>>2),s=0;s<t.length;s++)t[s]=0;for(s=0;s<8*e.length;s+=8)t[s>>5]|=(255&e.charCodeAt(s/8))<<24-s%32;return t}function binb2rstr(e){for(var t="",s=0;s<32*e.length;s+=8)t+=String.fromCharCode(e[s>>5]>>>24-s%32&255);return t}function binb_sha1(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var s=Array(80),a=1732584193,i=-271733879,n=-1732584194,r=271733878,o=-1009589776,l=0;l<e.length;l+=16){for(var h=a,d=i,c=n,p=r,g=o,u=0;u<80;u++){s[u]=u<16?e[l+u]:bit_rol(s[u-3]^s[u-8]^s[u-14]^s[u-16],1);var m=safe_add(safe_add(bit_rol(a,5),sha1_ft(u,i,n,r)),safe_add(safe_add(o,s[u]),sha1_kt(u)));o=r,r=n,n=bit_rol(i,30),i=a,a=m}a=safe_add(a,h),i=safe_add(i,d),n=safe_add(n,c),r=safe_add(r,p),o=safe_add(o,g)}return Array(a,i,n,r,o)}function sha1_ft(e,t,s,a){return e<20?t&s|~t&a:e<40?t^s^a:e<60?t&s|t&a|s&a:t^s^a}function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function safe_add(e,t){var s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function bit_rol(e,t){return e<<t|e>>>32-t}function genUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}function dirname(e){return(e.match(/.*\//)+"").replace(/(.+)\/$/g,"$1")}function isFloat(e){return Number(e)===e&&e%1!=0}function IsDatetimeValue(e){return e.match(".*ime_.s$")||e.match(".*ime_sec$")}function IsBooleanValue(e){return"true"==e||"yes"==e||!0===e||"false"==e||"no"==e||!1===e}function IsNumberValue(e){return!0!==e&&!1!==e&&"string"!=typeof e&&!isNaN(e)&&""!==e}function degToRad(e){return e*(Math.PI/180)}function fromVersionedToPlain(e,t=""){var s,a={},i=Object.keys(e);for(s in i){var n=i[s],r=!1;"object"==typeof e[n]&&2==Object.keys(e[n]).filter((e=>!(r|=!("version"==e||"value"==e)))).length?a[n]=e[n].value:Array.isArray(e[n])?(a[n]=[],e[n].forEach(((s,i)=>{e[n][i].boper?a[n][a[n].length-1].boper=e[n][i].boper:a[n].push(fromVersionedToPlain(s,`${t}/${n}[${i}]`))}))):"object"==typeof e[n]?a[n]=fromVersionedToPlain(e[n],`${t}/${n}`):a[n]=e[n]}return a}function fromPlainToVersionned(e,t,s=""){var a={},i=Object.keys(e);for(var n in i){var r=i[n],o=t?t[r]:void 0;if(Array.isArray(e[r])){a[r]=[];for(var l=0;l<e[r].length;l++){var h=fromPlainToVersionned(e[r][l],o?o[l]:null,`${s}/${r}[${l}]`);a[r].push(h),h.boper&&(a[r].push({boper:h.boper}),delete h.boper)}}else"object"==typeof e[r]?a[r]=fromPlainToVersionned(e[r],o,`${s}/${r}`):a[r]="boper"===r||"operator"===r||"otype"===r||"value"===r||"name"===r?e[r]:{version:void 0===o?0:e[r]===o.value?o.version:o.version+1,value:e[r]}}return a}const getCellValue=(e,t)=>e.children[t].innerText||e.children[t].textContent,comparer=(e,t)=>(s,a)=>{return i=getCellValue(t?s:a,e),n=getCellValue(t?a:s,e),""===i||""===n||isNaN(i)||isNaN(n)?i.toString().localeCompare(n):i-n;var i,n};class BoolInput extends React.Component{constructor(e){super(e),this.state={checked:!!this.props.initialState&&this.props.initialState()},this.id=this.props.id||genUUID()}toggleChange=e=>{this.setState({checked:e.target.checked}),e.target.checked?this.props.onOn&&this.props.onOn(e.target):this.props.onOff&&this.props.onOff(e.target)};render(){return e("label",{key:genUUID(),className:"editable",id:`lbl${this.id}`,key:this.id},e("div",{key:genUUID(),className:"label",id:`dlbl${this.id}`},this.props.label),e("input",{key:genUUID(),type:"checkbox",onChange:this.toggleChange,id:`in${this.id}`,checked:this.state.checked}))}}class DeviceList extends React.Component{constructor(e){super(e),this.state={devices:this.props.devices,loaded:!1}}componentDidMount(){this.state.loaded||this.state.devices.length||this.getDevices()}getDevices(){fetch("/files/lfs/config",{method:"post"}).then((e=>e.json())).then((e=>e.filter((e=>"file"==e.ftype)))).then((e=>{this.setState({loaded:!1,devices:e.map((e=>e.name.substr(0,e.name.indexOf("."))))}),this.props.onGotDevices(this.state.devices)})).catch((e=>{this.setState({error:e})}))}render(){return e("select",{key:genUUID(),value:this.props.selectedDeviceId,onChange:e=>this.props.onSet(e.target.value)},this.state.devices?this.state.devices.map((t=>e("option",{key:genUUID(),value:t,value:this.state.selectedDeviceId},t))):"Loading...")}}class IntInput extends React.Component{toggleChange=e=>{this.props.onChange&&this.props.onChange(e.target.value)};render(){return e("label",{key:genUUID(),className:"editable",id:`lbl${this.id}`,key:this.id},e("div",{key:genUUID(),className:"label",id:`div${this.id}`},this.props.label),e("input",{key:genUUID(),type:"number",value:this.props.value,onChange:this.toggleChange.bind(this),id:`${this.id}`}))}}class ROProp extends React.Component{constructor(e){super(e),this.id=this.props.id||genUUID()}getValue(){var e=this.props.value&&this.props.value.version?this.props.value.value:this.props.value;return IsNumberValue(e)&&isFloat(e)&&(e="lattitude"!=this.props.name.toLowerCase()&&"longitude"!=this.props.name.toLowerCase()&&"lat"!=this.props.name&&"lng"!=this.props.name?parseFloat(e).toFixed(2):parseFloat(e).toFixed(8)),IsBooleanValue(e)&&(e="true"==e||"yes"==e||!0===e?"Y":"N"),e}componentDidMount(){IsDatetimeValue(this.props.name)&&this.renderTime(document.getElementById(`vel${this.id}`),this.props.name,this.getValue())}renderTime(e,t,s){if(null!=e){var a=t.endsWith("_us")?new Date(s/1e3):t.endsWith("_sec")?new Date(1e3*s):new Date(s);a.getFullYear()<=1970&&a.setTime(a.getTime()+60*a.getTimezoneOffset()*1e3);var i=a.toLocaleDateString("en-US",{dateStyle:"short"}),n=a.toLocaleTimeString("en-US",{hour12:!1}),r=a.getHours(),o=a.getMinutes(),l=a.getSeconds(),h=a.getMilliseconds(),d=o+(l+h/1e3)/60;a.getFullYear()<=1970&&(i=Math.floor(a.getDate()/864e5)+" Days",n=0==r?(o?o+":":"")+("0"+l).slice(-2)+"."+h:("0"+r).slice(-2)+":"+("0"+o).slice(-2)+":"+("0"+l).slice(-2));var c=e.querySelector("canvas")||e.appendChild(document.createElement("canvas"));c.height=100,c.width=110;var p=c.getContext("2d");p.strokeStyle="#00ffff",p.lineWidth=4,p.shadowBlur=2,p.shadowColor="#00ffff";var g=e.getBoundingClientRect(),u=p.createRadialGradient(g.width/2,g.height/2,5,g.width/2,g.height/2,g.height+5);u.addColorStop(0,"#03303a"),u.addColorStop(1,"black"),p.fillStyle=u,p.clearRect(0,0,g.width,g.height),p.beginPath(),p.arc(g.width/2,g.height/2,.44*g.height,degToRad(270),degToRad(270+30*(r>12?r-12:r))),p.stroke(),p.beginPath(),p.arc(g.width/2,g.height/2,.38*g.height,degToRad(270),degToRad(270+6*d)),p.stroke(),p.font="12px Helvetica",p.fillStyle="rgba(00, 255, 255, 1)";var m=p.measureText(i);p.fillText(i,g.width/2-m.width/2,.65*g.height),p.font="12px Helvetica",p.fillStyle="rgba(00, 255, 255, 1)",m=p.measureText(n),p.fillText(n,.5*g.width-m.width/2,.45*g.height)}}render(){return e("label",{className:"readonly",id:`lbl${this.id}`,key:this.id},[e("div",{key:genUUID(),className:"label",id:`dlbl${this.id}`},this.props.label),e("div",{key:genUUID(),className:"value",id:`vel${this.id}`},IsDatetimeValue(this.props.name)?"":this.getValue())])}}class StateTable extends React.Component{constructor(e){super(e),this.state={json:this.props.json,error:null,cols:[]},this.id=this.props.id||genUUID()}SortTable(e){var t;Array.from((t=e.target.closest("table").querySelector("tbody")).querySelectorAll("tr:nth-child(n)")).sort(comparer(Array.from(e.target.parentNode.children).indexOf(e.target),this.asc=!this.asc)).forEach((e=>t.appendChild(e)))}BuildHead(t){return t?[e("thead",{key:genUUID(),onClick:this.SortTable.bind(this)},e("tr",{key:genUUID()},t.flatMap((e=>Object.keys(e))).concat(this.props.cols).filter(((e,t,s)=>void 0!==e&&s.indexOf(e)===t)).map((s=>(this.state.cols.some((e=>s==e))||(this.state.cols.push(s),!this.state.sortedOn&&t[0]&&isNaN(t[0][s])&&(this.state.sortedOn=s)),e("th",{key:genUUID()},s)))))),e("caption",{key:genUUID()},this.props.label)]:null}getValue(e,t){return e.endsWith("_sec")&&t>1e7?new Date(1e3*t).toLocaleString():(IsNumberValue(t)&&isFloat(t)&&(t="lattitude"!=this.props.name.toLowerCase()&&"longitude"!=this.props.name.toLowerCase()&&"lat"!=this.props.name&&"lng"!=this.props.name?parseFloat(t).toFixed(2):parseFloat(t).toFixed(8)),IsBooleanValue(t)&&(t="true"==t||"yes"==t||!0===t?"Y":"N"),t)}BuildBody(t){return t?e("tbody",{key:genUUID()},t.sort(((e,t)=>e[this.state.sortedOn].localeCompare(t[this.state.sortedOn]))).map((t=>e("tr",{key:genUUID()},this.state.cols.map((s=>e("td",{key:genUUID(),className:"readonly"},void 0!==t[s]?e("div",{key:genUUID(),className:"value"},this.getValue(s,t[s])):null))))))):null}render(){return null===this.props.json||void 0===this.props.json?e("div",{key:genUUID(),id:`loading${this.id}`},"Loading..."):e("label",{key:genUUID(),id:this.id,className:"table"},e("table",{key:genUUID(),className:"greyGridTable"},[this.BuildHead(this.props.json),this.BuildBody(this.props.json)]))}}class AppState extends React.Component{constructor(e){super(e),this.state={error:null},this.id=this.props.id||genUUID()}Parse(t){return t?Object.keys(t).sort(((e,s)=>{var a=Array.isArray(t[e])?5:"object"==typeof t[e]?4:IsDatetimeValue(e)?2:3,i=Array.isArray(t[s])?5:"object"==typeof t[s]?4:IsDatetimeValue(s)?2:3;return a==i?e.localeCompare(s):a>i?1:i>a?-1:0})).map((s=>Array.isArray(t[s])?e(StateTable,{key:genUUID(),name:s,label:s,json:t[s]}):"object"==typeof t[s]?e(AppState,{key:genUUID(),name:s,label:s,json:t[s]}):e(ROProp,{key:genUUID(),value:t[s],name:s,label:s}))):this.state&&this.state.error?this.state.error:e("div",{id:`loading${this.id}`},"Loading...")}render(){return null===this.props.json||void 0===this.props.json?e("div",{id:`loading${this.id}`},"Loading..."):null!=this.props.label?e("fieldset",{id:`fs${this.id}`},[e("legend",{key:genUUID()},this.props.label),this.Parse(this.props.json)]):e("fieldset",{id:`fs${this.id}`},this.Parse(this.props.json))}}class MainAppState extends React.Component{constructor(e){super(e),this.state={statuses:{},loading:this.props.loading,loaded:this.props.loaded,error:null,selectedDeviceId:0,refreshFrequency:10,autoRefresh:!1},this.props.registerStateCallback&&this.props.registerStateCallback(this.updateMainStatus.bind(this))}componentDidMount(){this.props.active&&document.getElementById("Status").scrollIntoView(),this.updateStatuses([{url:"/status/"},{url:"/status/app"},{url:"/status/tasks",path:"tasks"}],{})}componentDidUpdate(e,t,s){this.state.loading||this.state.loaded||(this.state.loading=!0,this.updateStatuses([{url:"/status/"},{url:"/status/app"},{url:"/status/tasks",path:"tasks"}],{})),t&&this.state.autoRefresh!=t.autoRefresh&&this.setupWs(this.state.autoRefresh)}updateMainStatus(e){if(e){const t=Object.keys(e);for(const s in t)this.state.statuses.current[t[s]]=e[t[s]];this.setState({statuses:this.state.statuses})}else this.updateStatuses([{url:"/status/"},{url:"/status/app"},{url:"/status/tasks",path:"tasks"}],{})}updateStatuses(e,t){var s=new AbortController,a=setTimeout((()=>s.abort()),4e3);"current"==this.props.selectedDeviceId?Promise.all(e.map((a=>new Promise(((i,n)=>{fetch(`${a.url}`,{method:"post",signal:s.signal}).then((e=>e.json())).then(fromVersionedToPlain).then((s=>{e=e.filter((e=>e!=a)),a.path?t[a.path]=Object.values(s):Object.assign(t,s),i({path:a.path,stat:s})})).catch((e=>{a.retryCnt=1+(0|a.retryCnt),a.waitFor=4e3,a.error=e,n(e)}))}))))).then((e=>{clearTimeout(a),document.getElementById("Status").style.opacity=1,this.state.statuses[this.props.selectedDeviceId]=this.orderResults(t),this.setState({error:null,loading:!1,loaded:!0,statuses:this.state.statuses})})).catch((s=>{if(clearTimeout(a),20!=s.code){var i=e.filter((e=>e.error));document.getElementById("Status").style.opacity=.5,i[0].waitFor?setTimeout((()=>{s.message,this.updateStatuses(e,t)}),i[0].waitFor):this.updateStatuses(e,t)}})):this.props.selectedDeviceId&&fetch(`/lfs/status/${this.props.selectedDeviceId}.json`,{method:"get",signal:s.signal}).then((e=>e.json())).then(fromVersionedToPlain).then((e=>{this.state.statuses[this.props.selectedDeviceId]=this.orderResults(e),this.setState({statuses:this.state.statuses,loading:!1,loaded:!0})}))}orderResults(e){var t={};return Object.keys(e).filter((t=>"object"!=typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>"object"==typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>Array.isArray(e[t]))).forEach((s=>t[s]=e[s])),t}render(){return[e(AppState,{key:genUUID(),json:this.state.statuses[this.props.selectedDeviceId],selectedDeviceId:this.props.selectedDeviceId})]}}class ConfigEditor extends React.Component{constructor(e){super(e),this.state={loaded:!1},this.id=this.props.id||genUUID()}componentDidMount(){this.props.deviceConfig?(this.jsonEditor=new JSONEditor(this.container,{onChangeJSON:e=>Object.assign(this.props.deviceConfig,e)}),this.jsonEditor.set(this.props.deviceConfig||{})):this.container.innerText="Loading..."}componentDidUpdate(e,t,s){this.jsonEditor&&this.jsonEditor.set(this.props.deviceConfig)}render(){return e("div",{key:genUUID(),ref:e=>this.container=e,id:`${this.id}`,className:"column col-md-12","data-theme":"spectre"})}}class ConfigPage extends React.Component{constructor(e){super(e),this.state={loaded:!1,deviceConfigs:{}},this.id=this.props.id||genUUID(),this.componentDidUpdate(null,null,null)}componentDidMount(){this.props.active&&document.getElementById("Config").scrollIntoView()}getJsonConfig(e){return new Promise(((t,s)=>{const a=setTimeout((()=>this.props.pageControler.abort()),3e3);fetch("/config"+(e&&"current"!=e?`/${e}`:""),{method:"post",signal:this.props.pageControler.signal}).then((e=>{clearTimeout(a),t(e.json())})).catch((e=>{clearTimeout(a),s(e)}))}))}getDevices(){return new Promise(((e,t)=>this.getJsonConfig(null).then(fromVersionedToPlain).then((t=>fetch("/files/lfs/config",{method:"post"}).then((e=>e.json())).then((s=>Promise.all(s.filter((e=>"file"==e.ftype&&"current.json"!=e.name)).map((e=>fetch(`/lfs/config/${e.name}`,{method:"get"}).then((e=>e.json())).then(fromVersionedToPlain).then((s=>(this.state.deviceConfigs[e.name.substr(0,e.name.indexOf("."))]=s,this.state.deviceConfigs[t.deviceid]=t,this.state.deviceId=t.deviceid,s)))))).then(e))))).catch(t)))}componentDidUpdate(e,t,s){this.state.loaded||this.state.loading||this.state.error||(this.state.loading=!0,this.props.selectedDeviceId&&fetch("/config"+("current"==this.props.selectedDeviceId?"":"/"+this.props.selectedDeviceId),{method:"post"}).then((e=>e.json())).then(fromVersionedToPlain).then((e=>{this.state.deviceConfigs[this.props.selectedDeviceId]=e,this.setState({deviceConfigs:this.state.deviceConfigs,loading:!1,loaded:!0})})).catch((e=>{this.setState({error:e,loaded:!1,loading:!1})})))}SaveForm(e){this.getJsonConfig(this.props.selectedDeviceId).then((e=>fromPlainToVersionned(this.state.deviceConfigs[this.props.selectedDeviceId],e))).then((t=>fetch(e.target.action.replace("file://","")+"/"+("current"==this.props.selectedDeviceId?"":this.props.selectedDeviceId),{method:"put",body:JSON.stringify(t)}).then((e=>alert(JSON.stringify(e)))).catch((e=>alert(JSON.stringify(e)))))),e.preventDefault()}render(){return e("form",{onSubmit:e=>this.SaveForm(e),key:`f${this.id}`,action:"/config",method:"post"},[e(ConfigEditor,{key:genUUID(),deviceId:this.props.selectedDeviceId,deviceConfig:this.state.deviceConfigs[this.props.selectedDeviceId]}),e("button",{key:genUUID()},"Save"),e("button",{key:genUUID(),onClick:e=>this.setState({loaded:!1,loading:!1,error:null})},"Refresh")])}}class ControlPanel extends React.Component{constructor(e){super(e),this.state={loaded:this.props.loaded,error:null,refreshFrequency:this.props.refreshFrequency,devices:[],selectedDeviceId:this.props.selectedDeviceId}}componentDidUpdate(e,t,s){t&&t.selectedDeviceId&&t.selectedDeviceId!=this.state.selectedDeviceId&&this.props.onSelectedDeviceId&&this.props.onSelectedDeviceId(this.state.selectedDeviceId)}setupWs(e){if(this.state.autoRefresh=e,e){if(null==this.ws){this.ws=new WebSocket("ws://"+window.location.hostname+"/ws");var t=setTimeout((()=>{this.ws.close()}),3e3);this.ws.onmessage=e=>{clearTimeout(t),e&&e.data&&("{"==e.data[0]?e.data.startsWith('{"eventBase"')?this.ProcessEvent(fromVersionedToPlain(JSON.parse(e.data))):this.UpdateState(fromVersionedToPlain(JSON.parse(e.data))):e.data.match(/.*\) ([^:]*)/g)&&this.AddLogLine(e.data)),t=setTimeout((()=>{this.ws.close()}),3e3)},this.ws.onopen=()=>{clearTimeout(t),this.ws.send("Connect"),t=setTimeout((()=>{this.ws.close()}),3e3)},this.ws.onerror=e=>{clearTimeout(t),this.ws.close()},this.ws.onclose=e=>{clearTimeout(t),this.ws=null,this.setState({autoRefresh:!1})}}}else null!=this.ws?(this.ws.close(),this.ws=null):this.state.autoRefresh=!1}AddLogLine(e){e&&this.props.callbacks.logCBFn&&this.props.callbacks.logCBFn.forEach((t=>t(e)))}UpdateState(e){this.props.callbacks.stateCBFn&&this.props.callbacks.stateCBFn.forEach((t=>t(e)))}ProcessEvent(e){this.props.callbacks.eventCBFn&&this.props.callbacks.eventCBFn.forEach((t=>t(e)))}render(){return e("fieldset",{key:genUUID(),className:"slides",id:"controls",key:this.id},[e("legend",{key:genUUID(),id:`lg${this.id}`},"Controls"),e(BoolInput,{key:genUUID(),label:"Periodic Refresh",onOn:e=>this.state?.interval?null:this.state.interval=setInterval((()=>this.UpdateState(null)),1e3*this.state.refreshFrequency),onOff:e=>this.state?.interval?this.state.interval=clearTimeout(this.state?.interval):null,initialState:()=>null!=this.state.interval&&null!=this.state.interval}),e(IntInput,{key:genUUID(),label:"Freq(sec)",value:this.state.refreshFrequency,id:"refreshFreq",onChange:e=>this.state.refreshFrequency=e}),e(BoolInput,{key:genUUID(),label:"Auto Refresh",onOn:e=>this.setupWs(!0),onOff:e=>this.setupWs(!1),id:"autorefresh",initialState:()=>this.state.autoRefresh}),e("button",{key:genUUID(),onClick:e=>this.UpdateState(null)},"Refresh"),e(DeviceList,{key:genUUID(),selectedDeviceId:this.state.selectedDeviceId,devices:this.state.devices,onSet:e=>this.setState({selectedDeviceId:e}),onGotDevices:e=>{this.state.selectedDeviceId?this.setState({devices:e}):this.setState({selectedDeviceId:"current",devices:e})}})])}}class TypedField extends React.Component{render(){return[e("div",{key:genUUID(),className:this.props.type},this.props.type),this.props.path?e("div",{key:genUUID(),className:"path"},this.props.path):null]}}class LitteralField extends React.Component{render(){return e("div",{key:genUUID(),className:"litteral"},this.props.value)}}class EventField extends React.Component{render(){return e("div",{key:genUUID(),className:"conditionField"},this.props.name?e(TypedField,{key:genUUID(),type:this.props.name,value:this.props.value,path:this.props.path}):e(LitteralField,{key:genUUID(),value:this.props.value}))}}class EventCondition extends React.Component{render(){return e("div",{key:genUUID(),className:"condition"},[e(EventField,{key:genUUID(),...this.props.src}),e("div",{key:genUUID(),className:"operator"},this.props.operator),e(EventField,{key:genUUID(),...this.props.comp})])}}class EventConditions extends React.Component{render(){return e("details",{key:genUUID(),className:"conditions "+(0==this.props.conditions.length?"hidden":"")},[e("summary",{key:genUUID()},"Conditions"),this.props.conditions.map((t=>e(EventCondition,{key:genUUID(),...t})))])}}class EventLine extends React.Component{render(){return"conditions"==this.props.name?e(EventConditions,{key:genUUID(),className:this.props.name,conditions:this.props.value}):Array.isArray(this.props.value)?this.props.value.length>0?e("details",{key:genUUID(),className:`arrayfield ${this.props.name}`},e("summary",{key:genUUID(),className:"name"},this.props.name),this.props.value.map((t=>e("div",{key:genUUID(),className:"arrayItem"},Object.keys(t).map((s=>e(EventLine,{key:genUUID(),name:s,value:t[s]}))))))):null:"object"==typeof this.props.value?Object.keys(this.props.value).length>0?e("details",{key:genUUID(),className:`object ${this.props.name}`},[e("summary",{key:genUUID(),className:"object name"},this.props.name),Object.keys(this.props.value).map((t=>e("details",{key:genUUID(),className:"name"},[e("summary",{key:genUUID()},t),e("div",{key:genUUID(),className:t},this.props.value[t])])))]):null:e("details",{key:genUUID(),className:this.props.name},[e("summary",{key:genUUID()},this.props.name),this.props.value])}}class Event extends React.Component{render(){return e("details",{key:genUUID(),className:"event"},[e("summary",{key:genUUID(),className:"name"},[e("div",{key:genUUID(),className:"eventBase"},this.props.eventBase),e("div",{key:genUUID(),className:"eventId"},this.props.eventId)]),Object.keys(this.props).filter((e=>"name"!=e)).map((t=>e(EventLine,{key:genUUID(),name:t,value:this.props[t]})))])}}class LiveEvent extends React.Component{render(){return e("summary",{key:genUUID(),className:"liveEvent"},[e("div",{key:genUUID(),className:"description"},[e("div",{key:genUUID(),className:"eventBase"},this.props.eventBase),e("div",{key:genUUID(),className:"eventId"},this.props.eventId)]),this.props.data?e("details",{key:genUUID(),className:"data"},Object.keys(this.props.data).map((t=>e("div",{key:genUUID(),className:"description"},[e("div",{key:genUUID(),className:"propName"},t),e("div",{key:genUUID(),className:t},this.props.data[t])])))):null])}}class LiveEventPannel extends React.Component{constructor(e){super(e),this.state={lastEvents:[]},this.props.registerEventCallback&&this.props.registerEventCallback(this.ProcessEvent.bind(this))}ProcessEvent(e){for(this.state.lastEvents.push(e);this.state.lastEvents.length>100;)this.state.lastEvents.shift();this.setState({lastEvents:this.state.lastEvents})}render(){return e("div",{key:genUUID(),className:"eventPanel"},[e("div",{key:genUUID(),className:"control"},[e("div",{key:genUUID()},`${this.state.lastEvents.length} event${this.state.lastEvents.length?"s":""}`),e("button",{key:genUUID(),onClick:e=>this.setState({lastEvents:[]})},"Clear")]),e("div",{key:genUUID(),className:"eventList"},this.state.lastEvents.map((t=>e(LiveEvent,{key:genUUID(),...t}))).reverse())])}}class EventsPage extends React.Component{constructor(e){super(e),this.state={events:[],programs:[]}}componentDidMount(){this.props.active&&document.getElementById("Events").scrollIntoView(),this.getJsonConfig().then((e=>this.setState({events:e.events,programs:e.programs})))}getJsonConfig(){return new Promise(((e,t)=>{const s=setTimeout((()=>this.props.pageControler.abort()),3e3);fetch("/config"+("current"==this.props.selectedDeviceId?"":`/${this.props.selectedDeviceId}`),{method:"post",signal:this.props.pageControler.signal}).then((e=>(clearTimeout(s),e.json()))).then((t=>e(fromVersionedToPlain(t)))).catch((e=>{clearTimeout(s),t(e)}))}))}render(){return[e("div",{key:genUUID(),className:"designer"},[e("details",{key:genUUID(),className:"configuredEvents"},[e("summary",{key:genUUID()},`${this.state.events?.length} Events`),this.state.events?.map((t=>e(Event,{key:genUUID(),...t})))]),e("details",{key:genUUID(),className:"programs"},[e("summary",{key:genUUID()},`${this.state.programs?.length} Programs`),this.state.programs?.map((t=>e(Program,{key:genUUID(),...t})))])]),e(LiveEventPannel,{key:genUUID(),registerEventCallback:this.props.registerEventCallback})]}}class FirmwareUpdater extends React.Component{UploadFirmware(e){if(e.preventDefault(),this.setState({loaded:`Sending ${this.state.len} firmware bytes`}),this.state.fwdata&&this.state.md5)return fetch(`/ota/flash?md5=${this.state.md5}&len=${this.state.len}`,{method:"post",body:this.state.fwdata}).then((e=>e.text())).then((e=>this.setState({loaded:e})))}waitForDevFlashing(){var e=new AbortController,t=setTimeout((()=>{e.abort()}),1e3);fetch("/status/app",{method:"post",signal:e.signal}).then((e=>(clearTimeout(t),e.json()))).then((e=>this.setState({waiter:null,loaded:`Loaded version ${e.build.ver} built on ${e.build.date}`}))).catch((e=>{clearTimeout(t),this.setState({waiter:setTimeout((()=>this.waitForDevFlashing()),500)})}))}componentDidUpdate(e,t,s){if("Flashing"==this.state.loaded&&null==this.state.waiter&&this.waitForDevFlashing(),this.state.firmware&&!this.state.md5){this.state.md5="loading";var a=new FileReader;a.onload=()=>{var e=a.resultString||a.result,t=CryptoJS.algo.MD5.create();t.update(CryptoJS.enc.Latin1.parse(a.result)),this.state.fwdata=new Uint8Array(this.state.firmware.size);for(var s=0;s<e.length;s++)this.state.fwdata[s]=e.charCodeAt(s);this.setState({md5:t.finalize().toString(CryptoJS.enc.Hex),fwdata:this.state.fwdata,len:this.state.firmware.size})},a.onprogress=e=>this.setState({loaded:1*this.state.firmware.size/(1*e.loaded)*100+"% loaded"}),a.onerror=e=>this.setState({md5:null,firmware:null,error:e.textContent}),a.onabort=e=>this.setState({md5:null,firmware:null,error:"Aborted"}),a.readAsBinaryString(this.state.firmware)}}componentDidMount(){var e=new URLSearchParams(window.location.search);e&&e.has("loaded")&&this.setState({loaded:e.get("loaded",e.get("loaded"))})}render(){return e("form",{key:genUUID(),onSubmit:this.UploadFirmware.bind(this)},e("fieldset",{key:genUUID()},[e("input",{key:genUUID(),type:"file",name:"firmware",onChange:e=>this.setState({firmware:e.target.files[0]})}),e("button",{key:genUUID()},"Upload"),e("div",{key:genUUID()},this.state?.loaded)]))}}class ProgramLine extends React.Component{render(){return Array.isArray(this.props.value)?e("details",{key:genUUID(),className:`arrayfield ${this.props.name}`},e("summary",{key:genUUID(),className:"name"},this.props.name),this.props.value.map((t=>e("div",{key:genUUID(),className:"arrayItem"},Object.keys(t).map((s=>e(ProgramLine,{key:genUUID(),name:s,value:t[s]}))))))):"object"==typeof this.props.value?e("details",{key:genUUID(),className:`object ${this.props.name}`},[e("summary",{key:genUUID(),className:"object name"},this.props.name),Object.keys(this.props.value).map((t=>e("details",{key:genUUID(),className:"name"},[e("summary",{key:genUUID()},t),e("div",{key:genUUID(),className:t},this.props.value[t])])))]):e("details",{key:genUUID(),className:this.props.name},[e("summary",{key:genUUID()},this.props.name),this.props.value])}}class Program extends React.Component{render(){return e("details",{key:genUUID(),className:"program"},[e("summary",{key:genUUID(),className:"name"},this.props.name),Object.keys(this.props).filter((e=>"name"!=e)).map((t=>e(ProgramLine,{key:genUUID(),name:t,value:this.props[t]})))])}}class SFile extends React.Component{render(){return e("tr",{key:genUUID(),className:this.props.file.ftype},[e("td",{key:genUUID()},this.props.getFileLink(this.props.file)),e("td",{key:genUUID()},"file"!=this.props.file.ftype?"":this.props.file.size),e("td",{key:genUUID()},"/"==this.props.path||".."==this.props.file.name?null:e("a",{key:genUUID(),href:"#",onClick:()=>{fetch(`/stat${"/"===this.props.path?"":this.props.path}/${this.props.file.name}`,{method:"post",headers:{ftype:"file"==this.props.file.ftype?"file":"directory",operation:"delete"}}).then(this.props.OnDelete?this.props.OnDelete():null).catch((e=>{}))}},"Del"))])}}class StorageViewer extends React.Component{constructor(e){super(e),this.state={loaded:!1,path:this.props.path,files:null},this.id=this.props.id||genUUID()}getSystemFolders(){return["/"!=this.state.path?{ftype:"folder",name:"..",folder:dirname(this.state.path)}:null]}GetFileStat(e){if(e.length){var t=e.pop(),s=setTimeout((()=>this.props.pageControler.abort()),3e3);fetch(`/stat${t.folder}/${t.name}`,{method:"post",signal:this.props.pageControler.signal}).then((a=>{clearTimeout(s),a.json().then((e=>{t.size=e.size,this.state.total+=e.size,this.setState({loaded:!0,files:this.state.files,total:this.state.total})})),e.length&&!this.props.pageControler.signal.aborted&&this.GetFileStat(e)})).catch((e=>{clearTimeout(s)}))}else this.setState({loaded:!0,files:this.state.files,total:this.state.total})}fetchFiles(){var e=setTimeout((()=>this.props.pageControler.abort()),3e3);fetch("/files"+this.state.path,{method:"post",signal:this.props.pageControler.signal}).then((t=>{clearInterval(e),t.json().then((e=>e.sort(((e,t)=>e.ftype!=t.ftype?"folder"==e.ftype?1:-1:e.name==t.name?0:e.name>t.name?1:-1)))).then((e=>{this.setState({loaded:!0,files:e,total:e.reduce(((e,t)=>e+t.size),0)});for(var t=e.filter((e=>"file"==e.ftype&&!e.size)),s=0;s<Math.min(3,t.length);s++)t.length&&this.GetFileStat(t)}))})).catch(console.error)}getFileLink(t){return"folder"==t.ftype?e("a",{key:genUUID(),href:"#",onClick:()=>{this.setState({total:0,loaded:!1,path:`${t.folder||"/"}${".."==t.name?"":"/"+t.name}`.replaceAll("//","/")})}},t.name):e("a",{href:`${this.state.path}/${t.name}`},t.name)}componentDidUpdate(e,t){this.state.loaded||(this.state.loaded=!0),t&&t.path!=this.state.path&&this.fetchFiles()}componentDidMount(){this.fetchFiles(),this.props.active&&document.getElementById("Storage").scrollIntoView()}SortTable(e){var t;Array.from((t=e.target.closest("div.file-table").querySelector("tbody")).querySelectorAll("tr:nth-child(n+2)")).sort(comparer(Array.from(e.target.parentNode.children).indexOf(e.target),this.asc=!this.asc)).forEach((e=>t.appendChild(e)))}getTableHeader(){return e("thead",{key:genUUID()},e("tr",{key:genUUID()},this.props.cols.map((t=>e("th",{key:genUUID(),onClick:this.SortTable.bind(this)},t))).concat(e("th",{key:genUUID()},"Op"))))}render(){return e("div",{key:genUUID(),id:this.id,className:"file-table "+(this.state.loaded?"":"loading")},e("table",{key:genUUID(),className:"greyGridTable"},[e("caption",{key:genUUID()},this.state.path),this.getTableHeader(),e("tbody",{key:genUUID()},this.state.files&&this.state.files.length>0?this.getSystemFolders().concat(this.state.files).filter((e=>e)).map((t=>e(SFile,{key:genUUID(),file:t,path:this.state.path,getFileLink:this.getFileLink.bind(this),OnDelete:()=>this.fetchFiles()}))):"/"==this.state.path?e("tr",{key:genUUID()},[e("td",{key:genUUID()},"Loading..."),e("td",{key:genUUID()})]):this.getSystemFolders().map((t=>e(SFile,{key:genUUID(),file:t,path:this.state.path,getFileLink:this.getFileLink.bind(this),OnDelete:()=>this.fetchFiles()})))),e("tfoot",{key:genUUID()},e("tr",{key:genUUID()},[e("td",{key:genUUID()},"Total"),e("td",{key:genUUID()},this.state.total)]))]))}}class LogLine extends React.Component{constructor(e){super(e);var t=this.props.logln.match(/^[^IDVEW]*(.+)/)[1];this.state={level:t.substr(0,1),date:t.substr(3,12),function:t.match(/.*\) ([^:]*)/g)[0].replaceAll(/^.*\) (.*)/g,"$1")},this.state.msg=this.props.logln.substr(this.props.logln.indexOf(this.state.function)+this.state.function.length+2).replaceAll(/^[\r\n]*/g,"").replaceAll(/.\[..\n$/g,"")}isScrolledIntoView(){var e=this.logdiv.getBoundingClientRect(),t=e.top,s=e.bottom;return t>=0&&s<=window.innerHeight}componentDidMount(){this.isScrolledIntoView()&&document.getElementById("Logs").classList.contains("active")&&this.logdiv.scrollIntoView()}render(){return e("div",{key:genUUID(),className:`log LOG${this.state.level}`},[e("div",{key:genUUID(),ref:e=>this.logdiv=e,className:"LOGLEVEL"},this.state.level),e("div",{key:genUUID(),className:"LOGDATE"},this.state.date),e("div",{key:genUUID(),className:"LOGFUNCTION"},this.state.function),e("div",{key:genUUID(),className:"LOGLINE"},this.state.msg)])}}class LogLines extends React.Component{constructor(e){super(e),this.state={logLines:[]},this.props.registerLogCallback&&this.props.registerLogCallback(this.AddLogLine.bind(this))}AddLogLine(e){this.state.logLines.push(e),this.setState({logLines:this.state.logLines})}render(){return e("div",{key:genUUID(),className:"loglines"},this.state.logLines.map((t=>e(LogLine,{key:genUUID(),logln:t}))))}}class SystemPage extends React.Component{componentDidMount(){this.props.active&&document.getElementById("Logs").scrollIntoView()}SendCommand(e){return fetch("/status/cmd",{method:"PUT",body:JSON.stringify(e)}).then((e=>e.text().then(console.log))).catch(console.error).catch(console.error)}render(){return[e("div",{key:genUUID()},[e("button",{key:genUUID(),onClick:e=>this.setState({logLines:[]})},"Clear Logs"),e("button",{key:genUUID(),onClick:e=>this.SendCommand({command:"reboot"})},"Reboot"),e("button",{key:genUUID(),onClick:e=>this.SendCommand({command:"parseFiles"})},"Parse Files"),e("button",{key:genUUID(),onClick:e=>this.SendCommand({command:"factoryReset"})},"Factory Reset"),e(FirmwareUpdater,{key:genUUID()})]),e(LogLines,{key:genUUID(),registerLogCallback:this.props.registerLogCallback})]}}class MainApp extends React.Component{constructor(e){super(e),this.state={tabs:{Storage:{active:!0},Status:{active:!1},Config:{active:!1},Logs:{active:!1},Events:{active:!1}},callbacks:{stateCBFn:[],logCBFn:[],eventCBFn:[]},pageControler:this.GetPageControler(),selectedDeviceId:"current"}}GetPageControler(){var e=new AbortController;return e.onabort=this.OnAbort,e}OnAbort(){this.state.pageControler=this.GetPageControler()}componentDidMount(){Object.keys(this.state.tabs).filter((e=>this.state.tabs[e].active)).forEach(this.setActiveTab.bind(this))}setActiveTab(e){this.state.tabs[e].active=!0,Object.keys(this.state.tabs).filter((t=>t!=e)).forEach((e=>this.state.tabs[e].active=!1)),Object.keys(this.state.tabs).forEach((t=>{var s=document.getElementById(`${t}`),a=document.getElementById(`a${t}`);this.state.tabs[t].active?(a.classList.add("active"),s&&s.classList.add("active"),"Config"==e||"Status"==e||"Events"==e?(document.getElementById("controls").classList.remove("hidden"),document.querySelector("div.slides").classList.remove("expanded")):(document.getElementById("controls").classList.add("hidden"),document.querySelector("div.slides").classList.add("expanded"))):(a.classList.remove("active"),s&&s.classList.remove("active"))}))}registerStateCallback(e){this.state.callbacks.stateCBFn.push(e)}registerLogCallback(e){this.state.callbacks.logCBFn.push(e)}registerEventCallback(e){this.state.callbacks.eventCBFn.push(e)}onSelectedDeviceId(e){this.setState({selectedDeviceId:e})}render(){return[e("div",{key:genUUID(),className:"tabs"},Object.keys(this.state.tabs).map((t=>e("a",{key:genUUID(),id:`a${t}`,className:this.state.tabs[t].active?"active":"",onClick:()=>this.setActiveTab(t),href:`#${t}`},t)))),e("div",{key:genUUID(),className:"slide"},[e(ControlPanel,{key:genUUID(),selectedDeviceId:this.state.selectedDeviceId,onSelectedDeviceId:this.onSelectedDeviceId.bind(this),callbacks:this.state.callbacks}),e("div",{key:genUUID(),className:"slides"+(this.state.tabs.Config.active||this.state.tabs.Status.active?"":" expanded")},this.state.selectedDeviceId?[e("div",{className:"file_section",id:"Storage",key:genUUID()},e(StorageViewer,{active:this.state.tabs.Storage.active,pageControler:this.state.pageControler,path:"/",cols:["Name","Size"]})),e("div",{className:"system-config",id:"Status",key:genUUID()},e(MainAppState,{active:this.state.tabs.Status.active,pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,registerStateCallback:this.registerStateCallback.bind(this)})),e("div",{className:"system-config",id:"Config",key:genUUID()},e(ConfigPage,{active:this.state.tabs.Config.active,pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId})),e("div",{className:"logs",id:"Logs",key:genUUID()},e(SystemPage,{active:this.state.tabs.Logs.active,pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,registerLogCallback:this.registerLogCallback.bind(this)})),e("div",{className:"events",id:"Events",key:genUUID()},e(EventsPage,{active:this.state.tabs.Events.active,pageControler:this.state.pageControler,selectedDeviceId:this.state.selectedDeviceId,registerEventCallback:this.registerEventCallback.bind(this)}))]:[])])]}}ReactDOM.render(e(MainApp,{key:genUUID(),className:"slider",refreshFrequency:10}),document.querySelector(".slider"));