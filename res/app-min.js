"use strict";const e=React.createElement;var pageControler=null,ws=null,fileStats={},fileStatsToFetch=[],lastFolder="",activeTab=null,activeInterval=null,editor=null,stateManager=null,systemManager=null,configManager=null,stateViewer=null,fileManager=null;const httpPrefix="";class BoolInput extends React.Component{constructor(e){super(e),this.state={checked:!!this.props.initialState&&this.props.initialState()},this.id=this.props.id||genUUID()}toggleChange=e=>{this.setState({checked:e.target.checked}),e.target.checked?this.props.onOn&&this.props.onOn(e.target):this.props.onOff&&this.props.onOff(e.target)};render(){return e("label",{key:genUUID(),className:"editable",id:`lbl${this.id}`,key:this.id},e("div",{key:genUUID(),className:"label",id:`dlbl${this.id}`},this.props.label),e("input",{key:genUUID(),type:"checkbox",onChange:this.toggleChange,id:`in${this.id}`,checked:this.state.checked}))}}class IntInput extends React.Component{toggleChange=e=>{this.setState({value:e.target.value}),this.props.onChange&&this.props.onChange(e.target.value)};render(){return e("label",{key:genUUID(),className:"editable",id:`lbl${this.id}`,key:this.id},e("div",{key:genUUID(),className:"label",id:`div${this.id}`},this.props.label),e("input",{key:genUUID(),type:"number",value:this.props.value,onChange:this.toggleChange.bind(this),id:`${this.id}`}))}}class DeviceList extends React.Component{constructor(e){super(e),this.state={devices:this.props.devices,loaded:!1,loading:!1}}componentDidMount(){this.state.loading||this.state.loaded||this.state.devices.length||(this.state.loading=!0,fetch("/files/lfs/status",{method:"post"}).then((e=>e.json().then((e=>{this.state.error=null,this.state.loaded=!0,this.state.loading=!1,this.state.devices=e.filter((e=>"file"==e.ftype&&"current.json"!=e.name)).map((e=>parseInt(e.name.substr(0,e.name.indexOf("."))))),this.props.onSetDeviceList(this.state.devices)})).catch((e=>this.setState({loaded:!1,error:e}))))))}render(){return e("select",{key:genUUID(),value:this.props.selectedDeviceId,onChange:e=>this.props.onSet(e.target.value)},this.state.devices.concat(this.props.deviceId).map((t=>e("option",{key:genUUID(),value:t},t))))}}class ControlPanel extends React.Component{constructor(e){super(e),this.state={periodicRefreshed:!1,refreshFrequency:this.props.refreshFrequency,autoRefresh:!1},this.id=this.props.id||genUUID()}render(){return e("fieldset",{key:genUUID(),id:"controls",key:this.id},[e("legend",{key:genUUID(),id:`lg${this.id}`},"Controls"),e(BoolInput,{key:genUUID(),label:"Periodic Refresh",onOn:this.props.periodicOn,onOff:this.props.periodicOff,initialState:()=>null!=this.props.interval&&null!=this.props.interval}),e(IntInput,{key:genUUID(),label:"Freq(sec)",value:this.state.refreshFrequency,id:"refreshFreq",onChange:e=>this.props.onChangeFreq?this.props.onChangeFreq(e):null}),e(BoolInput,{key:genUUID(),label:"Auto Refresh",onOn:setupWs,onOff:setupWs,id:"autorefresh",initialState:()=>null!=ws}),e(DeviceList,{key:genUUID(),selectedDeviceId:this.props.selectedDeviceId,deviceId:this.props.deviceId,devices:this.props.devices,onSetDeviceList:this.props.onSetDeviceList,onSet:this.props.onSetDevice})])}}class ROProp extends React.Component{constructor(e){super(e),this.state=this.props.json,this.id=this.props.id||genUUID()}getValue(){var e=this.props.json&&this.props.json[this.props.name]&&this.props.json[this.props.name].version?this.props.json[this.props.name].value:this.props.json[this.props.name];return IsNumberValue(e)&&isFloat(e)&&(e="lattitude"!=this.props.name.toLowerCase()&&"longitude"!=this.props.name.toLowerCase()&&"lat"!=this.props.name&&"lng"!=this.props.name?parseFloat(e).toFixed(2):parseFloat(e).toFixed(8)),IsBooleanValue(e)&&(e="true"==e||"yes"==e||!0===e?"Y":"N"),e}componentDidMount(){IsDatetimeValue(this.props.name)&&this.renderTime(document.getElementById(`vel${this.id}`),this.props.name,this.getValue())}renderTime(e,t,s){if(null!=e){var a=t.endsWith("_us")?new Date(s/1e3):t.endsWith("_sec")?new Date(1e3*s):new Date(s);a.getFullYear()<=1970&&a.setTime(a.getTime()+60*a.getTimezoneOffset()*1e3);var i=a.toDateString(),n=a.toLocaleTimeString(),r=a.getHours(),o=a.getMinutes(),l=a.getSeconds(),d=a.getMilliseconds(),h=o+(l+d/1e3)/60;a.getFullYear()<=1970&&(i=Math.floor(a.getDate()/864e5)+" Days",n=0==r?(o?o+":":"")+("0"+l).slice(-2)+"."+d:("0"+r).slice(-2)+":"+("0"+o).slice(-2)+":"+("0"+l).slice(-2));var c=e.querySelector("canvas")||e.appendChild(document.createElement("canvas"));c.height=100,c.width=100;var p=c.getContext("2d");p.strokeStyle="#00ffff",p.lineWidth=4,p.shadowBlur=2,p.shadowColor="#00ffff";var g=e.getBoundingClientRect(),u=p.createRadialGradient(g.width/2,g.height/2,5,g.width/2,g.height/2,g.height+5);u.addColorStop(0,"#03303a"),u.addColorStop(1,"black"),p.fillStyle=u,p.clearRect(0,0,g.width,g.height),p.beginPath(),p.arc(g.width/2,g.height/2,.44*g.height,degToRad(270),degToRad(30*r-90)),p.stroke(),p.beginPath(),p.arc(g.width/2,g.height/2,.38*g.height,degToRad(270),degToRad(6*h-90)),p.stroke(),p.font="8px Helvetica",p.fillStyle="rgba(00, 255, 255, 1)";var f=p.measureText(i);p.fillText(i,g.width/2-f.width/2,.55*g.height),p.font="12px Helvetica",p.fillStyle="rgba(00, 255, 255, 1)",f=p.measureText(n),p.fillText(n,.5*g.width-f.width/2,.45*g.height)}}render(){return e("label",{className:"readonly",id:`lbl${this.id}`,key:this.id},[e("div",{key:genUUID(),className:"label",id:`dlbl${this.id}`},this.props.label),e("div",{key:genUUID(),className:"value",id:`vel${this.id}`},IsDatetimeValue(this.props.name)?"":this.getValue())])}}class StateTable extends React.Component{constructor(e){super(e),this.state={json:this.props.json,error:null,cols:[]},this.id=this.props.id||genUUID()}BuildHead(t){return t?[e("thead",{key:genUUID()},e("tr",{key:genUUID()},t.flatMap((e=>Object.keys(e))).concat(this.props.cols).filter(((e,t,s)=>void 0!==e&&s.indexOf(e)===t)).map((t=>(this.state.cols.some((e=>t==e))||this.state.cols.push(t),e("td",{key:genUUID()},t)))))),e("caption",{key:genUUID()},this.props.label)]:null}getValue(e,t){return e.endsWith("_sec")&&t>1e7?new Date(1e3*t).toLocaleString():(IsNumberValue(t)&&isFloat(t)&&(t="lattitude"!=this.props.name.toLowerCase()&&"longitude"!=this.props.name.toLowerCase()&&"lat"!=this.props.name&&"lng"!=this.props.name?parseFloat(t).toFixed(2):parseFloat(t).toFixed(8)),IsBooleanValue(t)&&(t="true"==t||"yes"==t||!0===t?"Y":"N"),t)}BuildBody(t){return t?e("tbody",{key:genUUID()},t.map((t=>e("tr",{key:genUUID()},this.state.cols.map((s=>e("td",{key:genUUID(),className:"readonly"},void 0!==t[s]?e("div",{key:genUUID(),className:"value"},this.getValue(s,t[s])):null))))))):null}render(){return null===this.props.json||void 0===this.props.json?e("div",{key:genUUID(),id:`loading${this.id}`},"Loading..."):e("label",{key:genUUID(),id:this.id,className:"table"},e("table",{key:genUUID(),className:"greyGridTable"},[this.BuildHead(this.props.json),this.BuildBody(this.props.json)]))}}class AppState extends React.Component{constructor(e){super(e),this.state={json:this.props.json,error:null},this.id=this.props.id||genUUID()}Parse(t){return t?Object.keys(t).map((s=>Array.isArray(t[s])?e(StateTable,{key:genUUID(),name:s,label:s,json:t[s]}):"object"==typeof t[s]?e(AppState,{key:genUUID(),name:s,label:s,json:t[s]}):e(ROProp,{key:genUUID(),json:t,name:s,label:s}))):this.state&&this.state.error?this.state.error:e("div",{id:`loading${this.id}`},"Loading...")}render(){return null===this.props.json||void 0===this.props.json?e("div",{id:`loading${this.id}`},"Loading..."):null!=this.props.label?e("fieldset",{name:`/${this.state.path}`,id:`fs${this.id}`},[e("legend",{key:genUUID()},this.props.label),this.Parse(this.props.json)]):e("fieldset",{name:`/${this.state.path}`,id:`fs${this.id}`},this.Parse(this.props.json))}}class MainAppState extends React.Component{constructor(e){super(e),this.state={statuses:{},devices:[],loading:this.props.loading,loaded:this.props.loaded,error:null,selectedDeviceId:0,deviceId:0,refreshFrequency:10},stateViewer=this,this.componentDidUpdate(null,null,null)}componentDidUpdate(e,t,s){this.state.loading||this.state.loaded||(this.state.loading=!0,this.updateStatuses([{url:"/status/"},{url:"/status/app"},{url:"/status/tasks",path:"tasks"}],{}))}updateStatuses(e,t){var s=new AbortController,a=setTimeout((()=>s.abort()),2e3);this.state.selectedDeviceId==(this.state.deviceId||0)?Promise.all(e.map((a=>new Promise(((i,n)=>{fetch(`${a.url}`,{method:"post",signal:s.signal}).then((e=>e.json())).then(fromVersionedToPlain).then((s=>{e=e.filter((e=>e!=a)),a.path?t[a.path]=Object.values(s):Object.assign(t,s),!this.state.deviceId&&s.deviceid&&this.setState({deviceId:s.deviceid,selectedDeviceId:s.deviceid}),i({path:a.path,stat:s})})).catch((e=>{a.retryCnt=1+(0|a.retryCnt),a.waitFor=2e3,a.error=e,n(e)}))}))))).then((e=>{clearTimeout(a),this.props.domContainer.style.opacity=1,this.state.statuses[this.state.deviceId]=this.orderResults(t),this.setState({error:null,loading:!1,loaded:!0,statuses:this.state.statuses})})).catch((s=>{if(clearTimeout(a),20!=s.code){var i=e.filter((e=>e.error));this.props.domContainer.style.opacity=.5,i[0].waitFor?setTimeout((()=>{s.message,this.updateStatuses(e,t)}),i[0].waitFor):this.updateStatuses(e,t)}})):this.state.selectedDeviceId&&fetch(`/lfs/status/${this.state.selectedDeviceId}.json`,{method:"get",signal:s.signal}).then((e=>e.json())).then(fromVersionedToPlain).then((e=>{this.state.statuses[this.state.selectedDeviceId]=this.orderResults(e),this.setState({statuses:this.state.statuses,loading:!1,loaded:!0})}))}orderResults(e){var t={};return Object.keys(e).filter((t=>"object"!=typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>"object"==typeof e[t]&&!Array.isArray(e[t]))).sort(((e,t)=>e.localeCompare(t))).forEach((s=>t[s]=e[s])),Object.keys(e).filter((t=>Array.isArray(e[t]))).forEach((s=>t[s]=e[s])),t}render(){return[e(ControlPanel,{key:genUUID(),deviceId:this.state.deviceId,devices:this.state.devices,selectedDeviceId:this.state.selectedDeviceId,onSetDevice:e=>this.setState({selectedDeviceId:e,loaded:!1}),onSetDeviceList:e=>this.state.devices=e,refreshFrequency:this.state.refreshFrequency,onChangeFreq:e=>this.setState({refreshFrequency:e}),periodicOn:e=>{this.state?.interval||this.setState({interval:setInterval((()=>this.setState({loaded:!1,loading:!1})),1e3*this.state.refreshFrequency)})},periodicOff:e=>{this.state?.interval&&this.setState({interval:clearTimeout(this.state?.interval)})},interval:this.state.interval}),e(AppState,{key:genUUID(),json:this.state.statuses[this.state.selectedDeviceId],deviceId:this.state.selectedDeviceId,devices:this.state.devices})]}}function genUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}function dirname(e){return(e.match(/.*\//)+"").replace(/(.+)\/$/g,"$1")}function isFloat(e){return Number(e)===e&&e%1!=0}function IsDatetimeValue(e){return e.match(".*ime_.s$")||e.match(".*ime_sec$")}function IsBooleanValue(e){return"true"==e||"yes"==e||!0===e||"false"==e||"no"==e||!1===e}function IsNumberValue(e){return!0!==e&&!1!==e&&"string"!=typeof e&&!isNaN(e)&&""!==e}class StorageViewer extends React.Component{constructor(e){super(e),this.state={loaded:!1,path:this.props.path,files:null},this.id=this.props.id||genUUID(),this.fetchFiles(),this.mainDiv=document.createElement("div")}getSystemFolders(){return[e("tr",{key:genUUID(),className:"folder"},[e("td",{key:genUUID()},this.getFileLink({name:"..",folder:dirname(this.state.path),ftype:"folder",size:0})),e("td",{key:genUUID()}),,e("td",{key:genUUID()})])]}getFileLink(t){return"folder"==t.ftype?e("a",{key:genUUID(),href:"#",onClick:()=>{this.setState({total:0,loaded:!1,path:`${t.folder||"/"}${".."==t.name?"":"/"+t.name}`.replaceAll("//","/")})}},t.name):e("a",{href:`${this.state.path}/${t.name}`},t.name)}GetFileStat(e){if(e.length){var t=e.pop(),s=setTimeout((()=>pageControler.abort()),3e3);fetch(`/stat${t.folder}/${t.name}`,{method:"post",signal:pageControler.signal}).then((a=>{clearTimeout(s),a.json().then((e=>{t.size=e.size,this.setState({files:this.state.files,total:this.state.total+e.size})})),e.length&&!pageControler.signal.aborted&&this.GetFileStat(e)})).catch((a=>{clearTimeout(s),pageControler.signal.aborted||e.push(t)}))}}fetchFiles(){var e=setTimeout((()=>pageControler.abort()),3e3);fetch("/files"+this.state.path,{method:"post",signal:pageControler.signal}).then((t=>{clearInterval(e),t.json().then((e=>e.sort(((e,t)=>e.ftype!=t.ftype?"folder"==e.ftype?1:-1:e.name==t.name?0:e.name>t.name?1:-1)))).then((e=>{this.setState({loaded:!0,files:e});for(var t=e.filter((e=>"file"==e.ftype&&0==e.size)),s=0;s<Math.min(3,t.length);s++)t.length&&this.GetFileStat(t)}))})).catch(console.error)}componentDidUpdate(e,t){this.state.loaded||(this.state.loaded=!0,this.fetchFiles())}componentDidMount(){document.getElementById(this.id).querySelectorAll("thd").forEach((e=>e.addEventListener("click",(()=>{const t=document.getElementsByClassName("file-table")[0].getElementsByTagName("tbody")[0];Array.from(t.querySelectorAll("tr:nth-child(n+2)")).sort(comparer(Array.from(e.parentNode.children).indexOf(e),this.asc=!this.asc)).forEach((e=>t.appendChild(e)))}))))}getFiles(){return this.state.files?this.getSystemFolders().concat(this.state.files.map((t=>e("tr",{key:genUUID(),className:t.ftype},[e("td",{key:genUUID()},this.getFileLink(t)),e("td",{key:genUUID()},"file"!=t.ftype?"":t.size),e("td",{key:genUUID()},"/"==this.state.path?null:e("a",{key:genUUID(),href:"#",onClick:()=>{fetch(`/stat${"/"===this.state.path?"":this.state.path}/${t.name}`,{method:"post",headers:{ftype:"file"==t.ftype?"file":"directory",operation:"delete"}}).then(this.setState({loaded:!1})).catch((e=>{}))}},"Del"))])))):e("tr",{key:genUUID()},[e("td",{key:genUUID()},"Loading..."),e("td",{key:genUUID()})])}getTableHeader(){return e("thead",{key:genUUID()},e("tr",{key:genUUID()},this.props.cols.map((t=>e("th",{key:genUUID()},t))).concat(e("th",{key:genUUID()},"Op"))))}render(){return[this.mainDiv=e("div",{key:genUUID(),id:this.id,className:"file-table"},e("table",{key:genUUID(),className:"greyGridTable"},[e("caption",{key:genUUID()},this.state.path),this.getTableHeader(),e("tbody",{key:genUUID()},this.getFiles()),e("tfoot",{key:genUUID()},e("tr",{key:genUUID()},[e("td",{key:genUUID()},"Total"),e("td",{key:genUUID()},this.state.total)]))]))]}}function renderFolder(t){t&&(activeTab=document.querySelector("#slide-4"),pageControler&&pageControler.abort(),pageControler=new AbortController);const s=activeTab=document.querySelector("#slide-1");null==fileManager?fileManager=ReactDOM.render(e(StorageViewer,{key:genUUID(),path:"/",cols:["Name","Size"]}),s):fileManager.setState({loaded:!1,total:0})}function degToRad(e){return e*(Math.PI/180)}function setupWs(e){if(e.checked){if(null==ws){(e=document.getElementById(e.id)).style.opacity=.5,ws=new WebSocket("ws://"+window.location.hostname+"/ws");var t=setTimeout((()=>{ws.close()}),3e3);ws.onmessage=s=>{clearTimeout(t),s&&s.data&&("{"==s.data[0]?(stateViewer.state.statuses[stateViewer.state.deviceId]=Object.assign(Object.assign({},stateViewer.state.statuses[stateViewer.state.deviceId]),fromVersionedToPlain(JSON.parse(s.data))),stateViewer.setState({statuses:stateViewer.state.statuses})):s.data.match(/.*\) ([^:]*)/g)&&systemManager&&systemManager.AddLogLine(s.data)),t=setTimeout((()=>{(e=document.getElementById(e.id)).style.opacity=.5,ws.close()}),3e3)},ws.onopen=()=>{clearTimeout(t),(e=document.getElementById(e.id)).style.opacity=1,e.connected=!0,ws.send("Connect"),t=setTimeout((()=>{ws.close()}),3e3)},ws.onerror=s=>{clearTimeout(t),e.style.opacity=.5,ws.close()},ws.onclose=s=>{clearTimeout(t),(e=document.getElementById(e.id)).style.opacity=1,e.checked=!1,ws=null}}}else null!=ws&&(ws.close(),ws=null,(e=document.getElementById(e.id)).checked=!1,e.style.opacity=1)}class LogLine extends React.Component{constructor(e){super(e);var t=this.props.logln.match(/^[^IDVEW]*(.+)/)[1];this.state={level:t.substr(0,1),date:t.substr(3,12),function:t.match(/.*\) ([^:]*)/g)[0].replaceAll(/^.*\) (.*)/g,"$1")},this.state.msg=this.props.logln.substr(this.props.logln.indexOf(this.state.function)+this.state.function.length+2).replaceAll(/^[\r\n]*/g,"").replaceAll(/.\[..\n$/g,"")}render(){return e("div",{key:genUUID(),className:`log LOG${this.state.level}`},[e("div",{key:genUUID(),className:"LOGLEVEL"},this.state.level),e("div",{key:genUUID(),className:"LOGDATE"},this.state.date),e("div",{key:genUUID(),className:"LOGFUNCTION"},this.state.function),e("div",{key:genUUID(),className:"LOGLINE"},this.state.msg)])}}class FirmwarUpdater extends React.Component{UploadFirmware(e){if(e.preventDefault(),this.setState({loaded:`Sending ${this.state.len} firmware bytes`}),this.state.fwdata&&this.state.md5)return fetch(`/ota/flash?md5=${this.state.md5}&len=${this.state.len}`,{method:"post",body:this.state.fwdata}).then((e=>e.text())).then((e=>this.setState({loaded:e})))}waitForDevFlashing(){var e=new AbortController,t=setTimeout((()=>{e.abort()}),1e3);fetch("/status/app",{method:"post",signal:e.signal}).then((e=>(clearTimeout(t),e.json()))).then((e=>this.setState({waiter:null,loaded:`Loaded version ${e.build.ver} built on ${e.build.date}`}))).catch((e=>{clearTimeout(t),this.setState({waiter:setTimeout((()=>this.waitForDevFlashing()),500)})}))}componentDidUpdate(e,t,s){if("Flashing"==this.state.loaded&&null==this.state.waiter&&this.waitForDevFlashing(),this.state.firmware&&!this.state.md5){this.state.md5="loading";var a=new FileReader;a.onload=()=>{var e=a.resultString||a.result,t=CryptoJS.algo.MD5.create();t.update(CryptoJS.enc.Latin1.parse(a.result)),this.state.fwdata=new Uint8Array(this.state.firmware.size);for(var s=0;s<e.length;s++)this.state.fwdata[s]=e.charCodeAt(s);this.setState({md5:t.finalize().toString(CryptoJS.enc.Hex),fwdata:this.state.fwdata,len:this.state.firmware.size})},a.onprogress=e=>this.setState({loaded:1*this.state.firmware.size/(1*e.loaded)*100+"% loaded"}),a.onerror=e=>this.setState({md5:null,firmware:null,error:e.textContent}),a.onabort=e=>this.setState({md5:null,firmware:null,error:"Aborted"}),a.readAsBinaryString(this.state.firmware)}}componentDidMount(){var e=new URLSearchParams(window.location.search);e&&e.has("loaded")&&this.setState({loaded:e.get("loaded",e.get("loaded"))})}render(){return e("form",{key:genUUID(),onSubmit:this.UploadFirmware.bind(this)},e("fieldset",{key:genUUID()},[e("input",{key:genUUID(),type:"file",name:"firmware",onChange:e=>this.setState({firmware:e.target.files[0]})}),e("button",{key:genUUID()},"Upload"),e("div",{key:genUUID()},this.state?.loaded)]))}}class SystemPage extends React.Component{constructor(e){super(e),this.state={logLines:[]}}AddLogLine(t){this.state.logLines.push(e(LogLine,{key:genUUID(),logln:t})),this.loaded&&this.setState({logLines:this.state.logLines})}componentDidMount(){this.loaded=!0}render(){return[e("div",{key:genUUID()},[e("button",{key:genUUID(),onClick:e=>systemManager.setState({logLines:[]})},"Clear Logs"),e("button",{key:genUUID(),onClick:e=>SendCommand({command:"reboot"})},"Reboot"),e("button",{key:genUUID(),onClick:e=>SendCommand({command:"parseFiles"})},"Parse Files"),e("button",{key:genUUID(),onClick:e=>SendCommand({command:"factoryReset"})},"Factory Reset")]),e(FirmwarUpdater,{key:genUUID()}),e("div",{key:genUUID(),className:"loglines"},this.state.logLines)]}}function refreshSystem(t){const s=activeTab=document.querySelector("#slide-4");t&&(activeTab=s,pageControler&&pageControler.abort(),pageControler=new AbortController),null==systemManager?systemManager=ReactDOM.render(e(SystemPage,{key:genUUID()}),s):systemManager.setState({loaded:!1})}function SendCommand(e){return fetch("/status/cmd",{method:"put",body:JSON.stringify(e)}).then((e=>e.text().then(console.log))).catch(console.error).catch(console.error)}function PeriodicRefreshClicked(e){e.checked?activeInterval=setInterval((()=>{refreshStatus(!1)}),1e3*parseInt(document.getElementById("refreshFreq").value)):null!==activeInterval&&(clearInterval(activeInterval),activeInterval=null)}function refreshStatus(t){const s=activeTab=document.querySelector("#slide-2");t&&(activeTab=s,pageControler&&pageControler.abort(),pageControler=new AbortController),null==stateManager?stateManager=ReactDOM.render(e(MainAppState,{key:genUUID(),domContainer:s}),s):stateManager.setState({loaded:!1,loading:!1,error:null})}function fromVersionedToPlain(e,t=""){var s,a={},i=Object.keys(e);for(s in i){var n=i[s],r=!1;"object"==typeof e[n]&&2==Object.keys(e[n]).filter((e=>!(r|=!("version"==e||"value"==e)))).length?a[n]=e[n].value:Array.isArray(e[n])?(a[n]=[],e[n].forEach(((s,i)=>{e[n][i].boper?a[n][a[n].length-1].boper=e[n][i].boper:a[n].push(fromVersionedToPlain(s,`${t}/${n}[${i}]`))}))):"object"==typeof e[n]?a[n]=fromVersionedToPlain(e[n],`${t}/${n}`):a[n]=e[n]}return a}function fromPlainToVersionned(e,t,s=""){var a={},i=Object.keys(e);for(var n in i){var r=i[n],o=t?t[r]:void 0;if(Array.isArray(e[r])){a[r]=[];for(var l=0;l<e[r].length;l++){var d=fromPlainToVersionned(e[r][l],o?o[l]:null,`${s}/${r}[${l}]`);a[r].push(d),d.boper&&(a[r].push({boper:d.boper}),delete d.boper)}}else"object"==typeof e[r]?a[r]=fromPlainToVersionned(e[r],o,`${s}/${r}`):a[r]="boper"===r||"operator"===r||"otype"===r||"value"===r||"name"===r?e[r]:{version:void 0===o?0:e[r]===o.value?o.version:o.version+1,value:e[r]}}return a}function getJsonConfig(){return new Promise(((e,t)=>{pageControler=new AbortController;const s=setTimeout((()=>pageControler.abort()),3e3);fetch("/config",{method:"post",signal:pageControler.signal}).then((t=>{clearTimeout(s),e(t.json())})).catch((e=>{clearTimeout(s),t(e)}))}))}class ConfigEditor extends React.Component{constructor(e){super(e),this.state={loaded:!1,deviceId:this.props.deviceId,deviceConfig:this.props.deviceConfig},this.id=this.props.id||genUUID()}componentDidMount(){this.state.deviceConfig?(this.jsonEditor=new JSONEditor(this.container,{onChangeJSON:e=>Object.assign(this.state.deviceConfig,e)}),this.jsonEditor.set(this.state.deviceConfig||{})):this.container.innerText="Loading..."}componentDidUpdate(e,t,s){this.jsonEditor&&this.jsonEditor.set(this.state.deviceConfig)}render(){return e("div",{key:genUUID(),ref:e=>this.container=e,id:`${this.id}`,className:"column col-md-12","data-theme":"spectre"})}}class ConfigPage extends React.Component{constructor(e){super(e),this.state={loaded:!1,deviceConfigs:{}},this.id=this.props.id||genUUID(),this.componentDidUpdate(null,null,null)}componentDidUpdate(e,t,s){this.state.loaded||this.state.loading||this.state.error||(this.state.loading=!0,getJsonConfig().then(fromVersionedToPlain).then((e=>{this.state.currentDeviceId||(this.state.deviceConfigs[e.deviceid]=e,this.setState({deviceConfigs:this.state.deviceConfigs,loaded:!0,loading:!1,currentDeviceId:e.deviceid,deviceId:e.deviceid,error:null})),fetch("/files/lfs/config",{method:"post"}).then((e=>{e.json().then((e=>e.filter((e=>"file"==e.ftype&&"current.json"!=e.name)).forEach((e=>{fetch(`/lfs/config/${e.name}`,{method:"get"}).then((e=>e.json())).then(fromVersionedToPlain).then((t=>{this.state.deviceConfigs[e.name.substr(0,e.name.indexOf("."))]=t,this.setState({deviceConfigs:this.state.deviceConfigs})})).catch((e=>{this.setState({error:e,loaded:!1,loading:!1})}))}))))})).catch((e=>{this.setState({error:e,loaded:!1,loading:!1})}))})).catch((e=>{this.setState({error:e,loaded:!1,loading:!1})})))}SaveForm(e){getJsonConfig().then((e=>fromPlainToVersionned(this.state.deviceConfigs[this.state.deviceId],e))).then((t=>fetch(e.target.action.replace("file://","")+"/"+this.state.deviceId,{method:"put",body:JSON.stringify(t)}).then(console.log))),e.preventDefault()}render(){return e("form",{onSubmit:e=>this.SaveForm(e),key:`f${this.id}`,action:"/config",method:"post"},[e("fieldset",{key:genUUID()},[e("select",{key:genUUID(),name:"deviceid",value:this.state.deviceId,onChange:e=>(this.setState({deviceId:parseInt(e.target.value)}),!0)},Object.keys(this.state.deviceConfigs).map((t=>e("option",{key:genUUID(),value:t},t)))),e(ConfigEditor,{key:genUUID(),deviceId:this.state.deviceId,deviceConfig:this.state.deviceConfigs[this.state.deviceId]})]),e("button",{key:genUUID()},"Save")])}}function refreshConfig(t){const s=activeTab=document.querySelector("#slide-3");t&&(activeTab=s,pageControler&&pageControler.abort(),pageControler=new AbortController),null==configManager?configManager=ReactDOM.render(e(ConfigPage,{key:genUUID()}),s):configManager.setState({loaded:!1,error:null})}const getCellValue=(e,t)=>e.children[t].innerText||e.children[t].textContent,comparer=(e,t)=>(s,a)=>{return i=getCellValue(t?s:a,e),n=getCellValue(t?a:s,e),""===i||""===n||isNaN(i)||isNaN(n)?i.toString().localeCompare(n):i-n;var i,n};var hexcase=0,b64pad="";function hex_sha1(e){return rstr2hex(rstr_sha1(str2rstr_utf8(e)))}function hex_hmac_sha1(e,t){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(e){return binb2rstr(binb_sha1(rstr2binb(e),8*e.length))}function rstr_hmac_sha1(e,t){var s=rstr2binb(e);s.length>16&&(s=binb_sha1(s,8*e.length));for(var a=Array(16),i=Array(16),n=0;n<16;n++)a[n]=909522486^s[n],i[n]=1549556828^s[n];var r=binb_sha1(a.concat(rstr2binb(t)),512+8*t.length);return binb2rstr(binb_sha1(i.concat(r),672))}function rstr2hex(e){try{}catch(e){hexcase=0}for(var t,s=hexcase?"0123456789ABCDEF":"0123456789abcdef",a="",i=0;i<e.length;i++)t=e.charCodeAt(i),a+=s.charAt(t>>>4&15)+s.charAt(15&t);return a}function str2rstr_utf8(e){for(var t,s,a="",i=-1;++i<e.length;)t=e.charCodeAt(i),s=i+1<e.length?e.charCodeAt(i+1):0,55296<=t&&t<=56319&&56320<=s&&s<=57343&&(t=65536+((1023&t)<<10)+(1023&s),i++),t<=127?a+=String.fromCharCode(t):t<=2047?a+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?a+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(a+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return a}function rstr2binb(e){for(var t=Array(e.length>>2),s=0;s<t.length;s++)t[s]=0;for(s=0;s<8*e.length;s+=8)t[s>>5]|=(255&e.charCodeAt(s/8))<<24-s%32;return t}function binb2rstr(e){for(var t="",s=0;s<32*e.length;s+=8)t+=String.fromCharCode(e[s>>5]>>>24-s%32&255);return t}function binb_sha1(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var s=Array(80),a=1732584193,i=-271733879,n=-1732584194,r=271733878,o=-1009589776,l=0;l<e.length;l+=16){for(var d=a,h=i,c=n,p=r,g=o,u=0;u<80;u++){s[u]=u<16?e[l+u]:bit_rol(s[u-3]^s[u-8]^s[u-14]^s[u-16],1);var f=safe_add(safe_add(bit_rol(a,5),sha1_ft(u,i,n,r)),safe_add(safe_add(o,s[u]),sha1_kt(u)));o=r,r=n,n=bit_rol(i,30),i=a,a=f}a=safe_add(a,d),i=safe_add(i,h),n=safe_add(n,c),r=safe_add(r,p),o=safe_add(o,g)}return Array(a,i,n,r,o)}function sha1_ft(e,t,s,a){return e<20?t&s|~t&a:e<40?t^s^a:e<60?t&s|t&a|s&a:t^s^a}function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function safe_add(e,t){var s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function bit_rol(e,t){return e<<t|e>>>32-t}renderFolder(!0),refreshStatus(!1),refreshConfig(!1),refreshSystem(!1);